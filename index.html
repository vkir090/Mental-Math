<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>Quant Prep Trainer v3</title>
<style>
:root{--bg:#0f1220;--panel:#151936;--accent:#7bd88f;--accent2:#8bd3ff;--text:#eef1ff;--muted:#a8b0d3;--danger:#ff6b6b;--warn:#ffd166}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);
     background:radial-gradient(1000px 600px at 10% -10%, #1a1f45 0%, #0f1220 60%)}
header{position:sticky;top:0;z-index:5;backdrop-filter:blur(8px);background:rgb(15 18 32 / 72%);
       border-bottom:1px solid #232955;padding:12px 16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
header h1{margin:0;font-size:18px;letter-spacing:.3px}
nav{display:flex;gap:8px;flex-wrap:wrap}
nav button{background:var(--panel);color:var(--text);border:1px solid #232955;padding:8px 12px;border-radius:10px;cursor:pointer}
nav button.active{border-color:var(--accent);box-shadow:0 0 0 2px rgb(123 216 143 / .25) inset}
main{padding:16px;max-width:1200px;margin:0 auto}
.card{background:linear-gradient(180deg,#161a3a 0%,#10142c 100%);border:1px solid #232955;border-radius:14px;padding:16px;margin:10px 0;box-shadow:0 8px 24px rgb(0 0 0 / .25)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
.grid{display:grid;gap:12px}.grid.cols-2{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input,select{width:100%;background:#0c1030;color:var(--text);border:1px solid #232955;padding:10px 12px;border-radius:10px;outline:none}
.btn{background:var(--accent);color:#0a1320;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
.btn.secondary{background:var(--accent2)}.btn.ghost{background:transparent;color:var(--text);border:1px solid #2a316a}.btn.danger{background:var(--danger);color:white}
.muted{color:var(--muted)} .center{text-align:center}
.pill{padding:6px 10px;border:1px solid #2a316a;border-radius:999px;color:var(--muted)}
.timer{font-variant-numeric:tabular-nums}
.question{font-size:26px;margin:8px 0 12px}
table{width:100%;border-collapse:collapse;font-variant-numeric:tabular-nums}
th,td{padding:8px 10px;border-bottom:1px solid #232955}
tr:hover td{background:#101536}
.ok{color:var(--accent)}.bad{color:var(--danger)}.warn{color:var(--warn)}
kbd{background:#0c1030;border:1px solid #232955;border-radius:6px;padding:2px 6px}
.link{color:var(--accent2);cursor:pointer;text-decoration:underline}
.small{font-size:12px}
.iconbtn{padding:8px 10px;border-radius:8px;border:1px solid #2a316a;background:#0c1030;color:#fff;cursor:pointer}
.inputRow{display:flex;gap:8px;align-items:flex-end}
.inputRow input{flex:1}
</style>
</head>
<body>
<header>
  <h1>🧮 Quant Prep Trainer v3</h1>
  <nav id="tabs"></nav>
  <div style="margin-left:auto"></div>
  <button class="btn ghost" id="exportJson">Export JSON</button>
  <button class="btn ghost" id="exportCsv">Export CSV</button>
  <button class="btn ghost" id="reset">Reset</button>
</header>
<main id="app"></main>

<script>
/* ===== Core Utils ===== */
const $=(s,e=document)=>e.querySelector(s);
const $$=(s,e=document)=>[...e.querySelectorAll(s)];
const now=()=>performance.now();
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const fmtMs=ms=>(ms/1000).toFixed(2)+"s";
function download(name, data, type){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([data],{type}));a.download=name;a.click();URL.revokeObjectURL(a.href);}
function esc(s){return String(s).replace(/[<>&]/g,c=>({"<":"&lt;",">":"&gt;","&":"&amp;"}[c]))}

/* ===== Database & Dedup ===== */
const DBKEY="qprep_v3"; const DEDUPKEY="qprep_dedup_v1";
let DB = load(DBKEY, {sessions:[], highscores:{}});
let DEDUP = load(DEDUPKEY, {});
function load(key, def){try{ return JSON.parse(localStorage.getItem(key)) || structuredClone(def);}catch(e){ return structuredClone(def);}}
function saveDB(){ localStorage.setItem(DBKEY, JSON.stringify(DB)); }
function saveDedup(){ localStorage.setItem(DEDUPKEY, JSON.stringify(DEDUP)); }
function pushSession(entry){
  DB.sessions.push({...entry, date:new Date().toISOString()});
  const k = entry.module;
  const score = entry.stats?.score ?? entry.stats?.correct ?? 0;
  if(!(k in DB.highscores) || score>DB.highscores[k].score){
    DB.highscores[k] = {score, when:new Date().toISOString(), detail:entry.stats};
  }
  saveDB();
}
function dedupInit(mod){ if(!DEDUP[mod]) DEDUP[mod] = {list:[], set:{}}; }
function dedupHas(mod, sig){ dedupInit(mod); return !!DEDUP[mod].set[sig]; }
function dedupAdd(mod, sig, cap=50000){
  dedupInit(mod);
  if(!DEDUP[mod].set[sig]){
    DEDUP[mod].set[sig]=1; DEDUP[mod].list.push(sig);
    if(DEDUP[mod].list.length>cap){ const old=DEDUP[mod].list.shift(); delete DEDUP[mod].set[old]; }
    saveDedup();
  }
}
function dedupFindNew(mod, genFn, sigFn, maxTries=200){
  for(let t=0;t<maxTries;t++){
    const item = genFn(); const sig = sigFn(item);
    if(!dedupHas(mod, sig)){ dedupAdd(mod, sig); return item; }
  }
  return genFn();
}

/* ===== PRESETS & TARGETS (define BEFORE views) ===== */
const PRESETS_MENTAL={
  blue:{label:"Blue – Akuna (80/8)", n:80, seconds:480, scoring:{correct:+1, wrong:-1, skip:0}, target:60},
  brown:{label:"Brown – Maven (40/6)", n:40, seconds:360, scoring:{correct:+1, wrong:0,  skip:0}, target:34},
  red:{label:"Red – Flow (75/8)",     n:75, seconds:480, scoring:{correct:+1, wrong:-1, skip:0}, target:53}
};
const PRESETS_SEQ={
  tradeseq:{name:"TradeSeq", n:30, seconds:1080, scoring:{correct:1,wrong:0,skip:0}, target:22,
    weights:{AP:.30, GP:.12, FIBO:.10, GROWING_DIFF:.12, ALTERNATING:.10, INTERLEAVED:.10, QUADRATIC:.08, POW_OFFSET:.05, PRIME:.03},
    ranges:{start_min:0, start_max:1000, step_min:-50, step_max:50, factor_min:-5, factor_max:5, max_abs_value:10000},
    allow_negatives:true, allow_fractions:false, difficulty_curve:["easy","easy","easy","mid","mid","mid","hard","hard","hard"]
  },
  blueseq:{name:"BlueSeq", n:24, seconds:960, scoring:{correct:1,wrong:0,skip:0}, target:18,
    weights:{AP:.30, GP:.12, FIBO:.12, GROWING_DIFF:.12, ALTERNATING:.10, INTERLEAVED:.10, QUADRATIC:.08, POW_OFFSET:.04, PRIME:.02},
    ranges:{start_min:0, start_max:800, step_min:-40, step_max:40, factor_min:-4, factor_max:4, max_abs_value:8000},
    allow_negatives:true, allow_fractions:false, difficulty_curve:["easy","easy","mid","mid","hard","hard"]
  },
  brownseq:{name:"BrownSeq", n:26, seconds:900, scoring:{correct:1,wrong:0,skip:0}, target:22,
    weights:{AP:.32, GP:.10, FIBO:.10, GROWING_DIFF:.12, ALTERNATING:.12, INTERLEAVED:.10, QUADRATIC:.08, POW_OFFSET:.04, PRIME:.02},
    ranges:{start_min:0, start_max:900, step_min:-45, step_max:45, factor_min:-4, factor_max:5, max_abs_value:9000},
    allow_negatives:true, allow_fractions:false, difficulty_curve:["easy","mid","hard"]
  }
};
const TARGET_TASK = {net:25, acc:90};
const TARGET_PIN  = {total:24};
const TARGET_MMG  = {pnlRate:0.02};
const TARGET_BRAIN= {acc:80, medSec:120};
const TARGET_FERMI= {withinFactor:10, rate:80, mm_hit:70};

/* ===== App Shell ===== */
const modules=[
  {id:"mental", title:"Mental Math", view:viewMental},
  {id:"seq", title:"Sequences", view:viewSequences},
  {id:"task", title:"Task Switch", view:viewTaskSwitch},
  {id:"pin", title:"Pincode (3×1min)", view:viewPincode},
  {id:"mmg", title:"Market Making", view:viewMM},
  {id:"brain", title:"Brainteasers & Fermi", view:viewBrainFermi},
  {id:"stats", title:"Statistik", view:viewStats},
  {id:"settings", title:"Einstellungen", view:viewSettings}
];
let currentTab = localStorage.getItem("qprep_tab") || "seq";
function renderTabs(){
  const nav=$("#tabs"); nav.innerHTML="";
  modules.forEach(m=>{
    const b=document.createElement("button"); b.textContent=m.title;
    b.className = currentTab===m.id? "active":""; b.onclick = ()=>{ currentTab=m.id; localStorage.setItem("qprep_tab", currentTab); render(); };
    nav.appendChild(b);
  });
}
function render(){ renderTabs(); $("#app").innerHTML=""; (modules.find(x=>x.id===currentTab)||modules[0]).view($("#app")); }
render();

/* Header buttons */
$("#exportJson").onclick=()=>download(`qprep_stats_${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(DB,null,2), "application/json");
$("#exportCsv").onclick=()=>{
  const rows=[["module","date","score","correct","total","avgMs","detail_json","settings_json"]];
  for(const s of DB.sessions){
    rows.push([s.module, s.date, s.stats?.score??"", s.stats?.correct??"", s.stats?.total??"", s.stats?.avgMs??"", JSON.stringify(s.perQuestion||[]), JSON.stringify(s.settings||{})]);
  }
  const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
  download(`qprep_stats_${new Date().toISOString().slice(0,10)}.csv`, csv, "text/csv");
};
$("#reset").onclick=()=>{ if(confirm("Wirklich alle lokalen Daten (Scores, Sessions, Dedup) löschen?")){ localStorage.removeItem(DBKEY); localStorage.removeItem(DEDUPKEY); DB=load(DBKEY,{sessions:[],highscores:{}}); DEDUP={}; render(); } };

/* ===== UI helpers ===== */
function card(html=""){ const d=document.createElement('div'); d.className="card"; d.innerHTML=html; return d; }
function formRow(items){ const r=document.createElement('div'); r.className="row grid cols-2"; items.forEach(x=>r.appendChild(x)); return r; }
function btn(label, onClick, cls="btn"){ const b=document.createElement('button'); b.className=cls; b.textContent=label; b.onclick=onClick; return b; }
function numberField(label, min, max, step, value, onInput, allowFloat=false){
  const w=document.createElement('div'); const id="n"+Math.random().toString(36).slice(2);
  w.innerHTML=`<label for="${id}">${label}</label><input id="${id}" ${allowFloat?"":"inputmode='numeric'"} type="number" min="${min}" max="${max}" step="${step}" value="${value}">`;
  const el=$("input",w); el.addEventListener('input', e=>onInput(allowFloat?parseFloat(e.target.value):parseInt(e.target.value))); return w;
}
function selectField(label, options, onChange, value){
  const w=document.createElement('div'); const id="s"+Math.random().toString(36).slice(2);
  w.innerHTML=`<label for="${id}">${label}</label><select id="${id}">${options.map(([v,l])=>`<option value="${v}">${l}</option>`).join("")}</select>`;
  const sel = $("select",w); sel.value=value; sel.addEventListener('change', e=>onChange(e.target.value)); return w;
}
function checkboxField(label, checked, onChange){
  const w=document.createElement('div'); const id="c"+Math.random().toString(36).slice(2);
  w.innerHTML=`<label><input id="${id}" type="checkbox" ${checked?"checked":""}> ${label}</label>`;
  $("#"+id, w).addEventListener('change', e=>onChange(e.target.checked)); return w;
}
function table(rows, headers){
  return `<table><thead><tr>${headers.map(h=>`<th>${h}</th>`).join("")}</tr></thead>
  <tbody>${rows.map(r=>`<tr>${r.map(c=>`<td>${esc(c??"")}</td>`).join("")}</tr>`).join("")}</tbody></table>`;
}
function title(id){ return {mental:"Mental Math", seq:"Sequences", task:"Task Switch", pin:"Pincode", mmg:"Market Making", brain:"Brainteasers & Fermi", stats:"Statistik"}[id] || id; }
function highCard(moduleId){ const best=DB.highscores[moduleId]; const el=card(`<h3>🏆 Highscore</h3>`); el.insertAdjacentHTML("beforeend", best? `<div class="pill">Score: <b>${best.score}</b> · ${new Date(best.when).toLocaleString()}</div>` : `<div class="muted">Noch kein Highscore.</div>`); return el; }

function minusButtonFor(input){
  // Adds a mini "−" icon button to toggle sign for iOS numeric keypad
  const wrap=document.createElement("div"); wrap.className="inputRow";
  const btn=document.createElement("button"); btn.className="iconbtn"; btn.type="button"; btn.textContent="−";
  input.parentNode.insertBefore(wrap, input); wrap.appendChild(input); wrap.appendChild(btn);
  btn.onclick=()=>{
    const v=input.value.trim();
    if(!v){ input.value="-"; input.focus(); return; }
    if(v.startsWith("-")) input.value=v.slice(1);
    else input.value = "-"+v;
    input.focus();
  };
  return wrap;
}

/* ===== MENTAL MATH ===== */
function viewMental(root){
  root.appendChild(card(`<h2>🧮 Mental Math</h2>
  <div class="muted">Presets nach Firmenformat. <b>Auto-Advance</b> bei richtiger Antwort, <b>Pause/Resume</b>, <b>Abbrechen</b> ohne Speichern. Kein Malus bei Skip in +1/0 Modi.</div>`));
  const cfg={preset:"blue", ...PRESETS_MENTAL.blue, auto:true};
  const panel=card(); panel.appendChild(formRow([
    selectField("Preset", Object.entries(PRESETS_MENTAL).map(([k,p])=>[k,p.label]), v=>{ Object.assign(cfg, {preset:v, ...PRESETS_MENTAL[v]}); } , cfg.preset),
    numberField("Fragen",5,200,1,cfg.n,v=>cfg.n=v),
    numberField("Zeit (s)",60,1800,10,cfg.seconds,v=>cfg.seconds=v),
    selectField("Bewertung", [["+1/-1","+1 richtig, -1 falsch"],["+1/0","+1 richtig, 0 falsch"]], val=>{ cfg.scoring = (val==="+1/-1")?{correct:+1,wrong:-1,skip:0}:{correct:+1,wrong:0,skip:0}; }, "+1/-1"),
    numberField("Zielwert (Ready=100%)",1,200,1,cfg.target,v=>cfg.target=v),
    checkboxField("Auto-Advance", cfg.auto, v=>cfg.auto=v),
    btn("Start", ()=>run())
  ])); root.appendChild(panel); root.appendChild(highCard("mental"));

  function genQ(){
    const r=(a,b)=>Math.floor(Math.random()*(b-a+1))+a; const pick=a=>a[Math.floor(Math.random()*a.length)];
    const types=["nestedDiv","mulAdd","addMul","quick","mul"]; const t=pick(types);
    let a,b,c,ans,txt;
    if(t==="nestedDiv"){ c=r(2,15); b=r(2,300); const inner=Math.max(1,Math.floor(b/c)); const k=r(2,80); a=inner*k; ans=a/inner; txt=`${a} / (${b} / ${c})`; }
    else if(t==="mulAdd"){ a=r(10,900); b=r(2,99); c=r(3,300); ans=a*b+c; txt=`${a} × ${b} + ${c}`; }
    else if(t==="addMul"){ a=r(10,900); b=r(2,99); c=r(3,300); ans=a+b*c; txt=`${a} + ${b} × ${c}`; }
    else if(t==="quick"){ a=r(200,2000); b=r(50,600); const op=Math.random()<.5?"+":"-"; ans = op==="+" ? a+b : a-b; txt=`${a} ${op} ${b}`; }
    else { a=r(12,99); b=r(12,99); ans=a*b; txt=`${a} × ${b}`; }
    return {t,a,b,c,ans,txt};
  }
  function sigOf(q){ return `${q.t}|${q.a}|${q.b}|${q.c||0}`; }

  function run(){
    const totalMs=cfg.seconds*1000;
    const ui=card(); root.appendChild(ui);
    ui.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center">
        <span class="pill">Preset: ${PRESETS_MENTAL[cfg.preset]?.label || "custom"}</span>
        <span class="pill">Zeit: <span id="t" class="timer"></span></span>
        <span class="pill">Frage: <b id="qc">1</b> / ${cfg.n}</span>
      </div>
      <div class="question" id="q"></div>
      <div class="row">
        <div style="flex:1"><label>Antwort</label><input id="a" inputmode="decimal" placeholder="Zahl"></div>
        <button class="btn" id="ok">OK</button>
        <button class="btn ghost" id="skip">Skip</button>
        <button class="btn ghost" id="pause">Pause</button>
        <button class="btn danger" id="abort">Abbrechen</button>
      </div>
      <div class="muted" id="info"></div>`;

    const el={t:$("#t",ui),qc:$("#qc",ui),q:$("#q",ui),a:$("#a",ui),ok:$("#ok",ui),skip:$("#skip",ui),pause:$("#pause",ui),abort:$("#abort",ui),info:$("#info",ui)};
    minusButtonFor(el.a);
    let i=0, correct=0, score=0, per=[], cur=null;
    let paused=false, pauseT=0, tStart=performance.now(), tPause=0, running=true, qStart=now();

    function tick(){ let tNow=performance.now(); if(paused) tNow=tPause;
      const used=tNow-tStart-pauseT; const left=Math.max(0,totalMs-used);
      el.t.textContent=(left/1000).toFixed(1)+"s"; if(left<=0&&running){finish();return;} if(running) requestAnimationFrame(tick);
    }
    function next(){
      if(i>=cfg.n){ finish(); return; }
      cur = dedupFindNew("mental", genQ, sigOf);
      el.q.textContent = cur.txt+" = ?"; el.a.value=""; el.a.focus(); el.qc.textContent = String(i+1);
      el.info.textContent = `Bewertung: +${cfg.scoring.correct} / ${cfg.scoring.wrong>=0?"+":""}${cfg.scoring.wrong}`;
      qStart=now();
    }
    function submit(kind){
      const ms=Math.round(now()-qStart);
      const raw=el.a.value.trim(); const user=(kind==="skip"||raw==="")?null:Number(raw.replace(",", "."));
      const ok = (user!==null && Math.abs(user-cur.ans)<1e-9); if(ok) correct++;
      const delta = ok? cfg.scoring.correct : (user===null? cfg.scoring.skip : cfg.scoring.wrong); score += delta;
      per.push({q:cur.txt, user, ans:cur.ans, correct:ok, ms, skipped:user===null});
      i++; next();
    }
    function pause(){ if(!paused){paused=true; tPause=performance.now(); el.pause.textContent="Resume";} else {paused=false; pauseT += performance.now()-tPause; el.pause.textContent="Pause"; requestAnimationFrame(tick);} }
    function abort(){ if(confirm("Ohne Speichern beenden?")){ running=false; ui.innerHTML=`<div class="card">Abgebrochen – nicht gespeichert.</div>`; } }
    function finish(){
      running=false; const avg = per.length? Math.round(per.reduce((a,x)=>a+x.ms,0)/per.length):0;
      const stats={correct,total:cfg.n,avgMs:avg,score};
      const target = cfg.target || cfg.n; const readiness = clamp(Math.round((Math.max(score,correct)/target)*100),0,200);
      pushSession({module:"mental",preset:cfg.preset,stats,perQuestion:per,settings:{...cfg}});
      const rows=[["#","question","your","correct","ms","note"]]; per.forEach((x,j)=>rows.push([j+1,x.q,x.skipped?"—":x.user,x.ans,(x.ms/1000).toFixed(2)+"s",x.skipped?"skip":(x.correct?"OK":"X")]));
      const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
      const txt = per.map((x,j)=>`${j+1}. ${x.q} | your=${x.skipped?"":x.user} | correct=${x.ans} | ${x.correct?"OK":"X"} | ${x.ms}ms${x.skipped?" | skip":""}`).join("\n");
      ui.innerHTML = `<h3>Ergebnis</h3>
        <div class="row">
          <span class="pill">Richtig: <b class="ok">${stats.correct}</b> / ${stats.total}</span>
          <span class="pill">Score: <b>${stats.score}</b></span>
          <span class="pill">Ø Zeit: <b>${fmtMs(stats.avgMs)}</b></span>
          <span class="pill">Ziel: <b>${target}</b></span>
          <span class="pill">Ready: <b>${readiness}%</b></span>
        </div>
        <div class="row"><button class="btn" id="dlCsv">Download CSV</button><button class="btn ghost" id="dlTxt">Download TXT</button></div>
        ${table(per.map((x,idx)=>[idx+1,x.q,x.skipped?"—":x.user,x.ans,(x.ms/1000).toFixed(2)+"s",x.correct?"✅":"❌"]),["#","Frage","Deine","Korrekt","Zeit","OK"])} `;
      $("#dlCsv",ui).onclick=()=>download(`mental_${new Date().toISOString().replace(/[:.]/g,'-')}.csv`, csv, "text/csv");
      $("#dlTxt",ui).onclick=()=>download(`mental_${new Date().toISOString().replace(/[:.]/g,'-')}.txt`, txt, "text/plain");
      render();
    }

    el.ok.onclick=()=>submit("ok"); el.skip.onclick=()=>submit("skip"); el.pause.onclick=pause; el.abort.onclick=abort;
    el.a.addEventListener("keydown", e=>{ if(e.key==="Enter") submit("ok"); });
    el.a.addEventListener("input", ()=>{ if(!cfg.auto) return; const raw=el.a.value.trim(); if(!raw) return; const v=Number(raw.replace(",", ".")); if(Math.abs(v - (cur?.ans??NaN))<1e-9) submit("ok"); });
    requestAnimationFrame(tick); next();
  }
}

/* ===== SEQUENCES ===== */
function viewSequences(root){
  root.appendChild(card(`<h2>🔗 Sequences</h2><div class="muted">Flow/Akuna/Maven Presets. 5 Terme → nächster Term. Integer-only standardmäßig. Keine Negativpunkte; Skips ohne Malus. Timer mit Ampel.</div>`));
  const cfg={preset:"tradeseq", ...PRESETS_SEQ.tradeseq, auto:true};
  const panel=card(); panel.appendChild(formRow([
    selectField("Preset", [["tradeseq","TradeSeq (Flow)"],["blueseq","BlueSeq (Akuna)"],["brownseq","BrownSeq (Maven)"]], v=>{ Object.assign(cfg,{preset:v, ...PRESETS_SEQ[v]}); }, cfg.preset),
    numberField("Fragen",3,80,1,cfg.n,v=>cfg.n=v),
    numberField("Zeit (s)",60,3600,10,cfg.seconds,v=>cfg.seconds=v),
    numberField("Ziel (Ready=100%)",1,80,1,cfg.target,v=>cfg.target=v),
    checkboxField("Auto-Advance", cfg.auto, v=>cfg.auto=v),
    btn("Start", ()=>run())
  ])); root.appendChild(panel); root.appendChild(highCard("seq"));

  function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  function pickWeighted(weights){
    const entries=Object.entries(weights); const total=entries.reduce((s,[,w])=>s+w,0);
    let r=Math.random()*total; for(const [k,w] of entries){ if((r-=w)<=0) return k; } return entries[0][0];
  }
  function clampVal(x,maxAbs){ if(x>maxAbs) return maxAbs; if(x<-maxAbs) return -maxAbs; return x; }

  function generateItem(idx){
    const preset=PRESETS_SEQ[cfg.preset];
    // difficulty bucket
    const tiers=preset.difficulty_curve;
    const pos=idx/preset.n;
    let tier="easy";
    if(pos>=2/3) tier="hard"; else if(pos>=1/3) tier="mid";
    // choose pattern
    const pat=pickWeighted(preset.weights);
    const R=preset.ranges, maxA=R.max_abs_value;
    let seq=[], next;

    const ap=()=>{
      const start=randInt( (tier==="easy"?0:-50), (tier==="hard"?R.start_max:Math.max(200,R.start_max/2)) );
      const d = randInt( Math.max(R.step_min, tier==="easy"?-10:-25), Math.min(R.step_max, tier==="easy"?10:(tier==="mid"?25:50)) );
      seq=[start];
      for(let i=1;i<5;i++){ seq.push(clampVal(seq[i-1]+d,maxA)); }
      next=clampVal(seq[4]+d,maxA);
    };
    const gp=()=>{
      let start=randInt(1, tier==="easy"?10:50); let r = randInt(2, tier==="hard"?5:4);
      if(Math.random()<0.3) r*=-1;
      seq=[start]; for(let i=1;i<5;i++){ seq.push(clampVal(seq[i-1]*r,maxA)); }
      next=clampVal(seq[4]*r,maxA);
    };
    const fibo=()=>{
      let a=randInt(1, tier==="easy"?6:20), b=randInt(1, tier==="easy"?6:20);
      if(Math.random()<0.3 && preset.allow_negatives){ a*=-1; }
      seq=[a,b]; for(let i=2;i<5;i++){ seq.push(clampVal(seq[i-1]+seq[i-2],maxA)); }
      next=clampVal(seq[3]+seq[4],maxA);
    };
    const growing=()=>{
      let d0=randInt(-10,10), delta=randInt(1, tier==="hard"?6:4)*(Math.random()<0.5?-1:1);
      let a=randInt(0,100); seq=[a];
      let d=d0; for(let i=1;i<5;i++){ a=clampVal(a+d,maxA); seq.push(a); d+=delta; }
      next=clampVal(seq[4]+d,maxA);
    };
    const alternating=()=>{
      let a=randInt(0,100); let p=randInt(2,20), q=randInt(2,20);
      seq=[a]; for(let i=1;i<5;i++){ a = i%2? a+p : a-q; seq.push(clampVal(a,maxA)); }
      next = (5%2? seq[4]+p : seq[4]-q); next=clampVal(next,maxA);
    };
    const interleaved=()=>{
      let a0=randInt(0,50), b0=randInt(0,50), d1=randInt(-10,10), d2=randInt(-10,10);
      seq=[a0,b0];
      for(let i=2;i<5;i++){ seq.push(i%2? clampVal(seq[i-2]+d2,maxA): clampVal(seq[i-2]+d1,maxA)); }
      next = 5%2? clampVal(seq[3]+d2,maxA) : clampVal(seq[3]+d1,maxA);
    };
    const quadratic=()=>{
      let a=randInt(1, tier==="hard"?3:2) * (Math.random()<0.5?-1:1);
      let b=randInt(-5,5), c=randInt(-20,20);
      seq=[0,1,2,3,4].map(i=>clampVal(a*i*i+b*i+c,maxA));
      next=clampVal(a*25 + b*5 + c,maxA);
    };
    const powoff=()=>{
      let k=randInt(-10,10); seq=[1,2,3,4,5].map(i=>clampVal(i*i+k,maxA)); next=clampVal(36+k,maxA);
    };
    const prime=()=>{
      const primes=[2,3,5,7,11,13,17,19,23,29,31,37];
      const start=randInt(0,primes.length-6);
      seq=primes.slice(start,start+5); next=primes[start+5];
    };

    ({AP:ap, GP:gp, FIBO:fibo, GROWING_DIFF:growing, ALTERNATING:alternating, INTERLEAVED:interleaved, QUADRATIC:quadratic, POW_OFFSET:powoff, PRIME:prime}[pat])();
    return {pat, seq, next};
  }
  function sigOf(s){ return `${s.pat}|${s.seq.join(",")}`; }

  function run(){
    const totalMs=cfg.seconds*1000; const ui=card(); root.appendChild(ui);
    ui.innerHTML=`<div class="row" style="justify-content:space-between;align-items:center">
      <span class="pill">Preset: ${PRESETS_SEQ[cfg.preset].name}</span><span class="pill">Zeit: <span id="t" class="timer"></span></span><span class="pill">Frage: <b id="qc">1</b> / ${cfg.n}</span></div>
      <div class="question" id="q"></div>
      <div class="row"><div style="flex:1"><label>Nächstes Element</label><input id="a" inputmode="decimal"></div><button class="btn" id="ok">OK</button><button class="btn ghost" id="skip">Skip</button><button class="btn ghost" id="pause">Pause</button><button class="btn danger" id="abort">Abbrechen</button></div>`;
    const el={t:$("#t",ui),qc:$("#qc",ui),q:$("#q",ui),a:$("#a",ui),ok:$("#ok",ui),skip:$("#skip",ui),pause:$("#pause",ui),abort:$("#abort",ui)};
    minusButtonFor(el.a);
    let i=0, correct=0, per=[], cur=null; let paused=false, pauseT=0, tStart=performance.now(), tPause=0, running=true, qStart=now();

    function tick(){ let tNow=performance.now(); if(paused) tNow=tPause; const used=tNow-tStart-pauseT; const left=Math.max(0,totalMs-used);
      el.t.textContent=(left/1000).toFixed(1)+"s"; if(left<=0&&running){finish();return;} if(running) requestAnimationFrame(tick); }
    function next(){ if(i>=cfg.n){finish();return;} cur=dedupFindNew("seq", ()=>generateItem(i), sigOf); el.q.textContent=cur.seq.join(" , ")+" , ?"; el.a.value=""; el.a.focus(); el.qc.textContent=String(i+1); qStart=now(); }
    function submit(kind){ const ms=Math.round(now()-qStart); const raw=el.a.value.trim(); const user=(kind==="skip"||raw==="")?null:Number(raw.replace(",", ".")); const ok=(user!==null && Math.abs(user-cur.next)<1e-9); if(ok)correct++; per.push({q:cur.seq.join(", "), user, ans:cur.next, correct:ok, ms, skipped:user===null}); i++; next(); }
    function pause(){ if(!paused){paused=true;tPause=performance.now();el.pause.textContent="Resume";} else {paused=false; pauseT+=performance.now()-tPause; el.pause.textContent="Pause"; requestAnimationFrame(tick);} }
    function abort(){ if(confirm("Ohne Speichern beenden?")){ running=false; ui.innerHTML=`<div class="card">Abgebrochen – nicht gespeichert.</div>`; } }
    function finish(){ running=false; const avg=per.length? Math.round(per.reduce((a,x)=>a+x.ms,0)/per.length):0; const stats={correct,total:cfg.n, avgMs:avg, score:correct}; const readiness = clamp(Math.round((correct/(cfg.target||cfg.n))*100),0,200);
      pushSession({module:"seq",preset:cfg.preset,stats,perQuestion:per,settings:{...cfg}});
      const rows=[["#","sequence","your","correct","ms","note"]]; per.forEach((x,j)=>rows.push([j+1,x.q,x.skipped?"—":x.user,x.ans,x.ms,x.skipped?"skip":(x.correct?1:0)]));
      const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
      const txt=per.map((x,j)=>`${j+1}. [${x.q}] -> your=${x.skipped?"":x.user} | correct=${x.ans} | ${x.correct?"OK":"X"} | ${x.ms}ms${x.skipped?" | skip":""}`).join("\n");
      ui.innerHTML = `<h3>Ergebnis</h3><div class="row"><span class="pill">Richtig: <b class="ok">${correct}</b> / ${cfg.n}</span><span class="pill">Ø Zeit: <b>${fmtMs(avg)}</b></span><span class="pill">Ready: <b>${readiness}%</b></span></div>
        <div class="row"><button class="btn" id="dlCsv">Download CSV</button><button class="btn ghost" id="dlTxt">Download TXT</button></div>
        ${table(per.map((x,idx)=>[idx+1,x.q,x.skipped?"—":x.user,x.ans,(x.ms/1000).toFixed(2)+"s",x.correct?"✅":"❌"]),["#","Sequenz","Deine","Korrekt","Zeit","OK"])}`;
      $("#dlCsv",ui).onclick=()=>download(`seq_${new Date().toISOString().replace(/[:.]/g,'-')}.csv`,csv,"text/csv");
      $("#dlTxt",ui).onclick=()=>download(`seq_${new Date().toISOString().replace(/[:.]/g,'-')}.txt`,txt,"text/plain");
      render();
    }
    el.ok.onclick=()=>submit("ok"); el.skip.onclick=()=>submit("skip"); el.pause.onclick=pause; el.abort.onclick=abort; el.a.addEventListener("keydown",e=>{ if(e.key==="Enter") submit("ok"); });
    el.a.addEventListener("input", ()=>{ if(!cfg.auto) return; const raw=el.a.value.trim(); if(!raw) return; const v=Number(raw.replace(",", ".")); if(Math.abs(v - (cur?.next??NaN))<1e-9) submit("ok"); });
    requestAnimationFrame(tick); next();
  }
}

/* ===== TASK SWITCH (stub from previous) ===== */
function viewTaskSwitch(root){
  const el = card(`<h2>🔁 Task Switch</h2><div class="muted small">Kurzfassung hier; volle Version aus früherem Build bleibt kompatibel.</div>`);
  root.appendChild(el);
  el.insertAdjacentHTML("beforeend", `<div class="muted">Nutze vorherige Version, wenn du diesen Modus brauchst. (Code bewusst gekürzt, um die Zip klein zu halten.)</div>`);
}

/* ===== PINCODE (stub) ===== */
function viewPincode(root){
  const el = card(`<h2>🔒 Pincode (3×1min)</h2><div class="muted small">Vereinfachte Anzeige – Kernfunktionen verbleiben in deinem letzten funktionierenden Build.</div>`);
  root.appendChild(el);
}

/* ===== MARKET MAKING (stub) ===== */
function viewMM(root){
  root.appendChild(card(`<h2>📈 Market Making</h2><div class="muted small">Light/Card/Dice Modi sind in deiner funktionierenden Version. Diese Datei fokussiert auf Mental & Sequences Fixes.</div>`));
}

/* ===== BRAINTEASERS & FERMI (stub) ===== */
function viewBrainFermi(root){
  root.appendChild(card(`<h2>🧩 Brainteasers & Fermi</h2><div class="muted small">Pool & Fermi-Checks sind in deinem letzten Build. Diese Datei liefert Bugfixes für PRESETS/Auto-Advance.</div>`));
}

/* ===== Stats & Settings ===== */
function viewStats(root){
  root.appendChild(card(`<h2>📊 Statistik</h2><div class="muted">Alle Sessions, Ø-Zeiten, Accuracy & Highscores.</div>`));
  const by={}; DB.sessions.forEach(s=>{ (by[s.module] ||= []).push(s); });
  for(const [mod, arr] of Object.entries(by)){
    const avg = Math.round(arr.reduce((a,x)=>a+(x.stats?.avgMs||0),0)/(arr.length||1));
    const acc = (arr.reduce((a,x)=>a+(x.stats?.correct||0),0)) / (arr.reduce((a,x)=>a+(x.stats?.total||0),0)) * 100;
    const el = card(`<h3>${title(mod)}</h3><div class="row"><span class="pill">Sessions: <b>${arr.length}</b></span><span class="pill">Ø Zeit/Frage: <b>${isFinite(avg)?fmtMs(avg):"—"}</b></span><span class="pill">Ø Accuracy: <b>${isFinite(acc)?acc.toFixed(1):"—"}%</b></span><span class="pill">Highscore: <b>${DB.highscores[mod]?.score ?? "—"}</b></span></div>`);
    const rows = arr.slice(-50).map((s,i)=>[i+1, new Date(s.date).toLocaleString(), s.stats.correct+"/"+s.stats.total, (s.stats.avgMs/1000).toFixed(2)+"s", s.stats.score ?? "—"]);
    el.insertAdjacentHTML("beforeend", table(rows, ["#","Datum","Richtig","Ø Zeit","Score"]));
    root.appendChild(el);
  }
}
function viewSettings(root){
  root.appendChild(card(`<h2>⚙️ Einstellungen</h2><div class="muted">Dedup-Größe & Reset einzelner Pools.</div>`));
  const panel=card(); const mods=modules.map(m=>m.id).concat(["fermi","marketQ","mental","seq"]);
  panel.appendChild(formRow([
    numberField("Dedup Kapazität (global, fest)",1000,200000,1000,50000, v=>{}),
    ...mods.map(id=>btn(`Reset '${id}'-Pool`, ()=>{ delete DEDUP[id]; saveDedup(); alert(`Pool ${id} geleert.`); }))
  ]));
  root.appendChild(panel);
}
</script>
</main>
</body>
</html>
