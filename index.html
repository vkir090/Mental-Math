<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Mental Math – Quant Prep (Solo)</title>
  <style>
    :root{--bg:#0f1220;--panel:#151936;--accent:#7bd88f;--accent2:#8bd3ff;--text:#eef1ff;--muted:#a8b0d3;--danger:#ff6b6b;--warn:#ffd166}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);
         background:radial-gradient(1000px 600px at 10% -10%, #1a1f45 0%, #0f1220 60%)}
    header{position:sticky;top:0;z-index:5;backdrop-filter:blur(8px);background:rgb(15 18 32 / 72%);
           border-bottom:1px solid #232955;padding:12px 16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    header h1{margin:0;font-size:18px;letter-spacing:.3px}
    nav{display:flex;gap:8px;flex-wrap:wrap}
    nav button{background:var(--panel);color:var(--text);border:1px solid #232955;padding:8px 12px;border-radius:10px;cursor:pointer}
    nav button.active{border-color:var(--accent);box-shadow:0 0 0 2px rgb(123 216 143 / .25) inset}
    main{padding:16px;max-width:1200px;margin:0 auto}
    .card{background:linear-gradient(180deg,#161a3a 0%,#10142c 100%);border:1px solid #232955;border-radius:14px;padding:16px;margin:10px 0;box-shadow:0 8px 24px rgb(0 0 0 / .25)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .grid{display:grid;gap:12px}.grid.cols-2{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;background:#0c1030;color:var(--text);border:1px solid #232955;padding:10px 12px;border-radius:10px;outline:none}
    .btn{background:var(--accent);color:#0a1320;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn.secondary{background:var(--accent2)}.btn.ghost{background:transparent;color:var(--text);border:1px solid #2a316a}.btn.danger{background:var(--danger);color:white}
    .muted{color:var(--muted)} .center{text-align:center}
    .pill{padding:6px 10px;border:1px solid #2a316a;border-radius:999px;color:var(--muted)}
    .timer{font-variant-numeric:tabular-nums}
    .question{font-size:28px;margin:8px 0 12px}
    table{width:100%;border-collapse:collapse;font-variant-numeric:tabular-nums}
    th,td{padding:8px 10px;border-bottom:1px solid #232955}
    tr:hover td{background:#101536}
    .ok{color:var(--accent)}.bad{color:var(--danger)}.warn{color:var(--warn)}
    kbd{background:#0c1030;border:1px solid #232955;border-radius:6px;padding:2px 6px}
    .linklike{color:var(--accent2);cursor:pointer;text-decoration:underline}
  </style>
</head>
<body>
<header>
  <h1>🧮 Mental Math – Solo</h1>
  <nav id="tabs"></nav>
  <div style="margin-left:auto"></div>
  <button class="btn ghost" id="exportJson">Export JSON</button>
  <button class="btn ghost" id="exportCsv">Export CSV</button>
  <button class="btn ghost" id="resetAll">Reset</button>
</header>
<main id="app"></main>

<script>
/*** Utils ***/
const $=(s,e=document)=>e.querySelector(s);
const $$=(s,e=document)=>[...e.querySelectorAll(s)];
const now=()=>performance.now();
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const fmtMs=ms=>(ms/1000).toFixed(2)+"s";
const digits=n=>Math.max(1,Math.floor(Math.log10(Math.abs(n)))+1);
function dl(name,data,type){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([data],{type}));a.download=name;a.click();URL.revokeObjectURL(a.href);}
const rint=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const pick=a=>a[Math.floor(Math.random()*a.length)];
function pickWeighted(map){const entries=Object.entries(map); const sum=entries.reduce((s,[,w])=>s+w,0); let r=Math.random()*sum; for(const [k,w] of entries){ r-=w; if(r<=0) return k; } return entries[0][0]; }

/*** Storage ***/
const DBKEY='mm_db_v2';
const DEDUPKEY='mm_dedup_v2';
const TUNEKEY='mm_tune_v1';
function load(key,def){try{return JSON.parse(localStorage.getItem(key))||structuredClone(def);}catch{ return structuredClone(def);}}
function save(key,val){localStorage.setItem(key,JSON.stringify(val));}
let DB = load(DBKEY,{sessions:[],highscores:{}});
let DEDUP = load(DEDUPKEY,{});
let TUNE = load(TUNEKEY,{mulUglyShare:0.25}); // adaptives „Ugly“-Budget (0..1)
function pushSession(entry){
  DB.sessions.push({...entry, date:new Date().toISOString()});
  const sc = entry.stats?.score ?? entry.stats?.correct ?? 0;
  if(!DB.highscores.mental || sc>DB.highscores.mental.score){
    DB.highscores.mental = {score:sc, when:new Date().toISOString(), detail:entry.stats};
  }
  save(DBKEY,DB);
}
function dedupInit(mod){ if(!DEDUP[mod]) DEDUP[mod]={list:[],set:{}}; }
function dedupHas(mod,s){ dedupInit(mod); return !!DEDUP[mod].set[s]; }
function dedupAdd(mod,s,cap=50000){ dedupInit(mod); if(!DEDUP[mod].set[s]){ DEDUP[mod].set[s]=1; DEDUP[mod].list.push(s); if(DEDUP[mod].list.length>cap){const old=DEDUP[mod].list.shift(); delete DEDUP[mod].set[old];} save(DEDUPKEY,DEDUP);} }
function dedupFindNew(mod,gen,sig,max=200){ for(let t=0;t<max;t++){ const it=gen(); const k=sig(it); if(!dedupHas(mod,k)){ dedupAdd(mod,k); return it; } } return gen(); }

/*** Profile-Presets (Flow/Akuna/Maven) ***/
const PROFILES={
  flow_blue:{label:'Flow – Blue (75/8)', n:75, seconds:480, scoring:'plus1_minus1', enforce_integer:true, allow_decimals:false,
    mix:{addsub:.30, mul2x2:.25, combo:.20, divint:.15, bodmas:.10}},
  akuna_blue:{label:'Akuna – Blue (80/8)', n:80, seconds:480, scoring:'plus1_minus1', enforce_integer:true, allow_decimals:false,
    mix:{addsub:.35, mul2x2:.25, combo:.20, divint:.10, bodmas:.10}},
  maven_brown:{label:'Maven – Brown (40/6)', n:40, seconds:360, scoring:'plus1_zero', enforce_integer:true, allow_decimals:false,
    mix:{addsub:.30, mul2x2:.20, combo:.20, divint:.20, bodmas:.10}}
};
function scoringOf(code){ return code==='plus1_minus1'? {correct:+1,wrong:-1,skip:0} : {correct:+1,wrong:0,skip:0}; }

/*** Difficulty-Tiers ***/
const TIERS={
  easy:{ add:[3,4], mul:[10,29], div:[2,3,4,5,6,8,10], comboC:[30,800]},
  mid :{ add:[4,5], mul:[12,79], div:[2,3,4,5,6,7,8,9,11,12], comboC:[100,2000]},
  hard:{ add:[5,5], mul:[50,99], div:[2,3,4,5,6,7,8,9,10,11,12,14,15,16,18,20,24,25], comboC:[200,4000]}
};
const tierFor=(i,n)=> i < Math.floor(n/3) ? 'easy' : (i < Math.floor(2*n/3) ? 'mid' : 'hard');

/*** Generator-Utils ***/
function pow10(k){return k===0?1:10**k;}
function randByDigits(len){ return rint(pow10(len-1), pow10(len)-1); }
function ensureIntDiv(B, kMin=2, kMax=400){ const k=rint(kMin,kMax); return {A:B*k, k}; }

/* Biased two-digit picker (trick-freundlich vs „hässlich“) */
function twoDigitBiased(tier, uglyShare=TUNE.mulUglyShare){
  const ugly=Math.random()<uglyShare;
  if(!ugly){
    // bevorzugt: runde Zehner, Endziffern 1/2/5/9, kleine Zerlegungen
    const choices=[
      rint(10,99), 10*rint(1,9), 11*rint(1,9), 12*rint(1,8), 15*rint(1,6),
      19,21,22,24,25,27,28,32,36,38,45,48,49,52,54,56,64,72,75,81,84,88,90,96,99
    ];
    const v=pick(choices);
    return {v, ugly:0};
  }else{
    // hässlich: gemischte Ziffern, keine 0/5/10-Multiples, wenig Struktur
    let v=rint(13,97);
    while([10,11,12,15,20,21,22,24,25,30,40,50,60,70,80,90].some(x=>x===v)) v=rint(13,97);
    return {v, ugly:1};
  }
}

/*** Item-Generatoren ***/
// 1) Add/Sub
function gen_addsub(tier, signed=false){
  const [loDigits, hiDigits]=TIERS[tier].add;
  const a=randByDigits(rint(loDigits,hiDigits));
  const b=randByDigits(rint(loDigits,hiDigits));
  const op=pickWeighted({'+':0.6,'-':0.4});
  let A=a,B=b;
  if(!signed && op==='-' && A<B){ [A,B]=[B,A]; }
  const txt=`${A} ${op} ${B}`;
  const ans= op==='+' ? (A+B) : (A-B);
  return {type:'addsub', txt, ans, meta:{digits:[digits(A),digits(B)], ugly:0}};
}

// 2) 2-stellige Multiplikation
function gen_mul2x2(tier){
  const a=twoDigitBiased(tier);
  const b=twoDigitBiased(tier);
  const txt=`${a.v} × ${b.v}`;
  const ans=a.v*b.v;
  const ugly=Math.max(a.ugly,b.ugly);
  return {type:'mul2x2', txt, ans, meta:{digits:[digits(a.v),digits(b.v)], ugly}};
}

// 3) Kombiniert a*b ± c / a ± b*c
function gen_combo(tier){
  const a=twoDigitBiased(tier).v;
  const b=twoDigitBiased(tier).v;
  const [cLo,cHi]=TIERS[tier].comboC;
  const c=rint(cLo,cHi);
  const form=pick(['a*b+c','a+b*c','a*b-c','a-b*c']);
  let txt,ans;
  if(form==='a*b+c'){ txt=`${a} × ${b} + ${c}`; ans=a*b+c; }
  else if(form==='a*b-c'){ txt=`${a} × ${b} - ${c}`; ans=a*b-c; }
  else if(form==='a+b*c'){ txt=`${a} + ${b} × ${c}`; ans=a+b*c; }
  else { txt=`${a} - ${b} × ${c}`; ans=a-b*c; }
  return {type:'combo', txt, ans, meta:{digits:[digits(a),digits(b),digits(c)], ugly:0}};
}

// 4) Division (exakt)
function gen_divint(tier){
  const B=pick(TIERS[tier].div);
  const {A,k}=ensureIntDiv(B, tier==='easy'?2:3, tier==='hard'?600:400);
  const txt=`${A} ÷ ${B}`;
  const ans=k;
  return {type:'divint', txt, ans, meta:{digits:[digits(A),digits(B)], ugly:0}};
}

// 5) BoDMAS / Klammern (2–3 Operatoren, int Ergebnis)
function gen_bodmas(tier){
  // wähle einen sicheren Typ
  const kind=pick(['a + b × c','a × b + c','a × (b + c)','a + (b × c) − d']);
  const td=TIERS[tier];
  const a=rint(10,999), b=rint(10,99), c=rint(10,99), d=rint(5,99);
  let txt, ans;
  if(kind==='a + b × c'){ txt=`${a} + ${b} × ${c}`; ans=a + b*c; }
  else if(kind==='a × b + c'){ txt=`${a} × ${b} + ${c}`; ans=a*b + c; }
  else if(kind==='a × (b + c)'){ txt=`${a} × (${b} + ${c})`; ans=a*(b+c); }
  else { txt=`${a} + (${b} × ${c}) - ${d}`; ans=a + b*c - d; }
  return {type:'bodmas', txt, ans, meta:{digits:[digits(a),digits(b),digits(c)], ugly:0}};
}

// 6) Verschachtelte Brüche a / (b / c) -> int
function gen_nested_fraction(tier){
  const c=pick([2,3,4,5,6,7,8,9,10,12,14]);
  const q=rint(2,80);
  const t=rint(2,20);
  const b=c*t;
  const a=q*b;
  const txt=`${a} / (${b} / ${c})`;
  const ans=q;
  return {type:'nested', txt, ans, meta:{digits:[digits(a),digits(b),digits(c)], ugly:0}};
}

/*** Optional: Dezimal-Hard-Mode (≤5%, Ergebnis int) ***/
function maybeDecimalOperand(n){
  // mache aus n mit kleiner Chance x.5 oder x.25 etc., sodass int-Ergebnis möglich bleibt
  const mode=pick([ 'none','.5','quarter' ]);
  if(mode==='none') return {show:String(n), scale:1};
  if(mode==='.5')   return {show:(n+'.5'), scale:2};      // 12.5 * 8 -> 25 * 4
  // quarter: x.25 => *4
  return {show:(n+'.25'), scale:4};
}
function gen_decimal_mul_int(){
  // (a.dec) × b so dass Ergebnis int
  const a=rint(4,200);
  const b=rint(2,40);
  const dec=maybeDecimalOperand(a);
  const txt=`${dec.show} × ${b}`;
  const ans=(a*dec.scale)*b/dec.scale;
  return {type:'mul_decimal', txt, ans, meta:{digits:[digits(a),digits(b)], ugly:0}};
}

/*** Mix-Orchestrierung ***/
function signature(it){ return `${it.type}|${it.txt}`; }

function factory(profile, i){
  const tier=tierFor(i, profile.n);
  const pool={...profile.mix};
  // Bei Maven: ~20% divint darf „nested“ enthalten
  const allowNested = profile===PROFILES.maven_brown;
  const allowDecimals = profile.allow_decimals && Math.random()<0.05; // ≤5%
  const pickType=()=> pickWeighted(pool);

  const t= pickType();
  let item;
  if(allowDecimals && t==='mul2x2'){ item=gen_decimal_mul_int(); }
  else if(t==='addsub') item=gen_addsub(tier,false);
  else if(t==='mul2x2') item=gen_mul2x2(tier);
  else if(t==='combo') item=gen_combo(tier);
  else if(t==='divint') item= (allowNested && Math.random()<0.2) ? gen_nested_fraction(tier) : gen_divint(tier);
  else if(t==='bodmas') item=gen_bodmas(tier);
  else item=gen_addsub(tier,false);

  // Sicherheit: Integer-Enforcement
  if(profile.enforce_integer && Math.round(item.ans)!==item.ans){ return factory(profile,i); }
  return item;
}

/*** UI-Building ***/
function card(html=''){ const d=document.createElement('div'); d.className='card'; d.innerHTML=html; return d; }
function formRow(items){ const r=document.createElement('div'); r.className='row grid cols-2'; items.forEach(x=>r.appendChild(x)); return r; }
function btn(label,fn,cls='btn'){ const b=document.createElement('button'); b.className=cls; b.textContent=label; b.onclick=fn; return b; }
function numberField(label,min,max,step,val,onInput,allowFloat=false){
  const w=document.createElement('div'); const id='n'+Math.random().toString(36).slice(2);
  w.innerHTML=`<label for="${id}">${label}</label><input id="${id}" ${allowFloat?'':'inputmode="numeric"'} type="number" min="${min}" max="${max}" step="${step}" value="${val}">`;
  const el=$('input',w); el.addEventListener('input', e=>onInput(allowFloat?parseFloat(e.target.value):parseInt(e.target.value))); return w;
}
function selectField(label, opts, onCh, val){
  const w=document.createElement('div'); const id='s'+Math.random().toString(36).slice(2);
  w.innerHTML=`<label for="${id}">${label}</label><select id="${id}">${opts.map(([v,l])=>`<option value="${v}">${l}</option>`).join('')}</select>`;
  const el=$('select',w); el.value=val; el.addEventListener('change',e=>onCh(e.target.value)); return w;
}
function checkboxField(label,checked,onCh){
  const w=document.createElement('div'); const id='c'+Math.random().toString(36).slice(2);
  w.innerHTML=`<label><input id="${id}" type="checkbox" ${checked?'checked':''}> ${label}</label>`;
  $('#'+id,w).addEventListener('change',e=>onCh(e.target.checked)); return w;
}
function table(rows, headers, rawCols = []) {
  const esc = s => (s ?? '').toString().replace(/[<>&]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]));
  const thead = `<thead><tr>${headers.map(h => `<th>${esc(h)}</th>`).join('')}</tr></thead>`;
  const tbody = `<tbody>${
    rows.map(r => `<tr>${
      r.map((c, idx) => `<td>${rawCols.includes(idx) ? (c ?? '') : esc(c)}</td>`).join('')
    }</tr>`).join('')
  }</tbody>`;
  return `<table>${thead}${tbody}</table>`;
}

/*** Tabs ***/
const tabs=[{id:'mental',label:'Mental Math',view:viewMental},{id:'stats',label:'Statistik',view:viewStats},{id:'settings',label:'Einstellungen',view:viewSettings}];
let currentTab=localStorage.getItem('mm_tab')||'mental';
function renderTabs(){ const n=$('#tabs'); n.innerHTML=''; tabs.forEach(t=>{ const b=document.createElement('button'); b.textContent=t.label; b.className=currentTab===t.id?'active':''; b.onclick=()=>{currentTab=t.id; localStorage.setItem('mm_tab',currentTab); render();}; n.appendChild(b); }); }
function render(){ renderTabs(); const root=$('#app'); root.innerHTML=''; (tabs.find(t=>t.id===currentTab)||tabs[0]).view(root); }

/*** Export/Reset ***/
$('#exportJson').onclick=()=>dl('mm_stats_'+new Date().toISOString().slice(0,10)+'.json',JSON.stringify(DB,null,2),'application/json');
$('#exportCsv').onclick=()=>{
  const rows=[["module","date","score","correct","total","avgMs","detail_json","settings_json"]];
  for(const s of DB.sessions){
    rows.push(['mental',s.date,s.stats?.score??'',s.stats?.correct??'',s.stats?.total??'',s.stats?.avgMs??'',JSON.stringify(s.perQuestion||[]),JSON.stringify(s.settings||{})]);
  }
  dl('mm_stats_'+new Date().toISOString().slice(0,10)+'.csv', rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n'), 'text/csv');
};
$('#resetAll').onclick=()=>{ if(confirm('Alle lokalen Daten (Sessions/Highscores/Dedup/Tuning) löschen?')){ localStorage.removeItem(DBKEY); localStorage.removeItem(DEDUPKEY); localStorage.removeItem(TUNEKEY); DB=load(DBKEY,{sessions:[],highscores:{}}); DEDUP={}; TUNE={mulUglyShare:0.25}; render(); } };

/*** Mental-Math View ***/
function viewMental(root){
  root.appendChild(card(`<h2>🧮 Mental Math</h2>
    <div class="muted">Flow/Akuna/Maven-Presets. <b>Auto-Advance</b> bei richtiger Antwort. <b>Pause/Resume</b> (Pausenzeit wird nicht gezählt). <b>Skip</b> hat 0 Punkte.</div>`));

  // Default: Akuna
  const cfg={profile:'akuna_blue', ...PROFILES.akuna_blue, auto:true, target:60};
  const panel=card(); panel.appendChild(formRow([
    selectField('Preset', Object.entries(PROFILES).map(([k,p])=>[k,p.label]), v=>Object.assign(cfg,{profile:v, ...PROFILES[v]}), cfg.profile),
    numberField('Fragen',5,200,1,cfg.n,v=>cfg.n=v),
    numberField('Zeit (s)',60,1800,10,cfg.seconds,v=>cfg.seconds=v),
    selectField('Bewertung', [['plus1_minus1','+1/−1/0'],['plus1_zero','+1/0/0']], val=>cfg.scoring=val, 'plus1_minus1'),
    numberField('Ziel (Ready=100%)',1,200,1,cfg.target,v=>cfg.target=v),
    checkboxField('Auto-Advance', cfg.auto, v=>cfg.auto=v),
    btn('Start', ()=>run())
  ]));
  root.appendChild(panel);

  // Tuning-Panel
  const tune=card(`<h3>⚙️ Tuning</h3>
    <div class="muted">Multiplikation „Ugly“-Anteil: ${(TUNE.mulUglyShare*100)|0}% (passt sich nach Run automatisch an).</div>`);
  root.appendChild(tune);

  const best=DB.highscores.mental; const hi=card('<h3>🏆 Highscore</h3>');
  hi.insertAdjacentHTML('beforeend', best?`<div class="pill">Score: <b>${best.score}</b> · ${new Date(best.when).toLocaleString()}</div>`:'<div class="muted">Noch kein Highscore.</div>');
  root.appendChild(hi);

  function run(){
    const scoring=scoringOf(cfg.scoring);
    const profile={...PROFILES[cfg.profile], n:cfg.n, seconds:cfg.seconds, allow_decimals:PROFILES[cfg.profile].allow_decimals};
    const totalMs=profile.seconds*1000;
    const ui=card(); root.appendChild(ui);
    ui.innerHTML=`
      <div class="row" style="justify-content:space-between;align-items:center">
        <span class="pill">Preset: ${PROFILES[cfg.profile]?.label||'custom'}</span>
        <span class="pill">Zeit: <span id="t" class="timer"></span></span>
        <span class="pill">Frage: <b id="qc">1</b> / ${profile.n}</span>
      </div>
      <div class="question" id="q"></div>
      <div class="row">
        <div style="flex:1">
          <label>Antwort</label>
          <div class="row" style="gap:6px">
            <input id="a" inputmode="decimal" placeholder="Zahl" style="flex:1">
            <button id="minus" class="btn ghost" title="Minus">-</button>
          </div>
        </div>
        <button class="btn" id="ok">OK</button>
        <button class="btn ghost" id="skip">Skip</button>
        <button class="btn ghost" id="pause">Pause</button>
        <button class="btn danger" id="abort">Abbrechen</button>
      </div>
      <div class="muted" id="info"></div>`;

    const el={t:$('#t',ui),qc:$('#qc',ui),q:$('#q',ui),a:$('#a',ui),ok:$('#ok',ui),skip:$('#skip',ui),pause:$('#pause',ui),abort:$('#abort',ui),info:$('#info',ui),minus:$('#minus',ui)};

    let i=0, correct=0, score=0, running=true;
    let paused=false, pauseT=0, tStart=performance.now(), tPause=0;
    let qStart=now(), qPaused=0, qPauseStart=0;
    const per=[]; // Telemetrie: {q,user,ans,ok,ms,type,dig,ugly}

    function gen(){ return dedupFindNew('mental', ()=>factory(profile,i), signature); }

    function tick(){
      let tNow=performance.now(); if(paused) tNow=tPause;
      const used=tNow-tStart-pauseT;
      const left=Math.max(0,totalMs-used);
      el.t.textContent=(left/1000).toFixed(1)+'s';
      if(left<=0&&running){ finish(); return; }
      if(running) requestAnimationFrame(tick);
    }
    function next(){
      if(i>=profile.n){ finish(); return; }
      cur=gen();
      el.q.textContent=cur.txt+' = ?';
      el.a.value=''; el.a.focus();
      el.qc.textContent=String(i+1);
      el.info.textContent=`Bewertung: ${cfg.scoring==='plus1_minus1'?'+1 / −1 / 0':'+1 / 0 / 0'}`;
      qStart=now(); qPaused=0;
    }
    function submit(kind){
      const raw=el.a.value.trim();
      const user=(kind==='skip'||raw==='')?null:Number(raw.replace(',','.'));
      const ok=(user!==null && Math.abs(user-cur.ans)<1e-9);
      const delta = ok?scoring.correct:(user===null?scoring.skip:scoring.wrong);
      score+=delta; if(ok) correct++;
      const ms=Math.round(now()-qStart - qPaused);
      per.push({q:cur.txt,user,ans:cur.ans,ok,ms,type:cur.type,dig:(cur.meta?.digits||[]).join('/'),ugly:cur.meta?.ugly||0});
      i++; next();
    }
    function pause(){ 
      if(!paused){ paused=true; tPause=performance.now(); qPauseStart=now(); el.pause.textContent='Resume'; } 
      else { paused=false; pauseT += performance.now()-tPause; qPaused += now()-qPauseStart; el.pause.textContent='Pause'; requestAnimationFrame(tick);} 
    }
    function abort(){ if(confirm('Ohne Speichern beenden?')){ running=false; ui.innerHTML='<div class="card">Abgebrochen – nicht gespeichert.</div>'; } }
    function finish(){
      running=false;
      // Telemetrie/Analytics
      const avg = per.length? Math.round(per.reduce((a,x)=>a+x.ms,0)/per.length):0;
      const stats={correct,total:profile.n,avgMs:avg,score};
      const readiness=clamp(Math.round((Math.max(score,correct)/(cfg.target||profile.n))*100),0,200);

      // Adaptives Tuning (Multiplikation zu hart → reduziere „Ugly“)
      const mul=per.filter(x=>x.type==='mul2x2');
      if(mul.length>=5){
        const wrong=mul.filter(x=>x.ok!==true).length/mul.length;
        if(wrong>0.35) TUNE.mulUglyShare=Math.max(0.05, TUNE.mulUglyShare-0.05);
        else if(wrong<0.15) TUNE.mulUglyShare=Math.min(0.5, TUNE.mulUglyShare+0.05);
        save(TUNEKEY,TUNE);
      }

      pushSession({module:'mental',preset:cfg.profile,stats,perQuestion:per,settings:{...cfg, scoring:scoring, tune:TUNE}});
      const rows=[["#","question","your","correct","ms","type","digits","ugly"]]; 
      per.forEach((x,j)=>rows.push([j+1,x.q,x.user==null?'':x.user,x.ans,x.ms,x.type,x.dig,x.ugly]));
      const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const txt=per.map((x,j)=>`${j+1}. ${x.q} | your=${x.user==null?'':x.user} | correct=${x.ans} | ${x.ok?'OK':'X'} | ${x.ms}ms | ${x.type} | ugly=${x.ugly}`).join('\n');

      ui.innerHTML=`<h3>Ergebnis</h3>
        <div class="row">
          <span class="pill">Richtig: <b class="ok">${stats.correct}</b> / ${stats.total}</span>
          <span class="pill">Score: <b>${stats.score}</b></span>
          <span class="pill">Ø Zeit: <b>${fmtMs(stats.avgMs)}</b></span>
          <span class="pill">Ready: <b>${readiness}%</b> (Ziel ${cfg.target})</span>
        </div>
        <div class="row"><button class="btn" id="dlCsv">Download CSV</button><button class="btn ghost" id="dlTxt">Download TXT</button></div>
        ${table(per.map((x,idx)=>[idx+1,x.q,x.user==null?'—':x.user,x.ans,(x.ms/1000).toFixed(2)+'s',x.type,x.dig,x.ok?'✅':'❌']),['#','Frage','Deine','Korrekt','Zeit','Typ','Digits','OK'])}`;
      $('#dlCsv',ui).onclick=()=>dl('mental_'+new Date().toISOString().replace(/[:.]/g,'-')+'.csv',csv,'text/csv');
      $('#dlTxt',ui).onclick=()=>dl('mental_'+new Date().toISOString().replace(/[:.]/g,'-')+'.txt',txt,'text/plain');
      render();
    }

    let cur=gen();
    el.q.textContent=cur.txt+' = ?';
    el.info.textContent=`Bewertung: ${cfg.scoring==='plus1_minus1'?'+1 / −1 / 0':'+1 / 0 / 0'}`;
    el.qc.textContent='1';
    el.a.value=''; el.a.focus(); qStart=now();
    requestAnimationFrame(tick);

    el.ok.onclick=()=>submit('ok'); 
    el.skip.onclick=()=>submit('skip'); 
    el.pause.onclick=pause; 
    el.abort.onclick=abort;
    el.minus.onclick=()=>{ if(!el.a.value.startsWith('-')) el.a.value='-'+el.a.value; el.a.focus(); const pos=el.a.value.length; el.a.setSelectionRange(pos,pos); };
    el.a.addEventListener('keydown',e=>{ if(e.key==='Enter') submit('ok'); });
    el.a.addEventListener('input',()=>{ if(!cfg.auto) return; const raw=el.a.value.trim(); if(!raw) return; const v=Number(raw.replace(',','.')); if(Math.abs(v-(cur?.ans??NaN))<1e-9) submit('ok'); });
  }
}

/*** Statistik ***/
function viewStats(root){
  root.appendChild(card(`<h2>📊 Statistik</h2><div class="muted">Alle Läufe, Ø-Zeit/Frage, Accuracy, Highscore & Download.</div>`));
  const arr=DB.sessions.filter(s=>s.module==='mental');
  const sum=f=>arr.reduce((a,x)=>a+(f(x)||0),0);
  const avgMs=Math.round(sum(x=>x.stats?.avgMs)/Math.max(1,arr.length));
  const acc = sum(x=>x.stats?.correct)/Math.max(1,sum(x=>x.stats?.total))*100;
  const el=card(`<div class="row">
      <span class="pill">Sessions: <b>${arr.length}</b></span>
      <span class="pill">Ø Zeit/Frage: <b>${isFinite(avgMs)?fmtMs(avgMs):'—'}</b></span>
      <span class="pill">Ø Accuracy: <b>${isFinite(acc)?acc.toFixed(1):'—'}%</b></span>
      <span class="pill">Highscore: <b>${DB.highscores.mental?.score ?? '—'}</b></span>
    </div>`);
  const rows=arr.slice(-50).map((s,i)=>[
    i+1, new Date(s.date).toLocaleString(),
    `${s.stats.correct}/${s.stats.total}`,
    (s.stats.avgMs/1000).toFixed(2)+'s',
    s.stats.score ?? '—',
    `<span class="linklike" data-idx="${DB.sessions.indexOf(s)}">Details</span>`
  ]);
  el.insertAdjacentHTML('beforeend', table(rows,['#','Datum','Richtig','Ø Zeit','Score','Session'], [5]));
  root.appendChild(el);
  el.addEventListener('click', (ev)=>{
    const t=ev.target.closest('.linklike'); if(!t) return;
    const idx=+t.dataset.idx; const s=DB.sessions[idx];
    const items=(s?.perQuestion||[]).map((x,j)=>`${j+1}. ${x.q} | your=${x.user==null?'':x.user} | correct=${x.ans} | ${x.ok?'OK':'X'} | ${x.ms}ms | ${x.type} | ugly=${x.ugly}`).join('\n');
    const blob=new Blob([items],{type:'text/plain'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='session_'+new Date(s.date).toISOString().replace(/[:.]/g,'-')+'.txt'; a.click(); URL.revokeObjectURL(url);
  });
}

/*** Einstellungen ***/
function viewSettings(root){
  root.appendChild(card(`<h2>⚙️ Einstellungen</h2><div class="muted">Dedup & Datenpflege.</div>`));
  const box=card(); box.appendChild(formRow([
    btn("Dedup-Pool leeren", ()=>{ delete DEDUP['mental']; save(DEDUPKEY,DEDUP); alert('Dedup-Pool geleert.'); }),
    btn("Nur Highscore löschen", ()=>{ delete DB.highscores.mental; save(DBKEY,DB); alert('Highscore gelöscht.'); }, 'btn ghost'),
    btn("Alle Mental-Math-Sessions löschen", ()=>{ DB.sessions=DB.sessions.filter(s=>s.module!=='mental'); save(DBKEY,DB); alert('Sessions gelöscht.'); render(); }, 'btn danger')
  ])); 
  root.appendChild(box);
}

/* Start */
render();
</script>
</main>
</body>
</html>
