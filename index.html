<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Mental Math ‚Äì Quant Prep (Solo)</title>
  <style>
    :root{--bg:#0f1220;--panel:#151936;--accent:#7bd88f;--accent2:#8bd3ff;--text:#eef1ff;--muted:#a8b0d3;--danger:#ff6b6b;--warn:#ffd166}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);
         background:radial-gradient(1000px 600px at 10% -10%, #1a1f45 0%, #0f1220 60%)}
    header{position:sticky;top:0;z-index:5;backdrop-filter:blur(8px);background:rgb(15 18 32 / 72%);
           border-bottom:1px solid #232955;padding:12px 16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    header h1{margin:0;font-size:18px;letter-spacing:.3px}
    nav{display:flex;gap:8px;flex-wrap:wrap}
    nav button{background:var(--panel);color:var(--text);border:1px solid #232955;padding:8px 12px;border-radius:10px;cursor:pointer}
    nav button.active{border-color:var(--accent);box-shadow:0 0 0 2px rgb(123 216 143 / .25) inset}
    main{padding:16px;max-width:1200px;margin:0 auto}
    .card{background:linear-gradient(180deg,#161a3a 0%,#10142c 100%);border:1px solid #232955;border-radius:14px;padding:16px;margin:10px 0;box-shadow:0 8px 24px rgb(0 0 0 / .25)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .grid{display:grid;gap:12px}.grid.cols-2{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;background:#0c1030;color:var(--text);border:1px solid #232955;padding:10px 12px;border-radius:10px;outline:none}
    .btn{background:var(--accent);color:#0a1320;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn.secondary{background:var(--accent2)}.btn.ghost{background:transparent;color:var(--text);border:1px solid #2a316a}.btn.danger{background:var(--danger);color:white}
    .muted{color:var(--muted)} .center{text-align:center}
    .pill{padding:6px 10px;border:1px solid #2a316a;border-radius:999px;color:var(--muted)}
    .timer{font-variant-numeric:tabular-nums}
    .question{font-size:28px;margin:8px 0 12px}
    table{width:100%;border-collapse:collapse;font-variant-numeric:tabular-nums}
    th,td{padding:8px 10px;border-bottom:1px solid #232955}
    tr:hover td{background:#101536}
    .ok{color:var(--accent)}.bad{color:var(--danger)}.warn{color:var(--warn)}
    kbd{background:#0c1030;border:1px solid #232955;border-radius:6px;padding:2px 6px}
    .linklike{color:var(--accent2);cursor:pointer;text-decoration:underline}
  </style>
</head>
<body>
<header>
  <h1>üßÆ Mental Math ‚Äì Solo</h1>
  <nav id="tabs"></nav>
  <div style="margin-left:auto"></div>
  <button class="btn ghost" id="exportJson">Export JSON</button>
  <button class="btn ghost" id="exportCsv">Export CSV</button>
  <button class="btn ghost" id="resetAll">Reset</button>
</header>
<main id="app"></main>

<script>
/***** Utils *****/
const $=(s,e=document)=>e.querySelector(s); const $$=(s,e=document)=>[...e.querySelectorAll(s)];
const now=()=>performance.now(); const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const fmtMs=ms=> (ms/1000).toFixed(2)+"s";
function dl(name,data,type){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([data],{type}));a.download=name;a.click();URL.revokeObjectURL(a.href);}

/***** Storage (scoped) *****/
const DBKEY='mm_db_v1'; const DEDUPKEY='mm_dedup_v1';
function load(key,def){try{return JSON.parse(localStorage.getItem(key))||structuredClone(def);}catch(e){return structuredClone(def);}}
function save(key,val){localStorage.setItem(key,JSON.stringify(val));}
let DB = load(DBKEY,{sessions:[],highscores:{}});
let DEDUP = load(DEDUPKEY,{});
function pushSession(entry){
  DB.sessions.push({...entry, date:new Date().toISOString()});
  const sc = entry.stats?.score ?? entry.stats?.correct ?? 0;
  if(!DB.highscores.mental || sc>DB.highscores.mental.score){
    DB.highscores.mental = {score:sc, when:new Date().toISOString(), detail:entry.stats};
  }
  save(DBKEY,DB);
}
function dedupInit(mod){ if(!DEDUP[mod]) DEDUP[mod]={list:[],set:{}}; }
function dedupHas(mod,s){ dedupInit(mod); return !!DEDUP[mod].set[s]; }
function dedupAdd(mod,s,cap=50000){ dedupInit(mod); if(!DEDUP[mod].set[s]){ DEDUP[mod].set[s]=1; DEDUP[mod].list.push(s); if(DEDUP[mod].list.length>cap){const old=DEDUP[mod].list.shift(); delete DEDUP[mod].set[old];} save(DEDUPKEY,DEDUP);} }
function dedupFindNew(mod,gen,sig,maxTries=200){ for(let i=0;i<maxTries;i++){ const it=gen(); const k=sig(it); if(!dedupHas(mod,k)){ dedupAdd(mod,k); return it; } } return gen(); }

/***** Presets/Targets (VOR render-Aufruf!) *****/
const PRESETS={
  blue:{label:'Blue ‚Äì Akuna (80/8)', n:80, seconds:480, scoring:{correct:+1, wrong:-1, skip:0}, target:60},
  brown:{label:'Brown ‚Äì Maven (40/6)', n:40, seconds:360, scoring:{correct:+1, wrong:0,  skip:0}, target:34},
  red:{label:'Red ‚Äì Flow (75/8)',   n:75, seconds:480, scoring:{correct:+1, wrong:-1, skip:0}, target:53}
};

/***** UI helpers *****/
function card(html=''){ const d=document.createElement('div'); d.className='card'; d.innerHTML=html; return d; }
function formRow(items){ const r=document.createElement('div'); r.className='row grid cols-2'; items.forEach(x=>r.appendChild(x)); return r; }
function btn(label,fn,cls='btn'){ const b=document.createElement('button'); b.className=cls; b.textContent=label; b.onclick=fn; return b; }
function numberField(label,min,max,step,val,onInput,allowFloat=false){
  const w=document.createElement('div'); const id='n'+Math.random().toString(36).slice(2);
  w.innerHTML=`<label for="${id}">${label}</label><input id="${id}" ${allowFloat?'':'inputmode="numeric"'} type="number" min="${min}" max="${max}" step="${step}" value="${val}">`;
  const el=$('input',w); el.addEventListener('input', e=>onInput(allowFloat?parseFloat(e.target.value):parseInt(e.target.value))); return w;
}
function selectField(label, opts, onCh, val){
  const w=document.createElement('div'); const id='s'+Math.random().toString(36).slice(2);
  w.innerHTML=`<label for="${id}">${label}</label><select id="${id}">${opts.map(([v,l])=>`<option value="${v}">${l}</option>`).join('')}</select>`;
  const el=$('select',w); el.value=val; el.addEventListener('change',e=>onCh(e.target.value)); return w;
}
function checkboxField(label,checked,onCh){
  const w=document.createElement('div'); const id='c'+Math.random().toString(36).slice(2);
  w.innerHTML=`<label><input id="${id}" type="checkbox" ${checked?'checked':''}> ${label}</label>`;
  $('#'+id,w).addEventListener('change',e=>onCh(e.target.checked)); return w;
}
function table(rows,headers){
  return `<table><thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
  <tbody>${rows.map(r=>`<tr>${r.map(c=>`<td>${(c??'').toString().replace(/[<>&]/g, s=>({"<":"&lt;",">":"&gt;","&":"&amp;"}[s]))}</td>`).join('')}</tr>`).join('')}</tbody></table>`;
}

/***** App shell *****/
const tabs=[{id:'mental',label:'Mental Math',view:viewMental},{id:'stats',label:'Statistik',view:viewStats},{id:'settings',label:'Einstellungen',view:viewSettings}];
let currentTab=localStorage.getItem('mm_tab')||'mental';
function renderTabs(){ const n=$('#tabs'); n.innerHTML=''; tabs.forEach(t=>{ const b=document.createElement('button'); b.textContent=t.label; b.className=currentTab===t.id?'active':''; b.onclick=()=>{currentTab=t.id; localStorage.setItem('mm_tab',currentTab); render();}; n.appendChild(b); }); }
function render(){ renderTabs(); const root=$('#app'); root.innerHTML=''; (tabs.find(t=>t.id===currentTab)||tabs[0]).view(root); }

/***** Exports/Reset *****/
$('#exportJson').onclick=()=>dl('mm_stats_'+new Date().toISOString().slice(0,10)+'.json',JSON.stringify(DB,null,2),'application/json');
$('#exportCsv').onclick=()=>{
  const rows=[["module","date","score","correct","total","avgMs","detail_json","settings_json"]];
  for(const s of DB.sessions){
    rows.push(['mental',s.date,s.stats?.score??'',s.stats?.correct??'',s.stats?.total??'',s.stats?.avgMs??'',JSON.stringify(s.perQuestion||[]),JSON.stringify(s.settings||{})]);
  }
  dl('mm_stats_'+new Date().toISOString().slice(0,10)+'.csv', rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n'), 'text/csv');
};
$('#resetAll').onclick=()=>{ if(confirm('Alle lokalen Daten (Sessions/Highscores/Dedup) l√∂schen?')){ localStorage.removeItem(DBKEY); localStorage.removeItem(DEDUPKEY); DB=load(DBKEY,{sessions:[],highscores:{}}); DEDUP={}; render(); } };

/***** MENTAL MATH *****/
function viewMental(root){
  root.appendChild(card(`<h2>üßÆ Mental Math</h2>
    <div class="muted">Presets nach Firmenformat. <b>Auto-Advance</b> bei richtiger Antwort, <b>Pause/Resume</b> (Pausenzeit wird nicht mitgez√§hlt), <b>Abbrechen</b> speichert nicht. <b>Skip</b> hat 0 Punkte (kein Malus).</div>`));
  const cfg={preset:'blue', ...PRESETS.blue, auto:true};
  const panel=card(); panel.appendChild(formRow([
    selectField('Preset', Object.entries(PRESETS).map(([k,p])=>[k,p.label]), v=>{ Object.assign(cfg,{preset:v, ...PRESETS[v]}); }, cfg.preset),
    numberField('Fragen',5,200,1,cfg.n,v=>cfg.n=v),
    numberField('Zeit (s)',60,1800,10,cfg.seconds,v=>cfg.seconds=v),
    selectField('Bewertung', [['+1/-1','+1 richtig, -1 falsch'],['+1/0','+1 richtig, 0 falsch']], val=>{
      cfg.scoring = (val==='+1/-1')?{correct:+1,wrong:-1,skip:0}:{correct:+1,wrong:0,skip:0};
    }, '+1/-1'),
    numberField('Zielwert (Ready=100%)',1,200,1,cfg.target,v=>cfg.target=v),
    checkboxField('Auto-Advance', cfg.auto, v=>cfg.auto=v),
    btn('Start', ()=>run())
  ]));
  root.appendChild(panel);
  const best=DB.highscores.mental; const hi=card('<h3>üèÜ Highscore</h3>');
  hi.insertAdjacentHTML('beforeend', best?`<div class="pill">Score: <b>${best.score}</b> ¬∑ ${new Date(best.when).toLocaleString()}</div>`:'<div class="muted">Noch kein Highscore.</div>');
  root.appendChild(hi);

  function rint(a,b){return Math.floor(Math.random()*(b-a+1))+a;} const pick=a=>a[Math.floor(Math.random()*a.length)];
  function genQ(){
    const types=['nestedDiv','mulAdd','addMul','quick','mul']; const t=pick(types);
    let a,b,c,ans,txt;
    if(t==='nestedDiv'){ const c1=rint(2,15); const b1=rint(2,300); const inner=Math.max(1,Math.floor(b1/c1)); const k=rint(2,80); a=inner*k; ans=a/inner; txt=`${a} / (${b1} / ${c1})`; }
    else if(t==='mulAdd'){ a=rint(10,900); b=rint(2,99); c=rint(3,300); ans=a*b+c; txt=`${a} √ó ${b} + ${c}`; }
    else if(t==='addMul'){ a=rint(10,900); b=rint(2,99); c=rint(3,300); ans=a+b*c; txt=`${a} + ${b} √ó ${c}`; }
    else if(t==='quick'){ a=rint(200,2000); b=rint(50,600); if(Math.random()<.5){ ans=a+b; txt=`${a} + ${b}`; } else { ans=a-b; txt=`${a} - ${b}`; } }
    else { a=rint(12,99); b=rint(12,99); ans=a*b; txt=`${a} √ó ${b}`; }
    return {t,a,b,c,ans,txt};
  }
  function sigOf(q){return `${q.t}|${q.a}|${q.b}|${q.c||0}`;}

  function run(){
    const totalMs=cfg.seconds*1000; const ui=card(); root.appendChild(ui);
    ui.innerHTML=`
      <div class="row" style="justify-content:space-between;align-items:center">
        <span class="pill">Preset: ${PRESETS[cfg.preset]?.label||'custom'}</span>
        <span class="pill">Zeit: <span id="t" class="timer"></span></span>
        <span class="pill">Frage: <b id="qc">1</b> / ${cfg.n}</span>
      </div>
      <div class="question" id="q"></div>
      <div class="row">
        <div style="flex:1">
          <label>Antwort</label>
          <div class="row" style="gap:6px">
            <input id="a" inputmode="decimal" placeholder="Zahl" style="flex:1">
            <button id="minus" class="btn ghost" title="Minus">-</button>
          </div>
        </div>
        <button class="btn" id="ok">OK</button>
        <button class="btn ghost" id="skip">Skip</button>
        <button class="btn ghost" id="pause">Pause</button>
        <button class="btn danger" id="abort">Abbrechen</button>
      </div>
      <div class="muted" id="info"></div>`;

    const el={t:$('#t',ui),qc:$('#qc',ui),q:$('#q',ui),a:$('#a',ui),ok:$('#ok',ui),skip:$('#skip',ui),pause:$('#pause',ui),abort:$('#abort',ui),info:$('#info',ui),minus:$('#minus',ui)};
    let i=0, correct=0, score=0, per=[], cur=null; 
    let paused=false, pauseT=0, tStart=performance.now(), tPause=0, running=true;
    let qStart=now(), qPaused=0, qPauseStart=0;

    function tick(){ let tNow=performance.now(); if(paused) tNow=tPause; const used=tNow-tStart-pauseT; const left=Math.max(0,totalMs-used); el.t.textContent=(left/1000).toFixed(1)+'s'; if(left<=0&&running){finish();return;} if(running) requestAnimationFrame(tick); }
    function next(){ if(i>=cfg.n){ finish(); return; } cur=dedupFindNew('mental',genQ,sigOf); el.q.textContent=cur.txt+' = ?'; el.a.value=''; el.a.focus(); el.qc.textContent=String(i+1); el.info.textContent=`Bewertung: +${cfg.scoring.correct} / ${(cfg.scoring.wrong>=0?'+':'')}${cfg.scoring.wrong}`; qStart=now(); qPaused=0; }
    function submit(kind){
      const raw=el.a.value.trim();
      const user=(kind==='skip'||raw==='')?null:Number(raw.replace(',','.'));
      const ok=(user!==null && Math.abs(user-cur.ans)<1e-9);
      const delta = ok?cfg.scoring.correct:(user===null?cfg.scoring.skip:cfg.scoring.wrong);
      score+=delta; if(ok) correct++;
      const ms=Math.round(now()-qStart - qPaused);
      per.push({q:cur.txt,user,ans:cur.ans,correct:ok,ms});
      i++; next();
    }
    function pause(){ 
      if(!paused){ paused=true; tPause=performance.now(); qPauseStart=now(); el.pause.textContent='Resume'; } 
      else { paused=false; pauseT += performance.now()-tPause; qPaused += now()-qPauseStart; el.pause.textContent='Pause'; requestAnimationFrame(tick);} 
    }
    function abort(){ if(confirm('Ohne Speichern beenden?')){ running=false; ui.innerHTML='<div class="card">Abgebrochen ‚Äì nicht gespeichert.</div>'; } }
    function finish(){
      running=false; 
      const avg = per.length? Math.round(per.reduce((a,x)=>a+x.ms,0)/per.length):0;
      const stats={correct,total:cfg.n,avgMs:avg,score};
      const target=cfg.target||cfg.n; 
      const readiness=clamp(Math.round((Math.max(score,correct)/target)*100),0,200);
      pushSession({module:'mental',preset:cfg.preset,stats,perQuestion:per,settings:{...cfg}});
      const rows=[["#","question","your","correct","ms"]]; 
      per.forEach((x,j)=>rows.push([j+1,x.q,x.user==null?'':x.user,x.ans,x.ms]));
      const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const txt=per.map((x,j)=>`${j+1}. ${x.q} | your=${x.user==null?'':x.user} | correct=${x.ans} | ${x.correct?'OK':'X'} | ${x.ms}ms`).join('\n');
      ui.innerHTML=`<h3>Ergebnis</h3>
        <div class="row">
          <span class="pill">Richtig: <b class="ok">${stats.correct}</b> / ${stats.total}</span>
          <span class="pill">Score: <b>${stats.score}</b></span>
          <span class="pill">√ò Zeit: <b>${fmtMs(stats.avgMs)}</b></span>
          <span class="pill">Ziel: <b>${target}</b></span>
          <span class="pill">Ready: <b>${readiness}%</b></span>
        </div>
        <div class="row"><button class="btn" id="dlCsv">Download CSV</button><button class="btn ghost" id="dlTxt">Download TXT</button></div>
        ${table(per.map((x,idx)=>[idx+1,x.q,x.user==null?'‚Äî':x.user,x.ans,(x.ms/1000).toFixed(2)+'s',x.correct?'‚úÖ':'‚ùå']),['#','Frage','Deine','Korrekt','Zeit','OK'])}`;
      $('#dlCsv',ui).onclick=()=>dl('mental_'+new Date().toISOString().replace(/[:.]/g,'-')+'.csv',csv,'text/csv');
      $('#dlTxt',ui).onclick=()=>dl('mental_'+new Date().toISOString().replace(/[:.]/g,'-')+'.txt',txt,'text/plain');
      render();
    }

    el.ok.onclick=()=>submit('ok'); 
    el.skip.onclick=()=>submit('skip'); 
    el.pause.onclick=pause; 
    el.abort.onclick=abort;
    el.a.addEventListener('keydown',e=>{ if(e.key==='Enter') submit('ok'); });
    el.a.addEventListener('input',()=>{ if(!cfg.auto) return; const raw=el.a.value.trim(); if(!raw) return; const v=Number(raw.replace(',','.')); if(Math.abs(v-(cur?.ans??NaN))<1e-9) submit('ok'); });
    el.minus.onclick=()=>{ if(!el.a.value.startsWith('-')) el.a.value='-'+el.a.value; el.a.focus(); const pos=el.a.value.length; el.a.setSelectionRange(pos,pos); };

    requestAnimationFrame(tick); next();
  }
}

/***** Statistik *****/
function viewStats(root){
  root.appendChild(card(`<h2>üìä Statistik</h2><div class="muted">Alle L√§ufe, √ò-Zeit/Frage, Accuracy & Highscore.</div>`));
  const arr=DB.sessions.filter(s=>s.module==='mental');
  const sum=(f)=>arr.reduce((a,x)=>a+(f(x)||0),0);
  const avgMs = Math.round(sum(x=>x.stats?.avgMs)/Math.max(1,arr.length));
  const acc = sum(x=>x.stats?.correct)/Math.max(1,sum(x=>x.stats?.total))*100;
  const el=card(`<div class="row">
      <span class="pill">Sessions: <b>${arr.length}</b></span>
      <span class="pill">√ò Zeit/Frage: <b>${isFinite(avgMs)?fmtMs(avgMs):'‚Äî'}</b></span>
      <span class="pill">√ò Accuracy: <b>${isFinite(acc)?acc.toFixed(1):'‚Äî'}%</b></span>
      <span class="pill">Highscore: <b>${DB.highscores.mental?.score ?? '‚Äî'}</b></span>
    </div>`);
  const rows=arr.slice(-50).map((s,i)=>[
    i+1, new Date(s.date).toLocaleString(),
    `${s.stats.correct}/${s.stats.total}`,
    (s.stats.avgMs/1000).toFixed(2)+'s',
    s.stats.score ?? '‚Äî',
    `<span class="linklike" data-idx="${DB.sessions.indexOf(s)}">Details</span>`
  ]);
  el.insertAdjacentHTML('beforeend', table(rows,['#','Datum','Richtig','√ò Zeit','Score','Session']));
  root.appendChild(el);
  el.addEventListener('click', (ev)=>{
    const t=ev.target.closest('.linklike'); if(!t) return;
    const idx=+t.dataset.idx; const s=DB.sessions[idx];
    const items=(s?.perQuestion||[]).map((x,j)=>`${j+1}. ${x.q} | your=${x.user==null?'':x.user} | correct=${x.ans} | ${x.correct?'OK':'X'} | ${x.ms}ms`).join('\n');
    const blob=new Blob([items],{type:'text/plain'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='session_'+new Date(s.date).toISOString().replace(/[:.]/g,'-')+'.txt'; a.click(); URL.revokeObjectURL(url);
  });
}

/***** Einstellungen *****/
function viewSettings(root){
  root.appendChild(card(`<h2>‚öôÔ∏è Einstellungen</h2><div class="muted">Dedup & Datenpflege.</div>`));
  const box=card(); box.appendChild(formRow([
    btn("Dedup-Pool zur√ºcksetzen", ()=>{ delete DEDUP['mental']; save(DEDUPKEY,DEDUP); alert('Dedup-Pool geleert.'); }, 'btn'),
    btn("Nur Highscore l√∂schen", ()=>{ delete DB.highscores.mental; save(DBKEY,DB); alert('Highscore gel√∂scht.'); }, 'btn ghost'),
    btn("Alle Sessions l√∂schen", ()=>{ DB.sessions = DB.sessions.filter(s=>s.module!=='mental'); save(DBKEY,DB); alert('Mental-Math-Sessions gel√∂scht.'); render(); }, 'btn danger')
  ])); 
  root.appendChild(box);
}

/* Ganz zum Schluss render aufrufen (nachdem alles deklariert ist) */
render();
</script>
</main>
</body>
</html>
