<!DOCTYPE html><html lang="de"><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mental Math Trainer v2</title>
<style>body{margin:0;font-family:system-ui;background:#0f1220;color:#eef1ff}
header{position:sticky;top:0;background:#111738d9;border-bottom:1px solid #232955;padding:10px}
h1{font-size:18px;margin:0}
nav button{background:#151936;border:1px solid #2a316a;border-radius:10px;color:#eef1ff;padding:8px 12px;margin-right:6px}
nav button.active{border-color:#7bd88f}
main{padding:14px;max-width:980px;margin:0 auto}
.card{background:#10142c;border:1px solid #232955;border-radius:12px;padding:14px;margin:10px 0}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end}
input,select{background:#0c1030;border:1px solid #232955;color:#eef1ff;border-radius:8px;padding:10px 12px}
.btn{background:#7bd88f;color:#0b1422;border:0;border-radius:10px;padding:10px 14px;font-weight:600}
.btn.ghost{background:transparent;color:#eef1ff;border:1px solid #2a316a}
.pill{padding:6px 10px;border:1px solid #2a316a;border-radius:999px;color:#a8b0d3}
.timer{font-variant-numeric:tabular-nums}
table{width:100%;border-collapse:collapse;font-variant-numeric:tabular-nums}
th,td{padding:8px 10px;border-bottom:1px solid #232955}
.ok{color:#7bd88f}.bad{color:#ff6b6b}.warn{color:#ffd166}
</style></head><body>
<header><h1>🧠 Mental Math Trainer v2</h1>
<div class="row">
  <nav id="tabs"></nav>
  <div style="margin-left:auto"></div>
  <button id="exportJson" class="btn ghost">Export JSON</button>
  <button id="exportCsv" class="btn ghost">Export CSV</button>
  <button id="reset" class="btn ghost">Reset</button>
</div></header>
<main id="app"></main>
<script>
const $=(s,e=document)=>e.querySelector(s);const $$=(s,e=document)=>[...e.querySelectorAll(s)];
const now=()=>performance.now();
const DBKEY="mm_v2";const DEFAULT={sessions:[],highscores:{}};let DB=load();
function load(){try{return JSON.parse(localStorage.getItem(DBKEY))||structuredClone(DEFAULT)}catch(e){return structuredClone(DEFAULT)}}
function save(){localStorage.setItem(DBKEY,JSON.stringify(DB))}
function pushSession(s){DB.sessions.push({...s,date:new Date().toISOString()});const k=s.module;const sc=s.stats?.score??s.stats?.correct??0;if(!DB.highscores[k]||sc>DB.highscores[k].score){DB.highscores[k]={score:sc,when:new Date().toISOString(),detail:s.stats}};save()}
function download(name,content,type){const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([content],{type}));a.download=name;a.click();URL.revokeObjectURL(a.href)}
$("#exportJson").onclick=()=>download("mm_stats.json",JSON.stringify(DB,null,2),"application/json");
$("#exportCsv").onclick=()=>{let rows=[["module","date","score","correct","total","avgMs","detail_json"]];for(const s of DB.sessions){rows.push([s.module,s.date,s.stats?.score??"",s.stats?.correct??"",s.stats?.total??"",s.stats?.avgMs??"",JSON.stringify(s.perQuestion??[])])}download("mm_stats.csv",rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n"),"text/csv")};
$("#reset").onclick=()=>{if(confirm("Alles löschen?")){localStorage.removeItem(DBKEY);DB=load();render()}};

const PRESETS={
  blue:{label:"Blue – Akuna (80/8)",n:80,seconds:480,scoring:{correct:1,wrong:-1,skip:0},target:60},
  brown:{label:"Brown – Maven (40/6)",n:40,seconds:360,scoring:{correct:1,wrong:0,skip:0},target:34},
  red:{label:"Red – Flow (75/8)",n:75,seconds:480,scoring:{correct:1,wrong:-1,skip:0},target:53}
};

const modules=[{id:"mental",title:"Mental Math",view:viewMental},{id:"seq",title:"Sequences",view:viewSeq},{id:"stats",title:"Statistik",view:viewStats}];
let tab=localStorage.getItem("mm_tab")||"mental";
function renderTabs(){const nav=$("#tabs");nav.innerHTML="";modules.forEach(m=>{const b=document.createElement("button");b.textContent=m.title;b.className=tab===m.id?"active":"";b.onclick=()=>{tab=m.id;localStorage.setItem("mm_tab",tab);render()};nav.appendChild(b)})}
function render(){renderTabs();const root=$("#app");root.innerHTML="";(modules.find(x=>x.id===tab)||modules[0]).view(root)};render();

function card(html=""){const d=document.createElement("div");d.className="card";d.innerHTML=html;return d}
function formRow(items){const r=document.createElement("div");r.className="row";items.forEach(x=>r.appendChild(x));return r}
function btn(label,on){const b=document.createElement("button");b.className="btn";b.textContent=label;b.onclick=on;return b}
function numberField(label,val,on,opts){const w=document.createElement("div");const id="n"+Math.random().toString(36).slice(2);w.innerHTML=`<label for="${id}">${label}</label><input id="${id}" type="number" value="${val}">`;$("#"+id,w).addEventListener("input",e=>on(+e.target.value));return w}
function selectField(label,opts,on,val){const w=document.createElement("div");const id="s"+Math.random().toString(36).slice(2);w.innerHTML=`<label for="${id}">${label}</label><select id="${id}">${opts.map(([v,l])=>`<option value="${v}">${l}</option>`).join("")}</select>`;const s=$("#"+id,w);s.value=val; s.onchange=e=>on(e.target.value);return w}
function checkField(label,checked,on){const w=document.createElement("div");const id="c"+Math.random().toString(36).slice(2);w.innerHTML=`<label><input id="${id}" type="checkbox" ${checked?"checked":""}> ${label}</label>`;$("#"+id,w).onchange=e=>on(e.target.checked);return w}
function table(rows,heads){return `<table><thead><tr>${heads.map(h=>`<th>${h}</th>`).join("")}</tr></thead><tbody>${rows.map(r=>`<tr>${r.map(c=>`<td>${String(c).replace(/[<>&]/g,s=>({"<":"&lt;",">":"&gt;","&":"&amp;"}[s]))}</td>`).join("")}</tr>`).join("")}</tbody></table>`}

function viewMental(root){
  root.appendChild(card(`<h2>🧮 Mental Math</h2><div>Presets exakt nach Firmen-Formaten. <b>Pause/Resume</b>, <b>Abbrechen</b> (ohne Speichern), Auto-Advance bei richtiger Antwort. Ready-% am Ende.</div>`));
  const cfg={preset:"blue",n:80,seconds:480,scoring:{correct:1,wrong:-1,skip:0},target:60,auto:true};
  const p=card(); p.appendChild(formRow([
    selectField("Preset", Object.entries(PRESETS).map(([k,v])=>[k,v.label]), v=>{cfg.preset=v; Object.assign(cfg,{n:PRESETS[v].n,seconds:PRESETS[v].seconds,scoring:PRESETS[v].scoring,target:PRESETS[v].target});}, cfg.preset),
    numberField("Fragen", cfg.n, v=>cfg.n=v),
    numberField("Zeit gesamt (s)", cfg.seconds, v=>cfg.seconds=v),
    numberField("Ziel (Ready=100%)", cfg.target, v=>cfg.target=v),
    selectField("Bewertung", [["+1/-1","+1/-1"],["+1/0","+1/0"]], val=>cfg.scoring=(val==="+1/-1")?{correct:1,wrong:-1,skip:0}:{correct:1,wrong:0,skip:0}, "+1/-1"),
    checkField("Auto-Advance", cfg.auto, v=>cfg.auto=v),
    btn("Start", ()=>run())
  ])); root.appendChild(p);
  root.appendChild(high("mental"));

  function genQ(){const t=Math.floor(Math.random()*5);const r=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;let a,b,c,ans,txt;
    if(t===0){c=r(2,15);b=r(2,300);const inn=Math.max(1,Math.floor(b/c));const k=r(2,80);a=inn*k;ans=a/inn;txt=`${a} / (${b} / ${c})`;}
    else if(t===1){a=r(10,900);b=r(2,99);c=r(3,300);ans=a*b+c;txt=`${a} × ${b} + ${c}`;}
    else if(t===2){a=r(10,900);b=r(2,99);c=r(3,300);ans=a+b*c;txt=`${a} + ${b} × ${c}`;}
    else if(t===3){a=r(200,2000);b=r(50,600);ans=Math.random()<.5?a+b:a-b;txt=`${a} ± ${b}`;}
    else {a=r(12,99);b=r(12,99);ans=a*b;txt=`${a} × ${b}`;}
    return {txt,ans}
  }

  function run(){
    const ui=card(); root.appendChild(ui);
    ui.innerHTML=`<div class="row" style="justify-content:space-between">
      <span class="pill">Preset: ${PRESETS[cfg.preset].label}</span>
      <span class="pill">Zeit: <span id="t" class="timer"></span></span>
      <span class="pill">Frage: <b id="qc">1</b> / ${cfg.n}</span></div>
      <div class="card"><div id="q" style="font-size:26px;margin-bottom:8px"></div>
      <div class="row"><input id="a" inputmode="decimal" placeholder="Zahl"><button class="btn" id="ok">OK</button><button class="btn ghost" id="skip">Skip</button><button class="btn ghost" id="pause">Pause</button><button class="btn ghost" id="abort">Abbrechen</button></div>
      <div class="pill" id="info"></div></div>`;
    const el={t:$("#t",ui),qc:$("#qc",ui),q:$("#q",ui),a:$("#a",ui),ok:$("#ok",ui),skip:$("#skip",ui),pause:$("#pause",ui),abort:$("#abort",ui),info:$("#info",ui)};
    let i=0,correct=0,score=0,per=[],cur=null,paused=false,pauseT=0,tStart=performance.now(),tPause=0,qStart=now(),running=true;
    function tick(){let tNow=performance.now(); if(paused) tNow=tPause; const used=tNow-tStart-pauseT; const left=Math.max(0,cfg.seconds*1000-used); el.t.textContent=(left/1000).toFixed(1)+"s"; if(left<=0&&running){finish();return} if(running) requestAnimationFrame(tick)}
    function next(){ if(i>=cfg.n){finish();return} cur=genQ(); el.q.textContent=cur.txt+" = ?"; el.a.value=""; el.a.focus(); el.qc.textContent=String(i+1); el.info.textContent=`Bewertung +${cfg.scoring.correct}/${cfg.scoring.wrong}`; qStart=now(); }
    function submit(kind){ const ms=Math.round(now()-qStart); const raw=el.a.value.trim(); const user=(kind==="skip"||raw==="")?null:Number(raw.replace(",", ".")); const ok=(user!==null && Math.abs(user-cur.ans)<1e-9); if(ok) correct++; const delta= ok? cfg.scoring.correct : (user===null? cfg.scoring.skip : cfg.scoring.wrong); score+=delta; per.push({q:cur.txt,user,ans:cur.ans,correct:ok,ms}); i++; next(); }
    function pause(){ if(!paused){paused=true;tPause=performance.now();el.pause.textContent="Resume"} else {paused=false;pauseT+=performance.now()-tPause;el.pause.textContent="Pause";requestAnimationFrame(tick)} }
    function abort(){ if(confirm("Ohne Speichern beenden?")){ running=false; ui.innerHTML="<div class='card'>Abgebrochen – nicht gespeichert.</div>"; } }
    function finish(){ running=false; const avg=per.length?Math.round(per.reduce((a,x)=>a+x.ms,0)/per.length):0; const stats={correct,total:cfg.n,avgMs:avg,score}; const target=cfg.target||cfg.n; const readiness=Math.max(0,Math.min(100,Math.round((Math.max(score,correct)/target)*100))); pushSession({module:"mental",preset:cfg.preset,stats,perQuestion:per,settings:{...cfg}}); const rows=[["#","question","your","correct","ms"]]; per.forEach((x,i)=>rows.push([i+1,x.q,x.user==null?"":x.user,x.ans,x.ms])); const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n"); const txt=per.map((x,i)=>`${i+1}. ${x.q} | your=${x.user==null?"":x.user} | correct=${x.ans} | ${x.correct?"OK":"X"} | ${x.ms}ms`).join("\n"); ui.innerHTML=`<div class="card"><h3>Ergebnis</h3><div>Richtig: <b>${correct}</b> / ${cfg.n} · Score: <b>${score}</b> · Ø ${(avg/1000).toFixed(2)}s · Ready: <b>${readiness}%</b> (Ziel ${target})</div><div class="row"><button id="dlCsv" class="btn">Download CSV</button><button id="dlTxt" class="btn ghost">Download TXT</button></div></div>`; $("#dlCsv",ui).onclick=()=>download("mental_session.csv",csv,"text/csv"); $("#dlTxt",ui).onclick=()=>download("mental_session.txt",txt,"text/plain"); render(); }
    el.ok.onclick=()=>submit("ok"); el.skip.onclick=()=>submit("skip"); el.pause.onclick=pause; el.abort.onclick=abort; el.a.addEventListener("keydown",e=>{ if(e.key==="Enter") submit("ok"); }); el.a.addEventListener("input",()=>{ if(!cfg.auto) return; const raw=el.a.value.trim(); if(!raw) return; const v=Number(raw.replace(",", ".")); if(Math.abs(v - cur.ans) < 1e-9) submit("ok"); });
    requestAnimationFrame(tick); next();
  }
}

function viewSeq(root){
  root.appendChild(card(`<h2>🔗 Sequences</h2><div>Presets: Akuna 10/5, Maven 15/15, Flow 26/25. Pause/Abbrechen & Export. Ready-% = korrekt / Ziel.</div>`));
  const presets={akuna:{n:10,seconds:300,target:8},maven:{n:15,seconds:900,target:12},flow:{n:26,seconds:1500,target:18}};
  const cfg={preset:"akuna",...presets.akuna}; const p=card(); p.appendChild(formRow([
    selectField("Preset", [["akuna","Akuna 10/5"],["maven","Maven 15/15"],["flow","Flow 26/25"]], v=>{cfg.preset=v; Object.assign(cfg,presets[v]);} ,"akuna"),
    numberField("Fragen", cfg.n, v=>cfg.n=v),
    numberField("Zeit (s)", cfg.seconds, v=>cfg.seconds=v),
    numberField("Ziel", cfg.target, v=>cfg.target=v),
    btn("Start", ()=>run())
  ])); root.appendChild(p); root.appendChild(high("seq"));

  function genSeq(){const r=(a,b)=>Math.floor(Math.random()*(b-a+1))+a; const pick=a=>a[Math.floor(Math.random()*a.length)]; const t=["arith","geom","alt","fib"][Math.floor(Math.random()*4)]; let seq=[],next;
    if(t==="arith"){const a0=r(-20,30),d=r(-9,12);for(let i=0;i<5;i++)seq.push(a0+i*d);next=a0+5*d}
    else if(t==="geom"){const a0=r(1,9),q=pick([2,3,4,5]);for(let i=0;i<5;i++)seq.push(a0*Math.pow(q,i));next=a0*Math.pow(q,5)}
    else if(t==="alt"){const a0=r(-9,9),d=r(2,12);for(let i=0;i<5;i++)seq.push(i%2==0?a0+i*d:a0-i*d);next=5%2==0?a0+5*d:a0-5*d}
    else {const a0=r(1,9),a1=r(1,9);seq=[a0,a1];for(let i=2;i<5;i++)seq.push(seq[i-1]+seq[i-2]);next=seq[3]+seq[4]} return {seq,next}}
  function run(){const ui=card();root.appendChild(ui); ui.innerHTML=`<div class="row" style="justify-content:space-between"><span class="pill">Preset: ${cfg.preset}</span><span class="pill">Zeit: <span id="t" class="timer"></span></span><span class="pill">Frage: <b id="qc">1</b> / ${cfg.n}</span></div><div class="card"><div id="q" style="font-size:26px;margin-bottom:8px"></div><div class="row"><input id="a" inputmode="decimal"><button class="btn" id="ok">OK</button><button class="btn ghost" id="skip">Skip</button><button class="btn ghost" id="pause">Pause</button><button class="btn ghost" id="abort">Abbrechen</button></div></div>`;
    const el={t:$("#t",ui),qc:$("#qc",ui),q:$("#q",ui),a:$("#a",ui),ok:$("#ok",ui),skip:$("#skip",ui),pause:$("#pause",ui),abort:$("#abort",ui)};
    let per=[],i=0,correct=0,paused=false,pauseT=0,tStart=performance.now(),tPause=0,cur=null,qStart=now(),running=true;
    function tick(){let tNow=performance.now();if(paused)tNow=tPause;const used=tNow-tStart-pauseT;const left=Math.max(0,cfg.seconds*1000-used);el.t.textContent=(left/1000).toFixed(1)+"s";if(left<=0&&running){finish();return} if(running) requestAnimationFrame(tick)}
    function next(){if(i>=cfg.n){finish();return} cur=genSeq(); el.q.textContent=cur.seq.join(" , ")+" , ?"; el.a.value=""; el.a.focus(); el.qc.textContent=String(i+1); qStart=now()}
    function submit(kind){const ms=Math.round(now()-qStart);const raw=el.a.value.trim();const user=(kind==="skip"||raw==="")?null:Number(raw.replace(",", "."));const ok=(user!==null&&Math.abs(user-cur.next)<1e-9);if(ok)correct++;per.push({q:cur.seq.join(", "),user,ans:cur.next,correct:ok,ms});i++;next()}
    function pause(){if(!paused){paused=true;tPause=performance.now();el.pause.textContent="Resume"}else{paused=false;pauseT+=performance.now()-tPause;el.pause.textContent="Pause";requestAnimationFrame(tick)}}
    function abort(){if(confirm("Ohne Speichern beenden?")){running=false;ui.innerHTML="<div class='card'>Abgebrochen – nicht gespeichert.</div>"}}
    function finish(){running=false;const avg=per.length?Math.round(per.reduce((a,x)=>a+x.ms,0)/per.length):0;const stats={correct,total:cfg.n,avgMs:avg,score:correct};const ready=Math.max(0,Math.min(100,Math.round((correct/(cfg.target||cfg.n))*100)));pushSession({module:"seq",preset:cfg.preset,stats,perQuestion:per,settings:{...cfg}});const rows=[["#","sequence","your","correct","ms"]];per.forEach((x,i)=>rows.push([i+1,x.q,x.user==null?"":x.user,x.ans,x.ms]));const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");const txt=per.map((x,i)=>`${i+1}. [${x.q}] -> your=${x.user==null?"":x.user} | correct=${x.ans} | ${x.correct?"OK":"X"} | ${x.ms}ms`).join("\n");ui.innerHTML=`<div class="card"><h3>Ergebnis</h3><div>Richtig: <b>${correct}</b> / ${cfg.n} · Ø ${(avg/1000).toFixed(2)}s · Ready: <b>${ready}%</b> (Ziel ${cfg.target})</div><div class="row"><button id="dlCsv" class="btn">Download CSV</button><button id="dlTxt" class="btn ghost">Download TXT</button></div>${table(per.map((x,i)=>[i+1,x.q,x.user==null?"—":x.user,x.ans,(x.ms/1000).toFixed(2)+"s",x.correct?"✅":"❌"]),["#","Sequenz","Deine","Korrekt","Zeit","OK"])}</div>`;$("#dlCsv",ui).onclick=()=>download("seq_session.csv",csv,"text/csv");$("#dlTxt",ui).onclick=()=>download("seq_session.txt",txt,"text/plain"); render();}
    el.ok.onclick=()=>submit("ok"); el.skip.onclick=()=>submit("skip"); el.pause.onclick=pause; el.abort.onclick=abort; el.a.onkeydown=e=>{if(e.key==="Enter")submit("ok")}; requestAnimationFrame(tick); next();
  }
}

function high(id){const h=DB.highscores[id];return card("<h3>🏆 Highscore</h3>"+(h?`<div class='pill'>Score: <b>${h.score}</b> (${new Date(h.when).toLocaleString()})</div>`:"<div class='pill'>Noch kein Highscore.</div>"))}
function viewStats(root){const by={};DB.sessions.forEach(s=>{(by[s.module] ||= []).push(s)});for(const [k,arr] of Object.entries(by)){const avg=Math.round(arr.reduce((a,x)=>a+(x.stats?.avgMs||0),0)/arr.length);const acc=(arr.reduce((a,x)=>a+(x.stats?.correct||0),0))/(arr.reduce((a,x)=>a+(x.stats?.total||0),0))*100;root.appendChild(card(`<h3>${k}</h3><div class='pill'>Sessions: ${arr.length}</div> <div class='pill'>Ø Zeit: ${(avg/1000).toFixed(2)}s</div> <div class='pill'>Ø Accuracy: ${isFinite(acc)?acc.toFixed(1):"—"}%</div>`)); root.appendChild(card(table(arr.map((s,i)=>[i+1,new Date(s.date).toLocaleString(),s.stats.correct+"/"+s.stats.total,(s.stats.avgMs/1000).toFixed(2)+"s",s.stats.score??"—"]),["#","Datum","Richtig","Ø Zeit","Score"])))} }
</script></main></body></html>
