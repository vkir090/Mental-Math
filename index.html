<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Quant Prep Trainer v3 (Single File, +/- Fix)</title>
  <style>
    :root{--bg:#0f1220;--panel:#151936;--accent:#7bd88f;--accent2:#8bd3ff;--text:#eef1ff;--muted:#a8b0d3;--danger:#ff6b6b;--warn:#ffd166}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);
         background:radial-gradient(1000px 600px at 10% -10%, #1a1f45 0%, #0f1220 60%)}
    header{position:sticky;top:0;z-index:5;backdrop-filter:blur(8px);background:rgb(15 18 32 / 72%);
           border-bottom:1px solid #232955;padding:12px 16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    header h1{margin:0;font-size:18px;letter-spacing:.3px}
    nav{display:flex;gap:8px;flex-wrap:wrap}
    nav button{background:var(--panel);color:var(--text);border:1px solid #232955;padding:8px 12px;border-radius:10px;cursor:pointer}
    nav button.active{border-color:var(--accent);box-shadow:0 0 0 2px rgb(123 216 143 / .25) inset}
    main{padding:16px;max-width:1200px;margin:0 auto}
    .card{background:linear-gradient(180deg,#161a3a 0%,#10142c 100%);border:1px solid #232955;border-radius:14px;padding:16px;margin:10px 0;box-shadow:0 8px 24px rgb(0 0 0 / .25)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .grid{display:grid;gap:12px}.grid.cols-2{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;background:#0c1030;color:var(--text);border:1px solid #232955;padding:10px 12px;border-radius:10px;outline:none}
    .btn{background:var(--accent);color:#0a1320;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn.secondary{background:var(--accent2)}.btn.ghost{background:transparent;color:var(--text);border:1px solid #2a316a}.btn.danger{background:var(--danger);color:white}
    .muted{color:var(--muted)} .center{text-align:center}
    .pill{padding:6px 10px;border:1px solid #2a316a;border-radius:999px;color:var(--muted)}
    .timer{font-variant-numeric:tabular-nums}
    .question{font-size:26px;margin:8px 0 12px}
    table{width:100%;border-collapse:collapse;font-variant-numeric:tabular-nums}
    th,td{padding:8px 10px;border-bottom:1px solid #232955}
    tr:hover td{background:#101536}
    .ok{color:var(--accent)}.bad{color:var(--danger)}.warn{color:var(--warn)}
    kbd{background:#0c1030;border:1px solid #232955;border-radius:6px;padding:2px 6px}
  </style>
</head>
<body>
<header>
  <h1>üßÆ Quant Prep Trainer v3</h1>
  <nav id="tabs"></nav>
  <div style="margin-left:auto"></div>
  <button class="btn ghost" id="exportJson">Export JSON</button>
  <button class="btn ghost" id="exportCsv">Export CSV</button>
  <button class="btn ghost" id="reset">Reset</button>
</header>
<main id="app"></main>

<script>
var $=function(s,e){return (e||document).querySelector(s)};
var $$=function(s,e){return [].slice.call((e||document).querySelectorAll(s))};
var now=function(){return performance.now()};
var clamp=function(x,a,b){return Math.max(a,Math.min(b,x))};
var fmtMs=function(ms){return (ms/1000).toFixed(2)+"s"};
function download(name, data, type){var a=document.createElement('a');a.href=URL.createObjectURL(new Blob([data],{type:type}));a.download=name;a.click();URL.revokeObjectURL(a.href);}
function get(obj, path, def){ try{ var v=obj; var ks=path.split('.'); for(var i=0;i<ks.length;i++){ if(v==null) return def; v=v[ks[i]]; } return (v===undefined||v===null)?def:v; } catch(e){ return def; } }
function cloneSafe(x){ try{ if(typeof structuredClone==='function') return structuredClone(x); }catch(e){} try{ return JSON.parse(JSON.stringify(x)); }catch(e){ return x; }}

var DBKEY="qprep_v3"; var DEDUPKEY="qprep_dedup_v1";
var DB = load(DBKEY, {sessions:[], highscores:{}});
var DEDUP = load(DEDUPKEY, {});
function load(key, def){
  try{
    var raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : cloneSafe(def);
  }catch(e){ return cloneSafe(def); }
}
function saveDB(){ try{ localStorage.setItem(DBKEY, JSON.stringify(DB)); }catch(e){} }
function saveDedup(){ try{ localStorage.setItem(DEDUPKEY, JSON.stringify(DEDUP)); }catch(e){} }
function pushSession(entry){
  entry = Object.assign({}, entry, {date:new Date().toISOString()});
  DB.sessions.push(entry);
  var k = entry.module;
  var score = (entry.stats && typeof entry.stats.score!=='undefined') ? entry.stats.score :
              (entry.stats && typeof entry.stats.correct!=='undefined' ? entry.stats.correct : 0);
  if(!(k in DB.highscores) || score > DB.highscores[k].score){
    DB.highscores[k] = {score:score, when:new Date().toISOString(), detail:entry.stats};
  }
  saveDB();
}
function dedupInit(mod){ if(!DEDUP[mod]) DEDUP[mod] = {list:[], set:{}}; }
function dedupHas(mod, sig){ dedupInit(mod); return !!DEDUP[mod].set[sig]; }
function dedupAdd(mod, sig, cap){
  if(cap===void 0) cap=50000;
  dedupInit(mod);
  if(!DEDUP[mod].set[sig]){
    DEDUP[mod].set[sig]=1; DEDUP[mod].list.push(sig);
    if(DEDUP[mod].list.length>cap){ var old=DEDUP[mod].list.shift(); delete DEDUP[mod].set[old]; }
    saveDedup();
  }
}
function dedupFindNew(mod, genFn, sigFn, maxTries){
  if(maxTries===void 0) maxTries=200;
  for(var t=0;t<maxTries;t++){
    var item = genFn(); var sig = sigFn(item);
    if(!dedupHas(mod, sig)){ dedupAdd(mod, sig); return item; }
  }
  return genFn();
}

var modules=[
  {id:"mental", title:"Mental Math", view:viewMental},
  {id:"seq", title:"Sequences", view:viewSequences},
  {id:"task", title:"Task Switch", view:viewTaskSwitch},
  {id:"pin", title:"Pincode (3√ó1min)", view:viewPincode},
  {id:"mmg", title:"Market Making", view:viewMM},
  {id:"brain", title:"Brainteasers & Fermi", view:viewBrainFermi},
  {id:"stats", title:"Statistik", view:viewStats},
  {id:"settings", title:"Einstellungen", view:viewSettings}
];
var currentTab = localStorage.getItem("qprep_tab") || "mental";
function renderTabs(){
  var nav=$("#tabs"); nav.innerHTML="";
  modules.forEach(function(m){
    var b=document.createElement("button"); b.textContent=m.title;
    b.className = currentTab===m.id? "active":""; b.onclick = function(){ currentTab=m.id; localStorage.setItem("qprep_tab", currentTab); render(); };
    nav.appendChild(b);
  });
}
function render(){ renderTabs(); $("#app").innerHTML=""; (modules.find(function(x){return x.id===currentTab;})||modules[0]).view($("#app")); }
render();

$("#exportJson").onclick=function(){ download("qprep_stats_"+new Date().toISOString().slice(0,10)+".json", JSON.stringify(DB,null,2), "application/json"); };
$("#exportCsv").onclick=function(){
  var rows=[["module","date","score","correct","total","avgMs","detail_json","settings_json"]];
  DB.sessions.forEach(function(s){
    rows.push([s.module, s.date, get(s,"stats.score",""), get(s,"stats.correct",""), get(s,"stats.total",""), get(s,"stats.avgMs",""), JSON.stringify(s.perQuestion||[]), JSON.stringify(s.settings||{})]);
  });
  var csv = rows.map(function(r){return r.map(function(x){return '"'+String(x).replace(/"/g,'""')+'"';}).join(",");}).join("
");
  download("qprep_stats_"+new Date().toISOString().slice(0,10)+".csv", csv, "text/csv");
};
$("#reset").onclick=function(){ if(confirm("Wirklich alle lokalen Daten (Scores, Sessions, Dedup) l√∂schen?")){ localStorage.removeItem(DBKEY); localStorage.removeItem(DEDUPKEY); DB=load(DBKEY,{sessions:[],highscores:{}}); DEDUP={}; render(); } };

function card(html){ if(html===void 0) html=""; var d=document.createElement('div'); d.className="card"; d.innerHTML=html; return d; }
function formRow(items){ var r=document.createElement('div'); r.className="row grid cols-2"; items.forEach(function(x){r.appendChild(x)}); return r; }
function btn(label, onClick, cls){ if(cls===void 0) cls="btn"; var b=document.createElement('button'); b.className=cls; b.textContent=label; b.onclick=onClick; return b; }
function numberField(label, min, max, step, value, onInput, allowFloat){
  if(allowFloat===void 0) allowFloat=false;
  var w=document.createElement('div'); var id="n"+Math.random().toString(36).slice(2);
  w.innerHTML='<label for="'+id+'">'+label+'</label><input id="'+id+'" '+(allowFloat?"":"inputmode="numeric"")+' type="number" min="'+min+'" max="'+max+'" step="'+step+'" value="'+value+'">';
  var el=$("input",w); el.addEventListener('input', function(e){ onInput(allowFloat?parseFloat(e.target.value):parseInt(e.target.value)); }); return w;
}
function selectField(label, options, onChange, value){
  var w=document.createElement('div'); var id="s"+Math.random().toString(36).slice(2);
  w.innerHTML='<label for="'+id+'">'+label+'</label><select id="'+id+'">'+options.map(function(p){return '<option value="'+p[0]+'">'+p[1]+'</option>';}).join("")+'</select>';
  var sel = $("select",w); sel.value=value; sel.addEventListener('change', function(e){ onChange(e.target.value); }); return w;
}
function checkboxField(label, checked, onChange){
  var w=document.createElement('div'); var id="c"+Math.random().toString(36).slice(2);
  w.innerHTML='<label><input id="'+id+'" type="checkbox" '+(checked?"checked":"")+'> '+label+'</label>';
  $("#"+id, w).addEventListener('change', function(e){ onChange(e.target.checked); }); return w;
}
function escapeHtml(s){ return String(s).replace(/[<>&]/g, function(x){return {"<":"&lt;",">":"&gt;","&":"&amp;"}[x];}); }
function table(rows, headers){
  return '<table><thead><tr>'+headers.map(function(h){return '<th>'+h+'</th>';}).join("")+'</tr></thead><tbody>'+
  rows.map(function(r){return '<tr>'+r.map(function(c){ c=(c===void 0||c===null)?"":c; return '<td>'+escapeHtml(c)+'</td>'; }).join("")+'</tr>';}).join("")+
  '</tbody></table>';
}
function title(id){ return {mental:"Mental Math", seq:"Sequences", task:"Task Switch", pin:"Pincode", mmg:"Market Making", brain:"Brainteasers & Fermi", stats:"Statistik"}[id] || id; }
function highCard(moduleId){ var best=DB.highscores[moduleId]; var el=card("<h3>üèÜ Highscore</h3>"); el.insertAdjacentHTML("beforeend", best? '<div class="pill">Score: <b>'+best.score+'</b> ¬∑ '+new Date(best.when).toLocaleString()+'</div>' : '<div class="muted">Noch kein Highscore.</div>'); return el; }

var PRESETS_MENTAL={
  blue:{label:"Blue ‚Äì Akuna (80/8)", n:80, seconds:480, scoring:{correct:+1, wrong:-1, skip:0}, target:60},
  brown:{label:"Brown ‚Äì Maven (40/6)", n:40, seconds:360, scoring:{correct:+1, wrong:0,  skip:0}, target:34},
  red:{label:"Red ‚Äì Flow (75/8)",     n:75, seconds:480, scoring:{correct:+1, wrong:-1, skip:0}, target:53}
};
var PRESETS_SEQ={ akuna:{n:10, seconds:300, target:8}, maven:{n:15, seconds:900, target:12}, flow:{n:26, seconds:1500, target:18} };
var TARGET_TASK = {net:25, acc:90};
var TARGET_PIN  = {total:24};
var TARGET_MMG  = {pnlRate:0.02};
var TARGET_BRAIN= {acc:80, medSec:120};
var TARGET_FERMI= {withinFactor:10, rate:80, mm_hit:70};

function viewMental(root){
  root.appendChild(card('<h2>üßÆ Mental Math</h2><div class="muted">Presets nach Firmenformat. <b>Auto-Advance</b> bei richtiger Antwort, <b>Pause/Resume</b>, <b>Abbrechen</b>. <b>Keine Wiederholungen</b>. <b>¬±</b> wurde ersetzt durch eindeutiges <b>+</b> oder <b>‚àí</b>.</div>'));
  var cfg={preset:"blue"}; for(var k in PRESETS_MENTAL.blue){ cfg[k]=PRESETS_MENTAL.blue[k]; } cfg.auto=true;
  var panel=card(); panel.appendChild(formRow([
    selectField("Preset", Object.entries(PRESETS_MENTAL).map(function(x){return [x[0],x[1].label];}), function(v){ var p=PRESETS_MENTAL[v]; cfg.preset=v; for(var k in p){ cfg[k]=p[k]; } } , cfg.preset),
    numberField("Fragen",5,200,1,cfg.n,function(v){cfg.n=v;}),
    numberField("Zeit (s)",60,1800,10,cfg.seconds,function(v){cfg.seconds=v;}),
    selectField("Bewertung", [["plusminus","+1 richtig, -1 falsch"],["pluszero","+1 richtig, 0 falsch"]], function(val){ cfg.scoring = (val==="plusminus")?{correct:+1,wrong:-1,skip:0}:{correct:+1,wrong:0,skip:0}; }, "plusminus"),
    numberField("Zielwert (Ready=100%)",1,200,1,cfg.target,function(v){cfg.target=v;}),
    checkboxField("Auto-Advance", cfg.auto, function(v){cfg.auto=v;}),
    btn("Start", function(){run();})
  ])); root.appendChild(panel); root.appendChild(highCard("mental"));

  function genQ(){
    var r=function(a,b){return Math.floor(Math.random()*(b-a+1))+a}; var pick=function(a){return a[Math.floor(Math.random()*a.length)]};
    var types=["nestedDiv","mulAdd","addMul","quick","mul"]; var t=pick(types);
    var a,b,c,ans,txt,sign;
    if(t==="nestedDiv"){ c=r(2,15); b=r(2,300); var inner=Math.max(1,Math.floor(b/c)); var k=r(2,80); a=inner*k; ans=a/inner; txt=a+" / ("+b+" / "+c+")"; }
    else if(t==="mulAdd"){ a=r(10,900); b=r(2,99); c=r(3,300); ans=a*b+c; txt=a+" √ó "+b+" + "+c; }
    else if(t==="addMul"){ a=r(10,900); b=r(2,99); c=r(3,300); ans=a+b*c; txt=a+" + "+b+" √ó "+c; }
    else if(t==="quick"){ a=r(200,2000); b=r(50,600); sign = Math.random()<0.5?"+":"‚àí"; ans = (sign==="+")? a+b : a-b; txt=a+" "+sign+" "+b; }
    else { a=r(12,99); b=r(12,99); ans=a*b; txt=a+" √ó "+b; }
    return {t:t,a:a,b:b,c:c,sign:sign,ans:ans,txt:txt};
  }
  function sigOf(q){ return q.t+"|"+q.a+"|"+q.b+"|"+(q.c||0)+"|"+(q.sign||""); }

  function run(){
    var totalMs=cfg.seconds*1000;
    var ui=card(); root.appendChild(ui);
    ui.innerHTML = '      <div class="row" style="justify-content:space-between;align-items:center">        <span class="pill">Preset: '+(get(PRESETS_MENTAL,cfg.preset+".label","custom"))+'</span>        <span class="pill">Zeit: <span id="t" class="timer"></span></span>        <span class="pill">Frage: <b id="qc">1</b> / '+cfg.n+'</span>      </div>      <div class="question" id="q"></div>      <div class="row">        <div style="flex:1"><label>Antwort</label><input id="a" inputmode="decimal" placeholder="Zahl"></div>        <button class="btn" id="ok">OK</button>        <button class="btn ghost" id="skip">Skip</button>        <button class="btn ghost" id="pause">Pause</button>        <button class="btn danger" id="abort">Abbrechen</button>      </div>      <div class="muted" id="info"></div>';

    var el={t:$("#t",ui),qc:$("#qc",ui),q:$("#q",ui),a:$("#a",ui),ok:$("#ok",ui),skip:$("#skip",ui),pause:$("#pause",ui),abort:$("#abort",ui),info:$("#info",ui)};
    var i=0, correct=0, score=0, per=[], cur=null;
    var paused=false, pauseT=0, tStart=performance.now(), tPause=0, running=true, qStart=now();

    function tick(){ var tNow=performance.now(); if(paused) tNow=tPause;
      var used=tNow-tStart-pauseT; var left=Math.max(0,totalMs-used);
      el.t.textContent=(left/1000).toFixed(1)+"s"; if(left<=0&&running){finish();return;} if(running) requestAnimationFrame(tick);
    }
    function next(){
      if(i>=cfg.n){ finish(); return; }
      cur = dedupFindNew("mental", genQ, sigOf);
      el.q.textContent = cur.txt+" = ?"; el.a.value=""; el.a.focus(); el.qc.textContent = String(i+1);
      el.info.textContent = "Bewertung: +"+cfg.scoring.correct+" / "+(cfg.scoring.wrong>=0?"+":"")+cfg.scoring.wrong;
      qStart=now();
    }
    function submit(kind){
      var ms=Math.round(now()-qStart);
      var raw=el.a.value.trim(); var user=(kind==="skip"||raw==="")?null:Number(raw.replace(",", "."));
      var ok = (user!==null && Math.abs(user-cur.ans)<1e-9); if(ok) correct++;
      var delta = ok? cfg.scoring.correct : (user===null? cfg.scoring.skip : cfg.scoring.wrong); score += delta;
      per.push({q:cur.txt, user:user, ans:cur.ans, correct:ok, ms:ms});
      i++; next();
    }
    function pause(){ if(!paused){paused=true; tPause=performance.now(); el.pause.textContent="Resume";} else {paused=false; pauseT += performance.now()-tPause; el.pause.textContent="Pause"; requestAnimationFrame(tick);} }
    function abort(){ if(confirm("Ohne Speichern beenden?")){ running=false; ui.innerHTML='<div class="card">Abgebrochen ‚Äì nicht gespeichert.</div>'; } }
    function finish(){
      running=false; var avg = per.length? Math.round(per.reduce(function(a,x){return a+x.ms;},0)/per.length):0;
      var stats={correct:correct,total:cfg.n,avgMs:avg,score:score};
      var target = cfg.target || cfg.n; var readiness = clamp(Math.round((Math.max(score,correct)/target)*100),0,200);
      pushSession({module:"mental",preset:cfg.preset,stats:stats,perQuestion:per,settings:(function(o){var r={}; for(var k in cfg){ r[k]=cfg[k]; } return r;})({})});
      var rows=[["#","question","your","correct","ms"]]; per.forEach(function(x,j){rows.push([j+1,x.q,(x.user==null?"":x.user),x.ans,x.ms]);});
      var csv = rows.map(function(r){return r.map(function(v){return '"'+String(v).replace(/"/g,'""')+'"';}).join(",");}).join("
");
      var txt = per.map(function(x,j){return (j+1)+". "+x.q+" | your="+(x.user==null?"":x.user)+" | correct="+x.ans+" | "+(x.correct?"OK":"X")+" | "+x.ms+"ms";}).join("
");
      ui.innerHTML = '<h3>Ergebnis</h3>        <div class="row">          <span class="pill">Richtig: <b class="ok">'+stats.correct+'</b> / '+stats.total+'</span>          <span class="pill">Score: <b>'+stats.score+'</b></span>          <span class="pill">√ò Zeit: <b>'+fmtMs(stats.avgMs)+'</b></span>          <span class="pill">Ziel: <b>'+target+'</b></span>          <span class="pill">Ready: <b>'+readiness+'%</b></span>        </div>        <div class="row"><button class="btn" id="dlCsv">Download CSV</button><button class="btn ghost" id="dlTxt">Download TXT</button></div>';
      $("#dlCsv").onclick=function(){ download("mental_"+new Date().toISOString().replace(/[:.]/g,'-')+".csv", csv, "text/csv"); };
      $("#dlTxt").onclick=function(){ download("mental_"+new Date().toISOString().replace(/[:.]/g,'-')+".txt", txt, "text/plain"); };
      render();
    }

    el.ok.onclick=function(){submit("ok")}; el.skip.onclick=function(){submit("skip")}; el.pause.onclick=pause; el.abort.onclick=abort;
    el.a.addEventListener("keydown", function(e){ if(e.key==="Enter") submit("ok"); });
    el.a.addEventListener("input", function(){ if(!cfg.auto) return; var raw=el.a.value.trim(); if(!raw) return; var v=Number(raw.replace(",", ".")); if(cur && typeof cur.ans==="number" && Math.abs(v - cur.ans)<1e-9) submit("ok"); });
    requestAnimationFrame(tick); next();
  }
}

