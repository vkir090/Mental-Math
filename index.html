<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Quant Prep Trainer v3 (Single File)</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<style>
:root{--bg:#0f1220;--panel:#151936;--accent:#7bd88f;--accent2:#8bd3ff;--text:#eef1ff;--muted:#a8b0d3;--danger:#ff6b6b;--warn:#ffd166}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);background:radial-gradient(1000px 600px at 10% -10%, #1a1f45 0%, #0f1220 60%)}
header{position:sticky;top:0;z-index:5;backdrop-filter:blur(8px);background:rgba(15,18,32,.72);border-bottom:1px solid #232955;padding:12px 16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
h1{margin:0;font-size:18px;letter-spacing:.3px}
nav{display:flex;gap:8px;flex-wrap:wrap}
nav button{background:var(--panel);color:var(--text);border:1px solid #232955;padding:8px 12px;border-radius:10px;cursor:pointer}
nav button.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(123,216,143,.25) inset}
main{padding:16px;max-width:1100px;margin:0 auto}
.card{background:linear-gradient(180deg,#161a3a 0%,#10142c 100%);border:1px solid #232955;border-radius:14px;padding:16px;margin:10px 0;box-shadow:0 8px 24px rgba(0,0,0,.25)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
.grid{display:grid;gap:12px}.grid.cols-2{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input,select{width:100%;background:#0c1030;color:var(--text);border:1px solid #232955;padding:10px 12px;border-radius:10px;outline:none}
.btn{background:var(--accent);color:#0a1320;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
.btn.secondary{background:var(--accent2)}.btn.ghost{background:transparent;color:var(--text);border:1px solid #2a316a}.btn.danger{background:var(--danger);color:white}
.pill{padding:6px 10px;border:1px solid #2a316a;border-radius:999px;color:var(--muted)}
.question{font-size:26px;margin:8px 0 12px}
.timer{font-variant-numeric:tabular-nums}
table{width:100%;border-collapse:collapse;font-variant-numeric:tabular-nums}th,td{padding:8px 10px;border-bottom:1px solid #232955}
tr:hover td{background:#101536}
.kbd{background:#0c1030;border:1px solid #232955;border-radius:6px;padding:2px 6px}
.center{text-align:center}.muted{color:var(--muted)}
.fullfocus{position:fixed;inset:0;padding:16px;background:rgba(5,7,18,.85);backdrop-filter:blur(4px);display:none;z-index:99}
.fullfocus.show{display:block}
.linklike{color:var(--accent2);cursor:pointer;text-decoration:underline}
</style>
</head>
<body>
<header>
  <h1>üßÆ Quant Prep Trainer v3</h1>
  <nav id="tabs"></nav>
  <div style="margin-left:auto"></div>
  <button class="btn ghost" id="exportJson">Export JSON</button>
  <button class="btn ghost" id="exportCsv">Export CSV</button>
  <button class="btn ghost" id="reset">Reset</button>
</header>
<main id="app"></main>
<div id="focus" class="fullfocus"></div>
<script>
// ===== Utils
const $=(s,e=document)=>e.querySelector(s); const $$=(s,e=document)=>Array.from(e.querySelectorAll(s));
const now=()=>performance.now(); const clamp=(x,a,b)=>Math.max(a,Math.min(b,x)); const fmtMs=ms=>((ms||0)/1000).toFixed(2)+"s";
function dl(name, data, type){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([data],{type}));a.download=name;a.click();URL.revokeObjectURL(a.href);}
function getLocal(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch(_){return d}}; function setLocal(k,v){localStorage.setItem(k,JSON.stringify(v))}

// ===== Persistence
const DBKEY="qprep_v3_db"; const DEDUPKEY="qprep_v3_dedup";
let DB=getLocal(DBKEY,{sessions:[],highscores:{}}); let DEDUP=getLocal(DEDUPKEY,{});
function saveDB(){setLocal(DBKEY,DB)} function saveDedup(){setLocal(DEDUPKEY,DEDUP)}
function pushSession(entry){DB.sessions.push({...entry,date:new Date().toISOString()}); const m=entry.module; const sc=entry.stats?.score||0; if(!DB.highscores[m]||sc>DB.highscores[m].score){DB.highscores[m]={score:sc,when:new Date().toISOString(),detail:entry.stats}}; saveDB()}
function dedupInit(id){if(!DEDUP[id]) DEDUP[id]={set:{},list:[]}}
function dedupHas(id,s){dedupInit(id); return !!DEDUP[id].set[s]}
function dedupAdd(id,s,cap=50000){dedupInit(id); if(!DEDUP[id].set[s]){DEDUP[id].set[s]=1;DEDUP[id].list.push(s); if(DEDUP[id].list.length>cap){const old=DEDUP[id].list.shift(); delete DEDUP[id].set[old]} saveDedup()}}
function dedupFind(id,gen,sig,max=250){for(let i=0;i<max;i++){const item=gen(); const sigv=sig(item); if(!dedupHas(id,sigv)){dedupAdd(id,sigv); return item}} return gen()}

// ===== App shell
const modules=[
  {id:"mental", title:"Mental Math", view:viewMental},
  {id:"seq", title:"Sequences", view:viewSeq},
  {id:"task", title:"Task Switch", view:viewTask},
  {id:"pin", title:"Pincode (3√ó1min)", view:viewPin},
  {id:"mm", title:"Market Making", view:viewMM},
  {id:"brain", title:"Brainteasers & Fermi", view:viewBrain},
  {id:"stats", title:"Statistik", view:viewStats},
  {id:"settings", title:"Einstellungen", view:viewSettings}
];
let currentTab=localStorage.getItem("qprep_tab")||"seq";
function renderTabs(){const nav=$("#tabs"); nav.innerHTML=""; modules.forEach(m=>{const b=document.createElement("button"); b.textContent=m.title; b.className=currentTab===m.id?"active":""; b.onclick=()=>{currentTab=m.id; localStorage.setItem("qprep_tab",m.id); render()}; nav.appendChild(b)});}
function render(){renderTabs(); const root=$("#app"); root.innerHTML=""; (modules.find(x=>x.id===currentTab)||modules[0]).view(root)}; render();
$("#exportJson").onclick=()=>dl("qprep.json",JSON.stringify(DB,null,2),"application/json");
$("#exportCsv").onclick=()=>{const rows=[["module","date","score","correct","total","avgMs","detail","settings"]]; for(const s of DB.sessions){rows.push([s.module,s.date,s.stats?.score??"",s.stats?.correct??"",s.stats?.total??"",s.stats?.avgMs??"",JSON.stringify(s.perQuestion||[]),JSON.stringify(s.settings||{})])} dl("qprep.csv",rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n"),"text/csv")};
$("#reset").onclick=()=>{if(confirm("Alle lokalen Daten l√∂schen?")){localStorage.removeItem(DBKEY); localStorage.removeItem(DEDUPKEY); DB={sessions:[],highscores:{}}; DEDUP={}; render()}};

// ===== Common UI bits
function card(html){const d=document.createElement("div"); d.className="card"; d.innerHTML=html||""; return d}
function formRow(items){const r=document.createElement("div"); r.className="row grid cols-2"; items.forEach(x=>r.appendChild(x)); return r}
function btn(label,onClick,cls){const b=document.createElement("button"); b.className=cls||"btn"; b.textContent=label; b.onclick=onClick; return b}
function numberField(label,min,max,step,value,onInput,allowFloat){const w=document.createElement("div"); const id="n"+Math.random().toString(36).slice(2); w.innerHTML='<label for="'+id+'">'+label+'</label><input id="'+id+'" '+(allowFloat?'':'inputmode="numeric"')+' type="number" min="'+min+'" max="'+max+'" step="'+step+'" value="'+value+'">'; const el=$("input",w); el.addEventListener("input",e=>onInput(allowFloat?parseFloat(e.target.value):parseInt(e.target.value))); return w}
function selectField(label,options,onChange,value){const w=document.createElement("div"); const id="s"+Math.random().toString(36).slice(2); w.innerHTML='<label for="'+id+'">'+label+'</label><select id="'+id+'">'+options.map(o=>'<option value="'+o[0]+'">'+o[1]+'</option>').join('')+'</select>'; const el=$("select",w); el.value=value; el.addEventListener("change",e=>onChange(e.target.value)); return w}
function checkboxField(label,checked,onChange){const w=document.createElement("div"); const id="c"+Math.random().toString(36).slice(2); w.innerHTML='<label><input id="'+id+'" type="checkbox" '+(checked?'checked':'')+'> '+label+'</label>'; $("#"+id,w).addEventListener("change",e=>onChange(e.target.checked)); return w}
function table(rows, headers){return '<table><thead><tr>'+headers.map(h=>'<th>'+h+'</th>').join('')+'</tr></thead><tbody>'+rows.map(r=>'<tr>'+r.map(c=>'<td>'+String(c??'').replace(/[<>&]/g,s=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]))+'</td>').join('')+'</tr>').join('')+'</tbody></table>'}
function highCard(mod){const el=card('<h3>üèÜ Highscore</h3>'); const best=DB.highscores[mod]; el.insertAdjacentHTML("beforeend",best?('<div class="pill">Score: <b>'+best.score+'</b> ¬∑ '+new Date(best.when).toLocaleString()+'</div>'):'<div class="muted">Noch kein Highscore.</div>'); return el}
function showFocus(inner){const f=$("#focus"); f.innerHTML=''; f.appendChild(inner); f.classList.add("show"); const close=()=>f.classList.remove("show"); f.onclick=(e)=>{ if(e.target===f) close() }; return {close}}

// ===== Presets / targets
const PRESETS_MENTAL={ blue:{label:"Blue ‚Äì Akuna (80/8)", n:80, seconds:480, scoring:{correct:1,wrong:-1,skip:0}, target:60}, brown:{label:"Brown ‚Äì Maven (40/6)", n:40, seconds:360, scoring:{correct:1,wrong:0,skip:0}, target:34}, red:{label:"Red ‚Äì Flow (75/8)", n:75, seconds:480, scoring:{correct:1,wrong:-1,skip:0}, target:53} };

const PRESETS_SEQ={ tradeseq:{label:"TradeSeq (Flow)",n:30,seconds:1080,scoring:{correct:1,wrong:0,skip:0},target:22,weights:{AP:.30,GP:.12,FIBO:.10,GROW:.12,ALT:.10,INTER:.10,QUAD:.08,POW:.05,PRIME:.03}},
  blue:{label:"BlueSeq (Akuna)",n:24,seconds:960,scoring:{correct:1,wrong:0,skip:0},target:18,weights:{AP:.34,GP:.14,FIBO:.12,GROW:.12,ALT:.10,INTER:.08,QUAD:.06,POW:.04,PRIME:.02}},
  brown:{label:"BrownSeq (Maven)",n:26,seconds:900,scoring:{correct:1,wrong:0,skip:0},target:22,weights:{AP:.32,GP:.12,FIBO:.10,GROW:.12,ALT:.10,INTER:.10,QUAD:.08,POW:.04,PRIME:.02}}
};

// ===== Mental Math
function viewMental(root){
  root.appendChild(card('<h2>üßÆ Mental Math</h2><div class="muted">Auto-Advance bei korrekter Eingabe. Pause/Resume. Abbrechen speichert nicht. ‚Äû¬±‚Äú-Aufgaben zeigen nun explizit das Vorzeichen.</div>'));
  const cfg={preset:'blue',...PRESETS_MENTAL.blue,auto:true};
  const panel=card(); panel.appendChild(formRow([
    selectField('Preset',Object.entries(PRESETS_MENTAL).map(([k,p])=>[k,p.label]),v=>Object.assign(cfg,{preset:v,...PRESETS_MENTAL[v]}),cfg.preset),
    numberField('Fragen',5,200,1,cfg.n,v=>cfg.n=v),
    numberField('Zeit (s)',60,1800,10,cfg.seconds,v=>cfg.seconds=v),
    selectField('Bewertung',[['+1/-1','+1 richtig, -1 falsch'],['+1/0','+1 richtig, 0 falsch']],val=>{cfg.scoring=(val==='+1/-1')?{correct:1,wrong:-1,skip:0}:{correct:1,wrong:0,skip:0}},'+1/-1'),
    numberField('Ziel (Ready=100%)',1,200,1,cfg.target,v=>cfg.target=v),
    checkboxField('Auto-Advance',cfg.auto,v=>cfg.auto=v),
    btn('Start',()=>run())
  ])); root.appendChild(panel); root.appendChild(highCard('mental'));

  function genQ(){function r(a,b){return Math.floor(Math.random()*(b-a+1))+a} function pick(a){return a[Math.floor(Math.random()*a.length)]}
    const t=pick(['nestedDiv','mulAdd','addMul','quick','mul']); let a,b,c,ans,txt;
    if(t==='nestedDiv'){c=r(2,15); b=r(2,300); const inner=Math.max(1,Math.floor(b/c)); const k=r(2,80); a=inner*k; ans=a/inner; txt=a+' / ('+b+' / '+c+')'}
    else if(t==='mulAdd'){a=r(10,900); b=r(2,99); c=r(3,300); ans=a*b+c; txt=a+' √ó '+b+' + '+c}
    else if(t==='addMul'){a=r(10,900); b=r(2,99); c=r(3,300); ans=a+b*c; txt=a+' + '+b+' √ó '+c}
    else if(t==='quick'){a=r(200,2000); b=r(50,600); const plus=Math.random()<.5; ans=plus?a+b:a-b; txt=a+' '+(plus?'+':'‚àí')+' '+b}
    else {a=r(12,99); b=r(12,99); ans=a*b; txt=a+' √ó '+b}
    return {t,a,b,c,ans,txt}
  }
  function sigOf(q){return q.t+'|'+q.a+'|'+q.b+'|'+(q.c||0)}

  function run(){
    const total=cfg.seconds*1000; const ui=card(); root.appendChild(ui);
    ui.innerHTML='<div class="row" style="justify-content:space-between;align-items:center"><span class="pill">Preset: '+(PRESETS_MENTAL[cfg.preset]?.label||'custom')+'</span><span class="pill">Zeit: <span id="t" class="timer"></span></span><span class="pill">Frage: <b id="qc">1</b> / '+cfg.n+'</span></div><div class="question" id="q"></div><div class="row"><div style="flex:1"><label>Antwort</label><div class="row"><input id="a" inputmode="decimal" placeholder="Zahl"><button class="btn ghost" id="minus">‚àí</button></div></div><button class="btn" id="ok">OK</button><button class="btn ghost" id="skip">Skip</button><button class="btn ghost" id="pause">Pause</button><button class="btn danger" id="abort">Abbrechen</button></div><div class="muted" id="info"></div>';
    const el={t:$("#t",ui),qc:$("#qc",ui),q:$("#q",ui),a:$("#a",ui),minus:$("#minus",ui),ok:$("#ok",ui),skip:$("#skip",ui),pause:$("#pause",ui),abort:$("#abort",ui),info:$("#info",ui)};
    let i=0,correct=0,score=0,per=[],cur=null; let paused=false,tStart=performance.now(),tPause=0,pauseAcc=0,running=true,qStart=now();
    function tick(){let tNow=performance.now(); if(paused)tNow=tPause; const used=tNow-tStart-pauseAcc; const left=Math.max(0,total-used); el.t.textContent=(left/1000).toFixed(1)+'s'; if(left<=0&&running){finish();return} if(running) requestAnimationFrame(tick)}
    function next(){if(i>=cfg.n){finish();return} cur=dedupFind('mental',genQ,sigOf); el.q.textContent=cur.txt+' = ?'; el.a.value=''; el.a.focus(); el.qc.textContent=String(i+1); el.info.textContent='Bewertung: +'+cfg.scoring.correct+' / '+(cfg.scoring.wrong>=0?'+':'')+cfg.scoring.wrong; qStart=now()}
    function submit(kind){const ms=Math.round(now()-qStart); const raw=el.a.value.trim(); const user=(kind==='skip'||raw==='')?null:Number(raw.replace(',','.')); const ok=(user!==null && Math.abs(user-cur.ans)<1e-9); if(ok) correct++; const delta= ok?cfg.scoring.correct : (user===null? cfg.scoring.skip : cfg.scoring.wrong); score+=delta; per.push({q:cur.txt,user,ans:cur.ans,correct:ok,ms,kind:(user===null?'skip':'answer')}); i++; next()}
    function pause(){ if(!paused){paused=true;tPause=performance.now(); el.pause.textContent='Resume'} else {paused=false; pauseAcc+=performance.now()-tPause; el.pause.textContent='Pause'; requestAnimationFrame(tick)}}
    function abort(){ if(confirm('Ohne Speichern beenden?')){ running=false; ui.innerHTML='<div class="card">Abgebrochen ‚Äì nicht gespeichert.</div>' } }
    function finish(){running=false; const avg=per.length?Math.round(per.reduce((a,x)=>a+x.ms,0)/per.length):0; const stats={correct,total:cfg.n,avgMs:avg,score}; const target=cfg.target||cfg.n; const readiness=clamp(Math.round((Math.max(score,correct)/target)*100),0,200); pushSession({module:'mental',preset:cfg.preset,stats,perQuestion:per,settings:{...cfg}}); const rows=[['#','question','your','correct','ms']]; per.forEach((x,j)=>rows.push([j+1,x.q,x.user==null?'':x.user,x.ans,x.ms])); const csv=rows.map(r=>r.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n'); const txt=per.map((x,j)=> (j+1)+'. '+x.q+' | your='+(x.user==null?'':x.user)+' | correct='+x.ans+' | '+(x.correct?'OK':'X')+' | '+x.ms+'ms').join('\n'); ui.innerHTML='<h3>Ergebnis</h3><div class="row"><span class="pill">Richtig: <b class="ok">'+stats.correct+'</b> / '+stats.total+'</span><span class="pill">Score: <b>'+stats.score+'</b></span><span class="pill">√ò Zeit: <b>'+fmtMs(stats.avgMs)+'</b></span><span class="pill">Ziel: <b>'+target+'</b></span><span class="pill">Ready: <b>'+readiness+'%</b></span></div><div class="row"><button class="btn" id="dlCsv">Download CSV</button><button class="btn ghost" id="dlTxt">Download TXT</button></div>'+table(per.map((x,idx)=>[idx+1,x.q,x.user==null?'‚Äî':x.user,x.ans,(x.ms/1000).toFixed(2)+'s',x.correct?'‚úÖ':'‚ùå']),['#','Frage','Deine','Korrekt','Zeit','OK']); $("#dlCsv",ui).onclick=()=>dl('mental_'+new Date().toISOString().replace(/[:.]/g,'-')+'.csv',csv,'text/csv'); $("#dlTxt",ui).onclick=()=>dl('mental_'+new Date().toISOString().replace(/[:.]/g,'-')+'.txt',txt,'text/plain'); render();}
    el.ok.onclick=()=>submit('ok'); el.skip.onclick=()=>submit('skip'); el.pause.onclick=pause; el.abort.onclick=abort; el.minus.onclick=()=>{if(!el.a.value.startsWith('-')) el.a.value='-'+el.a.value; el.a.focus()}; el.a.addEventListener('keydown',e=>{if(e.key==='Enter') submit('ok')}); el.a.addEventListener('input',()=>{if(!cfg.auto) return; const raw=el.a.value.trim(); if(!raw) return; const v=Number(raw.replace(',','.')); if(Math.abs(v-(cur?.ans||NaN))<1e-9) submit('ok')}); requestAnimationFrame(tick); next()
  }
}

// ===== Sequences (new engine)
function viewSeq(root){
  root.appendChild(card('<h2>üîó Sequences</h2><div class="muted">Realistische Presets (Flow/Akuna/Maven). 5 Terme ‚Üí n√§chster Term. Integer-only standardm√§√üig. Keine Negativpunkte; Skips ohne Malus. Dedup pro Pattern; Timer mit Ampel.</div>'));
  const cfg={preset:'tradeseq',...PRESETS_SEQ.tradeseq};
  const panel=card(); panel.appendChild(formRow([
    selectField('Preset',Object.entries(PRESETS_SEQ).map(([k,p])=>[k,p.label]),v=>Object.assign(cfg,{preset:v,...PRESETS_SEQ[v]}),cfg.preset),
    numberField('Fragen',5,60,1,cfg.n,v=>cfg.n=v),
    numberField('Zeit (s)',60,3600,10,cfg.seconds,v=>cfg.seconds=v),
    numberField('Ziel (Ready=100%)',1,60,1,cfg.target,v=>cfg.target=v),
    btn('Start',()=>run())
  ])); root.appendChild(panel); root.appendChild(highCard('seq'));

  function rand(a,b){return Math.floor(Math.random()*(b-a+1))+a}
  function pick(arr){return arr[Math.floor(Math.random()*arr.length)]}
  function weightPick(weights){const keys=Object.keys(weights); const s=keys.reduce((t,k)=>t+weights[k],0); let r=Math.random()*s; for(const k of keys){r-=weights[k]; if(r<=0) return k} return keys[0]}

  function genItem(idx){
    // difficulty scaling
    const n=cfg.n; const tier = (idx < n/3) ? 'easy' : (idx < 2*n/3 ? 'mid':'hard');
    const ranges = tier==='easy'? {startMax:100, stepMax:10, factorMax:3, absMax:500}
                 : tier==='mid' ? {startMax:500, stepMax:25, factorMax:4, absMax:5000}
                                 : {startMax:1000, stepMax:50, factorMax:5, absMax:10000};
    const pat = weightPick(cfg.weights);
    let seq=[], next, sig='';

    function clampInt(x){x=Math.round(x); if(Math.abs(x)>ranges.absMax) x = Math.sign(x)*ranges.absMax; return x}

    if(pat==='AP'){ const a0=rand(-ranges.startMax,ranges.startMax); const d=rand(-ranges.stepMax,ranges.stepMax)||1; seq=[a0]; for(let i=1;i<5;i++) seq.push(clampInt(seq[i-1]+d)); next=clampInt(seq[4]+d); sig='AP|'+a0+'|'+d; }
    else if(pat==='GP'){ const a0=rand(1,Math.max(3,ranges.startMax)); const sign = Math.random()<0.15?-1:1; const r=sign*rand(2,Math.max(2,ranges.factorMax)); seq=[a0]; for(let i=1;i<5;i++) seq.push(clampInt(seq[i-1]*r)); next=clampInt(seq[4]*r); sig='GP|'+a0+'|'+r; }
    else if(pat==='FIBO'){ const a0=rand(0,10), a1=rand(1,10); const off=rand(-5,5); seq=[a0,a1]; for(let i=2;i<5;i++) seq.push(clampInt(seq[i-1]+seq[i-2]+off)); next=clampInt(seq[3]+seq[4]+off); sig='FIBO|'+a0+'|'+a1+'|'+off; }
    else if(pat==='GROW'){ let d0=rand(1,Math.max(2,ranges.stepMax/4)), delta=rand(1,Math.max(2,ranges.stepMax/6)); const a0=rand(-ranges.startMax,ranges.startMax); seq=[a0]; let d=d0; for(let i=1;i<5;i++){ seq.push(clampInt(seq[i-1]+d)); d+=delta } next=clampInt(seq[4]+d); sig='GROW|'+a0+'|'+d0+'|'+delta; }
    else if(pat==='ALT'){ const p=rand(2,ranges.stepMax), q=rand(2,ranges.stepMax); const a0=rand(-ranges.startMax,ranges.startMax); seq=[a0]; let add=true; for(let i=1;i<5;i++){ seq.push(clampInt(seq[i-1]+(add?p:-q))); add=!add } next=clampInt(seq[4]+(add?p:-q)); sig='ALT|'+a0+'|'+p+'|'+q; }
    else if(pat==='INTER'){ const a0=rand(-ranges.startMax,ranges.startMax); const d=rand(-ranges.stepMax,ranges.stepMax)||1; const b0=rand(1,Math.max(3,ranges.startMax)); const r=rand(2,Math.max(2,ranges.factorMax)); seq=[]; for(let i=0;i<5;i++){ if(i%2===0){ if(seq.length===0) seq.push(a0); else seq.push(clampInt(seq[i-2]+d)) } else { if(i===1) seq.push(b0); else seq.push(clampInt(seq[i-2]*r)) } } next = (5%2===0)? clampInt(seq[3]+d) : clampInt(seq[3]*r); sig='INTER|'+a0+'|'+d+'|'+b0+'|'+r; }
    else if(pat==='QUAD'){ const a=pick([1,2,3,-1,-2]); const b=rand(-5,5); const c=rand(-10,10); seq=[]; for(let i=0;i<5;i++){ seq.push(clampInt(a*i*i+b*i+c)) } next=clampInt(a*25+b*5+c); sig='QUAD|'+a+'|'+b+'|'+c; }
    else if(pat==='POW'){ const k=rand(-5,5); const useCube=Math.random()<0.4; seq=[]; for(let i=1;i<=5;i++){ const v=useCube? (i*i*i+k):(i*i+k); seq.push(clampInt(v)) } next=clampInt((useCube?216:36)+k); sig='POW|'+k+'|'+(useCube?'3':'2'); }
    else { // PRIME
      function isPrime(x){if(x<2)return false; for(let i=2;i*i<=x;i++) if(x%i===0) return false; return true}
      const primes=[]; for(let v=2;primes.length<20;v++) if(isPrime(v)) primes.push(v);
      let a0=rand(0,ranges.startMax); seq=[a0]; for(let i=1;i<5;i++){ const p=primes[i%primes.length]; seq.push(clampInt(seq[i-1]+p)) } next=clampInt(seq[4]+primes[5%primes.length]); sig='PRIME|'+a0;
    }
    return {seq,next,sig,pat}
  }

  function run(){
    const total=cfg.seconds*1000; const ui=card(); root.appendChild(ui);
    ui.innerHTML='<div class="row" style="justify-content:space-between;align-items:center"><span class="pill">Preset: '+PRESETS_SEQ[cfg.preset].label+'</span><span class="pill">Zeit: <span id="t" class="timer"></span></span><span class="pill">Frage: <b id="qc">1</b> / '+cfg.n+'</span><span class="pill" id="ampel"></span></div><div class="question" id="q"></div><div class="row"><div style="flex:1"><label>N√§chstes Element</label><div class="row"><input id="a" inputmode="decimal"><button class="btn ghost" id="minus">‚àí</button></div></div><button class="btn" id="ok">OK</button><button class="btn ghost" id="skip">Skip</button><button class="btn ghost" id="pause">Pause</button><button class="btn danger" id="abort">Abbrechen</button></div>';
    const el={t:$("#t",ui),ampel:$("#ampel",ui),qc:$("#qc",ui),q:$("#q",ui),a:$("#a",ui),minus:$("#minus",ui),ok:$("#ok",ui),skip:$("#skip",ui),pause:$("#pause",ui),abort:$("#abort",ui)};
    let i=0,correct=0,per=[],cur=null; let paused=false,tStart=performance.now(),tPause=0,pauseAcc=0,running=true,qStart=now();
    function tick(){let tNow=performance.now(); if(paused)tNow=tPause; const used=tNow-tStart-pauseAcc; const left=Math.max(0,total-used); el.t.textContent=(left/1000).toFixed(1)+'s'; const p=used/total; el.ampel.textContent = p<.5?'üü¢':(p<.85?'üü°':'üî¥'); if(left<=0&&running){finish();return} if(running) requestAnimationFrame(tick)}
    function next(){ if(i>=cfg.n){finish();return} const item = dedupFind('seq',()=>genItem(i),(x)=>x.sig); cur=item; el.q.textContent = item.seq.join(' , ')+' , ?'; el.a.value=''; el.a.focus(); el.qc.textContent=String(i+1); qStart=now() }
    function submit(kind){ const ms=Math.round(now()-qStart); const raw=el.a.value.trim(); const user=(kind==='skip'||raw==='')?null:Number(raw.replace(',','.')); const ok=(user!==null && Math.abs(user-cur.next)<1e-9); if(ok) correct++; per.push({q:cur.seq.join(', '), user, ans:cur.next, correct:ok, ms, kind:(user===null?'skip':'answer'), pat:cur.pat}); i++; next(); }
    function pause(){ if(!paused){paused=true;tPause=performance.now(); el.pause.textContent='Resume'} else {paused=false; pauseAcc+=performance.now()-tPause; el.pause.textContent='Pause'; requestAnimationFrame(tick)} }
    function abort(){ if(confirm('Ohne Speichern beenden?')){ running=false; ui.innerHTML='<div class="card">Abgebrochen ‚Äì nicht gespeichert.</div>' } }
    function finish(){ running=false; const avg=per.length?Math.round(per.reduce((a,x)=>a+x.ms,0)/per.length):0; const stats={correct,total:cfg.n,avgMs:avg,score:correct}; const readiness=clamp(Math.round((stats.correct/(cfg.target||cfg.n))*100),0,200); pushSession({module:'seq',preset:cfg.preset,stats,perQuestion:per,settings:{...cfg}}); const rows=[['#','sequence','your','correct','ms','ok','pattern']]; per.forEach((x,j)=>rows.push([j+1,x.q,x.user==null?'':x.user,x.ans,x.ms,x.correct?1:0,x.pat])); const csv=rows.map(r=>r.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n'); const txt=per.map((x,j)=>(j+1)+'. ['+x.q+'] -> your='+(x.user==null?'':x.user)+' | correct='+x.ans+' | '+(x.correct?'OK':'X')+' | '+x.ms+'ms').join('\n'); ui.innerHTML='<h3>Ergebnis</h3><div class="row"><span class="pill">Richtig: <b class="ok">'+stats.correct+'</b> / '+cfg.n+'</span><span class="pill">√ò Zeit: <b>'+fmtMs(avg)+'</b></span><span class="pill">Ready: <b>'+readiness+'%</b></span></div><div class="row"><button class="btn" id="dlCsv">Download CSV</button><button class="btn ghost" id="dlTxt">Download TXT</button></div>'+table(per.map((x,idx)=>[idx+1,x.q,x.user==null?'‚Äî':x.user,x.ans,(x.ms/1000).toFixed(2)+'s',x.correct?'‚úÖ':'‚ùå',x.pat]),['#','Sequenz','Deine','Korrekt','Zeit','OK','Pattern']); $("#dlCsv",ui).onclick=()=>dl('seq_'+new Date().toISOString().replace(/[:.]/g,'-')+'.csv',csv,'text/csv'); $("#dlTxt",ui).onclick=()=>dl('seq_'+new Date().toISOString().replace(/[:.]/g,'-')+'.txt',txt,'text/plain'); render(); }
    el.ok.onclick=()=>submit('ok'); el.skip.onclick=()=>submit('skip'); el.pause.onclick=pause; el.abort.onclick=abort; el.minus.onclick=()=>{if(!el.a.value.startsWith('-')) el.a.value='-'+el.a.value; el.a.focus()}; el.a.addEventListener('keydown',e=>{if(e.key==='Enter') submit('ok')}); requestAnimationFrame(tick); next();
  }
}

// ===== Task Switch (compact)
function viewTask(root){
  root.appendChild(card('<h2>üîÅ Task Switch</h2><div class="muted">ARROWS (gleich/verschieden) & PARITY (ungerade/gerade). +1/‚àí1. Pause/Resume.</div>'));
  const cfg={seconds:180,targetNet:25,targetAcc:90};
  const panel=card(); panel.appendChild(formRow([numberField('Zeit (s)',60,600,10,cfg.seconds,v=>cfg.seconds=v),btn('Start',()=>run())])); root.appendChild(panel); root.appendChild(highCard('task'));
  function gen(){const r=(a,b)=>Math.floor(Math.random()*(b-a+1))+a; const task=Math.random()<.5?'ARROWS':'PARITY'; if(task==='ARROWS'){const p=['<<<','>>>','<<>','<>>','><<','>><','<><','><>']; const stim=p[r(0,p.length-1)]; const same=(stim==='<<<'||stim==='>>>'); return {task,stim,correct:same?'SAME':'DIFF'} } else {const a=r(10,99), b=r(2,9), op=Math.random()<.5?'+':'√ó'; const v=op==='+'?a+b:a*b; return {task,stim:(a+' '+op+' '+b),correct:(v%2===1)?'ODD':'EVEN'} } }
  function sig(x){return x.task+'|'+x.stim}
  function run(){const total=cfg.seconds*1000; const ui=card(); root.appendChild(ui);
    ui.innerHTML='<div class="row" style="justify-content:space-between"><span class="pill">Zeit: <span id="t" class="timer"></span></span><span class="pill">Trials: <b id="n">0</b></span><span class="pill">Score: <b id="sc">0</b></span></div><div class="card center"><div class="pill" id="task"></div><div class="question" id="stim" style="font-size:38px;letter-spacing:4px"></div><div class="row center" style="justify-content:center"><button class="btn" id="left">Linke Option</button><button class="btn secondary" id="right">Rechte Option</button></div><div class="muted" id="legend"></div></div><div class="row"><button class="btn ghost" id="pause">Pause</button><button class="btn danger" id="abort">Abbrechen</button></div>';
    const el={t:$("#t",ui),n:$("#n",ui),sc:$("#sc",ui),task:$("#task",ui),stim:$("#stim",ui),left:$("#left",ui),right:$("#right",ui),legend:$("#legend",ui),pause:$("#pause",ui),abort:$("#abort",ui)};
    let paused=false,tStart=performance.now(),tPause=0,pauseAcc=0,running=true; let score=0,n=0,correctN=0,per=[],cur=null,tTrial=now();
    function tick(){let tNow=performance.now(); if(paused)tNow=tPause; const used=tNow-tStart-pauseAcc; const left=Math.max(0,total-used); el.t.textContent=(left/1000).toFixed(1)+'s'; if(left<=0&&running){finish();return} if(running) requestAnimationFrame(tick)}
    function show(){cur=dedupFind('task',gen,sig); el.task.textContent=cur.task==='ARROWS'?'ARROWS ‚Äì gleich (links) / verschieden (rechts)':'PARITY ‚Äì ungerade (links) / gerade (rechts)'; el.legend.textContent=cur.task==='ARROWS'?'W√§hle: Gleich=links ¬∑ Verschieden=rechts':'W√§hle: Ungerade=links ¬∑ Gerade=rechts'; el.stim.textContent=cur.stim; tTrial=now()}
    function ans(which){const ms=Math.round(now()-tTrial); let user = (cur.task==='ARROWS')?(which==='LEFT'?'SAME':'DIFF'):(which==='LEFT'?'ODD':'EVEN'); const ok=(user===cur.correct); if(ok){score+=1;correctN++} else {score-=1} n++; el.sc.textContent=score; el.n.textContent=n; per.push({task:cur.task,stim:cur.stim,correct:cur.correct,user,ok,ms}); show()}
    function pause(){if(!paused){paused=true;tPause=performance.now();el.pause.textContent='Resume'} else {paused=false; pauseAcc+=performance.now()-tPause; el.pause.textContent='Pause'; requestAnimationFrame(tick)}}
    function abort(){ if(confirm('Ohne Speichern beenden?')){ running=false; ui.innerHTML='<div class="card">Abgebrochen ‚Äì nicht gespeichert.</div>' } }
    function finish(){running=false; const acc=n>0?(correctN/n*100):0; const avg=per.length?Math.round(per.reduce((a,x)=>a+x.ms,0)/per.length):0; const stats={correct:correctN,total:n,avgMs:avg,score}; const r1=cfg.targetNet>0?(score/cfg.targetNet):0; const r2=cfg.targetAcc>0?(acc/cfg.targetAcc):0; const ready=clamp(Math.round(Math.min(r1,r2)*100),0,200); pushSession({module:'task',stats,perQuestion:per,settings:{...cfg}}); ui.innerHTML='<h3>Ergebnis</h3><div class="row"><span class="pill">Score: <b>'+score+'</b></span><span class="pill">Accuracy: <b>'+acc.toFixed(1)+'%</b></span><span class="pill">√ò RT: <b>'+fmtMs(avg)+'</b></span><span class="pill">Ready: <b>'+ready+'%</b></span></div>'; render(); }
    el.left.onclick=()=>ans('LEFT'); el.right.onclick=()=>ans('RIGHT'); el.pause.onclick=pause; el.abort.onclick=abort; requestAnimationFrame(tick); show();
  }
}

// ===== Pincode (3√ó1min)
function viewPin(root){
  root.appendChild(card('<h2>üîí Pincode (3√ó1min)</h2><div class="muted">Runde 1: Repeat ¬∑ Runde 2: Reverse ¬∑ Runde 3: Sort. Pause-Zeit wird nicht gez√§hlt.</div>'));
  const cfg={roundSecs:60,target:24}; const panel=card(); panel.appendChild(formRow([numberField('Sek./Runde',30,120,5,cfg.roundSecs,v=>cfg.roundSecs=v),numberField('Ziel gesamt',10,30,1,cfg.target,v=>cfg.target=v),btn('Start',()=>run())])); root.appendChild(panel); root.appendChild(highCard('pin'));
  function genSeq(len){const bytes=new Uint8Array(len); crypto.getRandomValues(bytes); return Array.from(bytes,x=>x%10).join('')}
  function transform(mode,s){if(mode==='repeat')return s; if(mode==='reverse')return s.split('').reverse().join(''); return s.split('').sort().join('')}
  function run(){const ui=card(); root.appendChild(ui);
    ui.innerHTML='<div class="row" style="justify-content:space-between"><span class="pill">Zeit: <span id="t" class="timer"></span></span><span class="pill">Runde <b id="r">1</b> / 3</span><span class="pill">Punkte: <b id="sc">0</b></span></div><div class="question center" id="show" style="letter-spacing:6px;font-weight:700"></div><div class="row"><div style="flex:1"><label>Eingabe</label><div class="row"><input id="a" inputmode="numeric" pattern="[0-9]*" placeholder="Zahl & Enter"><button class="btn ghost" id="minus">‚àí</button></div></div><button class="btn" id="ok">OK</button><button class="btn ghost" id="pause">Pause</button><button class="btn danger" id="abort">Abbrechen</button></div><div class="muted" id="hint"></div>';
    const el={t:$("#t",ui),r:$("#r",ui),sc:$("#sc",ui),show:$("#show",ui),a:$("#a",ui),minus:$("#minus",ui),ok:$("#ok",ui),pause:$("#pause",ui),abort:$("#abort",ui),hint:$("#hint",ui)};
    const modes=['repeat','reverse','sort']; let round=0,score=0,per=[]; let paused=false,tStart=performance.now(),tPause=0,pauseAcc=0,running=true,roundEnd=0,cur=null,showT=0,len=3;
    function start(){round++; if(round>3){return finish()} el.r.textContent=String(round); tStart=performance.now(); pauseAcc=0; roundEnd=tStart+cfg.roundSecs*1000; el.hint.textContent='Modus: '+(modes[round-1]); next(); requestAnimationFrame(tick)}
    function tick(){let tNow=performance.now(); if(paused)tNow=tPause; const left=Math.max(0,roundEnd-(tNow-pauseAcc)); el.t.textContent=(left/1000).toFixed(1)+'s'; if(left<=0&&running){start();return} if(running) requestAnimationFrame(tick)}
    function next(){len=Math.min(12,3+Math.floor(score/3)); const seq=genSeq(len); cur={mode:modes[round-1],seq}; el.show.textContent=seq; el.a.value=''; el.a.blur(); showT=now(); setTimeout(()=>{ if(!running)return; el.show.textContent='‚Ä¢'.repeat(seq.length); el.a.focus() }, 1200+seq.length*80) }
    function submit(){const ms=Math.round(now()-showT); const need=transform(cur.mode,cur.seq); const user=el.a.value.trim(); const ok=(user===need); if(ok) score++; el.sc.textContent=score; per.push({round,mode:cur.mode,seq:cur.seq,need,user,ok,ms}); next()}
    function pause(){if(!paused){paused=true;tPause=performance.now();el.pause.textContent='Resume'} else {paused=false; pauseAcc+=performance.now()-tPause; el.pause.textContent='Pause'; requestAnimationFrame(tick)}}
    function abort(){ if(confirm('Ohne Speichern beenden?')){ running=false; ui.innerHTML='<div class="card">Abgebrochen ‚Äì nicht gespeichert.</div>' } }
    function finish(){running=false; const total=per.filter(x=>x.round<=3).length; const correct=per.filter(x=>x.ok).length; const ready=clamp(Math.round((correct/(cfg.target||30))*100),0,200); const avg=per.length?Math.round(per.reduce((a,x)=>a+x.ms,0)/per.length):0; pushSession({module:'pin',stats:{correct,total,avgMs:avg,score},perQuestion:per,settings:{...cfg}}); ui.innerHTML='<h3>Ergebnis</h3><div class="row"><span class="pill">Korrekt: <b class="ok">'+correct+'</b> / '+total+'</span><span class="pill">√ò Zeit: <b>'+fmtMs(avg)+'</b></span><span class="pill">Ready: <b>'+ready+'%</b></span></div>'; render()}
    el.ok.onclick=submit; el.minus.onclick=()=>{ if(!el.a.value.startsWith('-')) el.a.value='-'+el.a.value; el.a.focus() }; el.a.addEventListener('keydown',e=>{if(e.key==='Enter') submit()}); el.pause.onclick=pause; el.abort.onclick=abort; start();
  }
}

// ===== Market Making (Light)
function viewMM(root){
  root.appendChild(card('<h2>üìà Market Making</h2><div class="muted">Light-Modus (Random Walk). Spread/Bias steuerbar. Ziel: PnL-Rate pro 5 Minuten.</div>'));
  const cfg={seconds:300,base:1000,vol:.5,tick:200,spread:1.0,invPenalty:.02,targetRate:.02}; const panel=card(); panel.appendChild(formRow([numberField('Dauer (s)',60,900,10,cfg.seconds,v=>cfg.seconds=v),numberField('Startpreis',100,5000,10,cfg.base,v=>cfg.base=v,true),numberField('Volatilit√§t œÉ',0.1,2.0,0.05,cfg.vol,v=>cfg.vol=v,true),numberField('Tick (ms)',50,1000,10,cfg.tick,v=>cfg.tick=v),numberField('Spread',0.1,5,.1,cfg.spread,v=>cfg.spread=v,true),numberField('Inv-Penalty',0,0.1,.005,cfg.invPenalty,v=>cfg.invPenalty=v,true),numberField('Ziel PnL-Rate (pro 5min)',0,0.2,.005,cfg.targetRate,v=>cfg.targetRate=v,true),btn('Start',()=>run())])); root.appendChild(panel); root.appendChild(highCard('mm'));
  function run(){const ui=card(); root.appendChild(ui); ui.innerHTML='<div class="row" style="justify-content:space-between;align-items:center"><span class="pill">Zeit: <span id="time" class="timer"></span></span><span class="pill">Mid: <b id="mid">'+cfg.base.toFixed(2)+'</b></span><span class="pill">Inv: <b id="inv">0</b></span><span class="pill">Cash: <b id="cash">0.00</b></span><span class="pill">PnL: <b id="pnl">0.00</b></span></div><div class="row"><div><label>Spread</label><input id="spread" type="number" step="0.1" value="'+cfg.spread+'"></div><div><label>Bias</label><input id="bias" type="number" step="0.1" value="0"></div><button class="btn" id="wider">+ Spread</button><button class="btn" id="tighter">- Spread</button><button class="btn ghost" id="flat">Flat</button><button class="btn danger" id="abort">Abbrechen</button></div><div class="card center"><div class="question">Quotes</div><div style="font-size:26px"><span id="bid">‚Äî</span> | <span id="ask">‚Äî</span></div></div>'; const el={time:$("#time",ui),mid:$("#mid",ui),inv:$("#inv",ui),cash:$("#cash",ui),pnl:$("#pnl",ui),spread:$("#spread",ui),bias:$("#bias",ui),wider:$("#wider",ui),tighter:$("#tighter",ui),flat:$("#flat",ui),abort:$("#abort",ui),bid:$("#bid",ui),ask:$("#ask",ui)};
    const total=cfg.seconds*1000; let mid=cfg.base,cash=0,inv=0,t=0,running=true; const per=[]; el.wider.onclick=()=>el.spread.value=(+el.spread.value+0.2).toFixed(1); el.tighter.onclick=()=>el.spread.value=Math.max(0.1,+el.spread.value-0.2).toFixed(1); el.flat.onclick=()=>{cash+=inv*mid; per.push({event:'flat',price:mid}); inv=0}; el.abort.onclick=()=>{running=false; ui.innerHTML='<div class="card">Abgebrochen ‚Äì nicht gespeichert.</div>'}
    function step(){const dz=(Math.random()*2-1)*cfg.vol; mid=Math.max(0.01,mid*(1+dz/1000)); const spr=Math.max(0.05,+el.spread.value); const bias=+el.bias.value; const bid=mid - spr/2 - bias; const ask=mid + spr/2 - bias; el.bid.textContent=bid.toFixed(2); el.ask.textContent=ask.toFixed(2); const hitProb=Math.min(0.9,0.25 + 0.6*(1/(1+spr))); if(Math.random()<hitProb*0.5){cash+=ask; inv-=1; per.push({event:'sell',price:ask,mid,inv})} if(Math.random()<hitProb*0.5){cash-=bid; inv+=1; per.push({event:'buy',price:bid,mid,inv})} const pnl=cash+inv*mid-Math.abs(inv)*cfg.invPenalty; el.mid.textContent=mid.toFixed(2); el.inv.textContent=inv.toFixed(0); el.cash.textContent=cash.toFixed(2); el.pnl.textContent=pnl.toFixed(2)}
    let last=performance.now(); function loop(){const n=performance.now(); if(n-last>=cfg.tick&&running){step(); last=n; t+=cfg.tick; const left=Math.max(0,total-t); el.time.textContent=(left/1000).toFixed(1)+'s'; if(left<=0){running=false; finish(); return}} if(running) requestAnimationFrame(loop)}
    function finish(){const pnl=parseFloat(el.pnl.textContent); const stats={score:+pnl.toFixed(2),cash:+parseFloat(el.cash.textContent).toFixed(2),endMid:+parseFloat(el.mid.textContent).toFixed(2),inventory:+el.inv.textContent}; const target=cfg.base*cfg.targetRate*(cfg.seconds/300); const ready=clamp(Math.round((pnl/target)*100),0,200); pushSession({module:'mm',mode:'light',stats,perQuestion:per,settings:{...cfg}}); ui.insertAdjacentHTML('beforeend','<div class="card"><h3>Ergebnis</h3><div class="row"><span class="pill">PnL: <b class="'+(pnl>=0?'ok':'bad')+'">'+pnl.toFixed(2)+'</b></span><span class="pill">Ready: <b>'+ready+'%</b> (Ziel '+target.toFixed(2)+')</span></div></div>'); render()}
    loop();
  }
}

// ===== Brainteasers & Fermi (compact)
function viewBrain(root){
  root.appendChild(card('<h2>üß© Brainteasers & Fermi</h2><div class="muted">Einfacher Pool (kein Repeat). Brainteasers: freie Antwort; Fermi: Faktor-Check √ó10.</div>'));
  const cfg={mode:'brainteasers',n:6,secondsPer:120}; const panel=card(); panel.appendChild(formRow([selectField('Modus',[['brainteasers','Brainteasers'],['fermi','Fermi']],v=>cfg.mode=v,cfg.mode),numberField('Anzahl',1,30,1,cfg.n,v=>cfg.n=v),numberField('Zeit/Frage (s)',30,600,5,cfg.secondsPer,v=>cfg.secondsPer=v),btn('Start',()=>run())])); root.appendChild(panel); root.appendChild(highCard('brain'));
  const BT=[{id:'bt1',q:'Zwei Seile brennen je 60 Min ungleichm√§√üig. Miss 45 Min.',a:'A beidseitig, B einseitig; nach 30 Min A aus ‚Üí anderes Ende B an ‚Üí 15 Min.'},{id:'bt2',q:'Drei Schalter, eine Lampe (einmal betreten). Wie zuordnen?',a:'1 an, warten, aus; 2 an; rein: an=2, aus+warm=1, aus+kalt=3.'},{id:'bt3',q:'Wie viele 3-stellige Zahlen mit streng steigenden Ziffern?',a:'C(9,3)=84 (1‚Äì9).'}];
  function run(){ if(cfg.mode==='brainteasers') return runBT(); return runFermi(); }
  function runBT(){const ui=card(); root.appendChild(ui); let per=[],idx=0,t0=0; ui.innerHTML='<div class="row" style="justify-content:space-between"><span class="pill">Frage <b id="qc">1</b> / '+cfg.n+'</span><span class="pill">Timer: <span id="t" class="timer"></span></span></div><div class="question" id="q"></div><div class="row"><input id="a" placeholder="Kurz antw. & Enter" style="flex:1"><button class="btn" id="ok">Weiter</button><button class="btn ghost" id="abort">Abbrechen</button></div>'; const el={qc:$("#qc",ui),t:$("#t",ui),q:$("#q",ui),a:$("#a",ui),ok:$("#ok",ui),abort:$("#abort",ui)}; function pick(){const p=BT.filter(x=>!dedupHas('brain',x.id)); const item=(p.length?p[Math.floor(Math.random()*p.length)]:BT[Math.floor(Math.random()*BT.length)]); dedupAdd('brain',item.id); return item} let cur=null,end=0,running=true; function next(){if(idx>=cfg.n) return finish(); cur=pick(); el.q.textContent=cur.q; el.a.value=''; el.a.focus(); el.qc.textContent=String(idx+1); t0=now(); end=performance.now()+cfg.secondsPer*1000; requestAnimationFrame(tick)} function tick(){const left=Math.max(0,end-performance.now()); el.t.textContent=(left/1000).toFixed(1)+'s'; if(left>0&&running) requestAnimationFrame(tick)} function submit(){const ms=Math.round(now()-t0); const user=el.a.value.trim(); const ok=user.length>0; per.push({q:cur.q,a:cur.a,your:user,ok,ms}); idx++; next()} function abort(){ if(confirm('Ohne Speichern beenden?')){ running=false; ui.innerHTML='<div class="card">Abgebrochen ‚Äì nicht gespeichert.</div>' } } function finish(){running=false; const correct=per.filter(x=>x.ok).length; const avg=per.length?Math.round(per.reduce((a,x)=>a+x.ms,0)/per.length):0; pushSession({module:'brain',mode:'bt',stats:{correct,total:cfg.n,avgMs:avg,score:correct},perQuestion:per,settings:{...cfg}}); ui.innerHTML='<h3>Ergebnis</h3><div class="row"><span class="pill">Korrekt: <b class="ok">'+correct+'</b> / '+cfg.n+'</span><span class="pill">√ò Zeit: <b>'+fmtMs(avg)+'</b></span></div>'; render() } el.ok.onclick=submit; el.a.addEventListener('keydown',e=>{if(e.key==='Enter') submit()}); el.abort.onclick=abort; next(); }
  function runFermi(){const ui=card(); root.appendChild(ui); let per=[],idx=0,t0=0; ui.innerHTML='<div class="row" style="justify-content:space-between"><span class="pill">Frage <b id="qc">1</b> / '+cfg.n+'</span><span class="pill">Timer: <span id="t" class="timer"></span></span></div><div class="question" id="q"></div><div class="row"><input id="a" inputmode="decimal" placeholder="Sch√§tzung (Zahl)"><button class="btn" id="ok">Weiter</button><button class="btn ghost" id="abort">Abbrechen</button></div>'; const el={qc:$("#qc",ui),t:$("#t",ui),q:$("#q",ui),a:$("#a",ui),ok:$("#ok",ui),abort:$("#abort",ui)}; const topics=[{id:'cars',text:'Autos in einer mittelgro√üen Stadt',base:2e5,spread:4},{id:'sand',text:'K√∂rner auf einer Handvoll Sand',base:5e4,spread:10},{id:'cells',text:'Zellen im menschlichen K√∂rper',base:3.7e13,spread:3}]; function gen(){const t=topics[Math.floor(Math.random()*topics.length)]; const trueVal=Math.round(t.base*Math.pow(2,(Math.random()-.5)*t.spread)); return {id:t.id,q:'Sch√§tze: '+t.text,trueVal}} function sig(x){return 'fermi|'+x.id} let cur=null,end=0,running=true; function next(){if(idx>=cfg.n) return finish(); cur=dedupFind('fermi',gen,sig); el.q.textContent=cur.q; el.a.value=''; el.a.focus(); el.qc.textContent=String(idx+1); t0=now(); end=performance.now()+cfg.secondsPer*1000; requestAnimationFrame(tick)} function tick(){const left=Math.max(0,end-performance.now()); el.t.textContent=(left/1000).toFixed(1)+'s'; if(left>0&&running) requestAnimationFrame(tick)} function submit(){const ms=Math.round(now()-t0); const user=Number(el.a.value.replace(',','.')); const ratio=user>0?Math.max(user,cur.trueVal)/Math.max(1,Math.min(user,cur.trueVal)):Infinity; const ok=ratio<=10; per.push({q:cur.q,true:cur.trueVal,user,ok,factor:ratio.toFixed(2),ms}); idx++; next()} function abort(){ if(confirm('Ohne Speichern beenden?')){ running=false; ui.innerHTML='<div class="card">Abgebrochen ‚Äì nicht gespeichert.</div>' } } function finish(){running=false; const correct=per.filter(x=>x.ok).length; const avg=per.length?Math.round(per.reduce((a,x)=>a+x.ms,0)/per.length):0; pushSession({module:'brain',mode:'fermi',stats:{correct,total:cfg.n,avgMs:avg,score:correct},perQuestion:per,settings:{...cfg}}); ui.innerHTML='<h3>Ergebnis</h3><div class="row"><span class="pill">Korrekt: <b class="ok">'+correct+'</b> / '+cfg.n+'</span><span class="pill">√ò Zeit: <b>'+fmtMs(avg)+'</b></span></div>'; render()} el.ok.onclick=submit; el.a.addEventListener('keydown',e=>{if(e.key==='Enter') submit()}); el.abort.onclick=abort; next(); }
}

// ===== Statistik
function viewStats(root){
  root.appendChild(card('<h2>üìä Statistik</h2><div class="muted">Alle Sessions, √ò-Zeiten, Accuracy & Highscores. Klick auf Details f√ºr Einzelsession-Export.</div>'));
  const by={}; DB.sessions.forEach(s=>{(by[s.module]||(by[s.module]=[])).push(s)});
  for(const mod of Object.keys(by)){const arr=by[mod]; const avg=Math.round(arr.reduce((a,x)=>a+(x.stats?.avgMs||0),0)/(arr.length||1)); const acc=(arr.reduce((a,x)=>a+(x.stats?.correct||0),0))/(arr.reduce((a,x)=>a+(x.stats?.total||0),0))*100; const el=card('<h3>'+mod+'</h3><div class="row"><span class="pill">Sessions: <b>'+arr.length+'</b></span><span class="pill">√ò Zeit/Frage: <b>'+ (isFinite(avg)?fmtMs(avg):'‚Äî') +'</b></span><span class="pill">√ò Accuracy: <b>'+ (isFinite(acc)?acc.toFixed(1):'‚Äî') +'%</b></span><span class="pill">Highscore: <b>'+(DB.highscores[mod]?.score ?? '‚Äî')+'</b></span></div>'); const rows=arr.map((s,i)=>[i+1,new Date(s.date).toLocaleString(),(s.stats.correct||0)+'/'+(s.stats.total||0),(s.stats.avgMs/1000).toFixed(2)+'s',s.stats.score ?? '‚Äî','<span class="linklike" data-idx="'+i+'">Details</span>']); el.insertAdjacentHTML('beforeend',table(rows,['#','Datum','Richtig','√ò Zeit','Score','Session'])); root.appendChild(el) }
  // Details click
  $$('#app .linklike').forEach(sp=>{sp.addEventListener('click',()=>{const idx=parseInt(sp.getAttribute('data-idx')); const all=DB.sessions; const sess=all[idx]; const wrap=document.createElement('div'); wrap.className='card'; wrap.innerHTML='<h3>Session-Details</h3><div class="muted">'+(sess.module)+' ¬∑ '+new Date(sess.date).toLocaleString()+'</div>'; const per=sess.perQuestion||[]; let headers=[]; let rows=[]; if(per.length){ headers=Object.keys(per[0]); rows=per.map((x,i)=>[i+1].concat(headers.map(k=>x[k]))) } const csvRows=[['#'].concat(headers)]; rows.forEach(r=>csvRows.push(r)); const csv=csvRows.map(r=>r.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n'); const txt=per.map((x,i)=>(i+1)+'. '+JSON.stringify(x)).join('\n'); wrap.insertAdjacentHTML('beforeend','<div class="row"><button class="btn" id="dlCsv">Export dieser Session (CSV)</button><button class="btn ghost" id="dlTxt">Export dieser Session (TXT)</button></div>'+table(rows,['#'].concat(headers))); const ui=showFocus(wrap); wrap.querySelector('#dlCsv').onclick=()=>dl('session_'+sess.module+'_'+new Date(sess.date).toISOString().replace(/[:.]/g,'-')+'.csv',csv,'text/csv'); wrap.querySelector('#dlTxt').onclick=()=>dl('session_'+sess.module+'_'+new Date(sess.date).toISOString().replace(/[:.]/g,'-')+'.txt',txt,'text/plain'); }) })
}

// ===== Settings
function viewSettings(root){
  root.appendChild(card('<h2>‚öôÔ∏è Einstellungen</h2><div class="muted">Dedup-Pools leeren.</div>'));
  const panel=card(); const mods=['mental','seq','task','pin','mm','brain','fermi','marketQ']; panel.appendChild(formRow(mods.map(id=>btn("Reset '"+id+"'",()=>{ delete DEDUP[id]; saveDedup(); alert('Pool '+id+' geleert.') })))); root.appendChild(panel);
}
</script>
</main></body></html>
