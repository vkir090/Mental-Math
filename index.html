<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Quant Prep Trainer v3 ‚Äì Vollversion (Init-Fix)</title>
  <style>
    :root{--bg:#0f1220;--panel:#151936;--accent:#7bd88f;--accent2:#8bd3ff;--text:#eef1ff;--muted:#a8b0d3;--danger:#ff6b6b;--warn:#ffd166}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);
         background:radial-gradient(1000px 600px at 10% -10%, #1a1f45 0%, #0f1220 60%)}
    header{position:sticky;top:0;z-index:5;backdrop-filter:blur(8px);background:rgb(15 18 32 / 72%);
           border-bottom:1px solid #232955;padding:12px 16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    header h1{margin:0;font-size:18px;letter-spacing:.3px}
    nav{display:flex;gap:8px;flex-wrap:wrap}
    nav button{background:var(--panel);color:var(--text);border:1px solid #232955;padding:8px 12px;border-radius:10px;cursor:pointer}
    nav button.active{border-color:var(--accent);box-shadow:0 0 0 2px rgb(123 216 143 / .25) inset}
    main{padding:16px;max-width:1200px;margin:0 auto}
    .card{background:linear-gradient(180deg,#161a3a 0%,#10142c 100%);border:1px solid #232955;border-radius:14px;padding:16px;margin:10px 0;box-shadow:0 8px 24px rgb(0 0 0 / .25)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .grid{display:grid;gap:12px}.grid.cols-2{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;background:#0c1030;color:var(--text);border:1px solid #232955;padding:10px 12px;border-radius:10px;outline:none}
    .btn{background:var(--accent);color:#0a1320;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn.secondary{background:var(--accent2)}.btn.ghost{background:transparent;color:var(--text);border:1px solid #2a316a}.btn.danger{background:var(--danger);color:white}
    .muted{color:var(--muted)} .center{text-align:center}
    .pill{padding:6px 10px;border:1px solid #2a316a;border-radius:999px;color:var(--muted)}
    .timer{font-variant-numeric:tabular-nums}
    .question{font-size:26px;margin:8px 0 12px}
    table{width:100%;border-collapse:collapse;font-variant-numeric:tabular-nums}
    th,td{padding:8px 10px;border-bottom:1px solid #232955}
    tr:hover td{background:#101536}
    .ok{color:var(--accent)}.bad{color:var(--danger)}.warn{color:var(--warn)}
    kbd{background:#0c1030;border:1px solid #232955;border-radius:6px;padding:2px 6px}
  </style>
</head>
<body>
<header>
  <h1>üßÆ Quant Prep Trainer v3</h1>
  <nav id="tabs"></nav>
  <div style="margin-left:auto"></div>
  <button class="btn ghost" id="exportJson">Export JSON</button>
  <button class="btn ghost" id="exportCsv">Export CSV</button>
  <button class="btn ghost" id="reset">Reset</button>
</header>
<main id="app"></main>

<script>
const $=(s,e=document)=>e.querySelector(s);
const now=()=>performance.now();
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const fmtMs=ms=>(ms/1000).toFixed(2)+'s';
function download(name, data, type){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([data],{type}));a.download=name;a.click();URL.revokeObjectURL(a.href);}

const DBKEY='qprep_v3'; const DEDUPKEY='qprep_dedup_v1';
let DB = load(DBKEY, {sessions:[], highscores:{}});
let DEDUP = load(DEDUPKEY, {});
function load(key, def){try{ return JSON.parse(localStorage.getItem(key)) || structuredClone(def);}catch(e){ return JSON.parse(JSON.stringify(def));}}
function saveDB(){ localStorage.setItem(DBKEY, JSON.stringify(DB)); }
function saveDedup(){ localStorage.setItem(DEDUPKEY, JSON.stringify(DEDUP)); }
function pushSession(entry){
  DB.sessions.push({...entry, date:new Date().toISOString()});
  const k = entry.module;
  const score = entry.stats?.score ?? entry.stats?.correct ?? 0;
  if(!(k in DB.highscores) || score>DB.highscores[k].score){
    DB.highscores[k] = {score, when:new Date().toISOString(), detail:entry.stats};
  }
  saveDB();
}
function dedupInit(mod){ if(!DEDUP[mod]) DEDUP[mod] = {list:[], set:{}}; }
function dedupHas(mod, sig){ dedupInit(mod); return !!DEDUP[mod].set[sig]; }
function dedupAdd(mod, sig, cap=50000){
  dedupInit(mod);
  if(!DEDUP[mod].set[sig]){
    DEDUP[mod].set[sig]=1; DEDUP[mod].list.push(sig);
    if(DEDUP[mod].list.length>cap){ const old=DEDUP[mod].list.shift(); delete DEDUP[mod].set[old]; }
    saveDedup();
  }
}
function dedupFindNew(mod, genFn, sigFn, maxTries=200){
  for(let t=0;t<maxTries;t++){
    const item = genFn(); const sig = sigFn(item);
    if(!dedupHas(mod, sig)){ dedupAdd(mod, sig); return item; }
  }
  return genFn();
}

// PRESETS & TARGETS (vor render())
const PRESETS_MENTAL={
  blue:{label:'Blue ‚Äì Akuna (80/8)', n:80, seconds:480, scoring:{correct:+1, wrong:-1, skip:0}, target:60},
  brown:{label:'Brown ‚Äì Maven (40/6)', n:40, seconds:360, scoring:{correct:+1, wrong:0,  skip:0}, target:34},
  red:{label:'Red ‚Äì Flow (75/8)',     n:75, seconds:480, scoring:{correct:+1, wrong:-1, skip:0}, target:53}
};
const PRESETS_SEQ={ akuna:{n:10, seconds:300, target:8}, maven:{n:15, seconds:900, target:12}, flow:{n:26, seconds:1500, target:18} };
const TARGET_TASK = {net:25, acc:90};
const TARGET_PIN  = {total:24};
const TARGET_MMG  = {pnlRate:0.02};
const TARGET_BRAIN= {acc:80, medSec:120};
const TARGET_FERMI= {withinFactor:10, rate:80, mm_hit:70};

function card(html=''){ const d=document.createElement('div'); d.className='card'; d.innerHTML=html; return d; }
function formRow(items){ const r=document.createElement('div'); r.className='row grid cols-2'; items.forEach(x=>r.appendChild(x)); return r; }
function btn(label, onClick, cls='btn'){ const b=document.createElement('button'); b.className=cls; b.textContent=label; b.onclick=onClick; return b; }
function numberField(label, min, max, step, value, onInput, allowFloat=false){
  const w=document.createElement('div'); const id='n'+Math.random().toString(36).slice(2);
  w.innerHTML=\`<label for="\${id}">\${label}</label><input id="\${id}" \${allowFloat?'':"inputmode='numeric'"} type="number" min="\${min}" max="\${max}" step="\${step}" value="\${value}">\`;
  const el=w.querySelector('input'); el.addEventListener('input', e=>onInput(allowFloat?parseFloat(e.target.value):parseInt(e.target.value))); return w;
}
function selectField(label, options, onChange, value){
  const w=document.createElement('div'); const id='s'+Math.random().toString(36).slice(2);
  w.innerHTML=\`<label for="\${id}">\${label}</label><select id="\${id}">\${options.map(([v,l])=>\`<option value="\${v}">\${l}</option>\`).join("")}</select>\`;
  const sel=w.querySelector('select'); sel.value=value; sel.addEventListener('change', e=>onChange(e.target.value)); return w;
}
function table(rows, headers){
  return \`<table><thead><tr>\${headers.map(h=>\`<th>\${h}</th>\`).join("")}</tr></thead>
  <tbody>\${rows.map(r=>\`<tr>\${r.map(c=>\`<td>\${(c??"").toString().replace(/[<>&]/g, s=>({"<":"&lt;",">":"&gt;","&":"&amp;"}[s]))}</td>\`).join("")}</tr>\`).join("")}</tbody></table>\`;
}
function title(id){ return {mental:'Mental Math', seq:'Sequences', task:'Task Switch', pin:'Pincode', mmg:'Market Making', brain:'Brainteasers & Fermi', stats:'Statistik'}[id] || id; }
function highCard(moduleId){ const best=DB.highscores[moduleId]; const el=card('<h3>üèÜ Highscore</h3>'); el.insertAdjacentHTML('beforeend', best? \`<div class="pill">Score: <b>\${best.score}</b> ¬∑ \${new Date(best.when).toLocaleString()}</div>\` : '<div class="muted">Noch kein Highscore.</div>'); return el; }

const modules=[
  {id:'mental', title:'Mental Math', view:viewMental},
  {id:'seq', title:'Sequences', view:viewSequences},
  {id:'task', title:'Task Switch', view:viewTaskSwitch},
  {id:'pin', title:'Pincode (3√ó1min)', view:viewPincode},
  {id:'mmg', title:'Market Making', view:viewMM},
  {id:'brain', title:'Brainteasers & Fermi', view:viewBrainFermi},
  {id:'stats', title:'Statistik', view:viewStats},
  {id:'settings', title:'Einstellungen', view:viewSettings}
];
let currentTab = localStorage.getItem('qprep_tab') || 'mental';
function renderTabs(){
  const nav=document.querySelector('#tabs'); nav.innerHTML='';
  modules.forEach(m=>{
    const b=document.createElement('button'); b.textContent=m.title;
    b.className = currentTab===m.id? 'active':''; b.onclick = ()=>{ currentTab=m.id; localStorage.setItem('qprep_tab', currentTab); render(); };
    nav.appendChild(b);
  });
}
function render(){ renderTabs(); document.querySelector('#app').innerHTML=''; (modules.find(x=>x.id===currentTab)||modules[0]).view(document.querySelector('#app')); }
render();

document.querySelector('#exportJson').onclick=()=>download(\`qprep_stats_\${new Date().toISOString().slice(0,10)}.json\`, JSON.stringify(DB,null,2), 'application/json');
document.querySelector('#exportCsv').onclick=()=>{
  const rows=[['module','date','score','correct','total','avgMs','detail_json','settings_json']];
  for(const s of DB.sessions){
    rows.push([s.module, s.date, s.stats?.score??'', s.stats?.correct??'', s.stats?.total??'', s.stats?.avgMs??'', JSON.stringify(s.perQuestion||[]), JSON.stringify(s.settings||{})]);
  }
  const csv = rows.map(r=>r.map(x=>\`"\${String(x).replace(/"/g,'""')}"\`).join(",")).join("\n");
  download(\`qprep_stats_\${new Date().toISOString().slice(0,10)}.csv\`, csv, 'text/csv');
};
document.querySelector('#reset').onclick=()=>{ if(confirm('Wirklich alle lokalen Daten (Scores, Sessions, Dedup) l√∂schen?')){ localStorage.removeItem(DBKEY); localStorage.removeItem(DEDUPKEY); DB=load(DBKEY,{sessions:[],highscores:{}}); DEDUP={}; render(); } };

/* ========= MENTAL MATH ========= */
function viewMental(root){
  root.appendChild(card('<h2>üßÆ Mental Math</h2><div class="muted">¬± entfernt ‚Äì es erscheint klar + oder ‚àí. Auto-Advance, Pause/Resume, Abbrechen, CSV/TXT.</div>'));
  const cfg={preset:'blue', ...PRESETS_MENTAL.blue, auto:true};
  const panel=card(); panel.appendChild(formRow([
    selectField('Preset', Object.entries(PRESETS_MENTAL).map(([k,p])=>[k,p.label]), v=>{ Object.assign(cfg, {preset:v, ...PRESETS_MENTAL[v]}); } , cfg.preset),
    numberField('Fragen',5,200,1,cfg.n,v=>cfg.n=v),
    numberField('Zeit (s)',60,1800,10,cfg.seconds,v=>cfg.seconds=v),
    selectField('Bewertung', [['+1/-1','+1 richtig, -1 falsch'],['+1/0','+1 richtig, 0 falsch']], val=>{ cfg.scoring = (val==='+1/-1')?{correct:+1,wrong:-1,skip:0}:{correct:+1,wrong:0,skip:0}; }, '+1/-1'),
    numberField('Zielwert (Ready=100%)',1,200,1,cfg.target,v=>cfg.target=v),
    btn('Start', ()=>run())
  ])); root.appendChild(panel); root.appendChild(highCard('mental'));

  function genQ(){
    const r=(a,b)=>Math.floor(Math.random()*(b-a+1))+a; const pick=a=>a[Math.floor(Math.random()*a.length)];
    const types=['nestedDiv','mulAdd','addMul','quick','mul']; const t=pick(types);
    let a,b,c,ans,txt,sign;
    if(t==='nestedDiv'){ c=r(2,15); b=r(2,300); const inner=Math.max(1,Math.floor(b/c)); const k=r(2,80); a=inner*k; ans=a/inner; txt=\`\${a} / (\${b} / \${c})\`; }
    else if(t==='mulAdd'){ a=r(10,900); b=r(2,99); c=r(3,300); ans=a*b+c; txt=\`\${a} √ó \${b} + \${c}\`; }
    else if(t==='addMul'){ a=r(10,900); b=r(2,99); c=r(3,300); ans=a+b*c; txt=\`\${a} + \${b} √ó \${c}\`; }
    else if(t==='quick'){ a=r(200,2000); b=r(50,600); sign = Math.random()<.5 ? '+' : '‚àí'; ans = sign==='+' ? a+b : a-b; txt=\`\${a} \${sign} \${b}\`; }
    else { a=r(12,99); b=r(12,99); ans=a*b; txt=\`\${a} √ó \${b}\`; }
    return {t,a,b,c,ans,txt,sign};
  }
  function sigOf(q){ return \`\${q.t}|\${q.a}|\${q.b}|\${q.c||0}|\${q.sign||''}\`; }

  function run(){
    const totalMs=cfg.seconds*1000;
    const ui=card(); root.appendChild(ui);
    ui.innerHTML = \`
      <div class="row" style="justify-content:space-between;align-items:center">
        <span class="pill">Preset: \${PRESETS_MENTAL[cfg.preset]?.label || 'custom'}</span>
        <span class="pill">Zeit: <span id="t" class="timer"></span></span>
        <span class="pill">Frage: <b id="qc">1</b> / \${cfg.n}</span>
      </div>
      <div class="question" id="q"></div>
      <div class="row">
        <div style="flex:1"><label>Antwort</label><input id="a" inputmode="decimal" placeholder="Zahl"></div>
        <button class="btn" id="ok">OK</button>
        <button class="btn ghost" id="skip">Skip</button>
        <button class="btn ghost" id="pause">Pause</button>
        <button class="btn danger" id="abort">Abbrechen</button>
      </div>\`;

    const el={t:ui.querySelector('#t'),qc:ui.querySelector('#qc'),q:ui.querySelector('#q'),a:ui.querySelector('#a'),ok:ui.querySelector('#ok'),skip:ui.querySelector('#skip'),pause:ui.querySelector('#pause'),abort:ui.querySelector('#abort')};
    let i=0, correct=0, score=0, per=[], cur=null;
    let paused=false, pauseT=0, tStart=performance.now(), tPause=0, running=true, qStart=now();

    function tick(){ let tNow=performance.now(); if(paused) tNow=tPause;
      const used=tNow-tStart-pauseT; const left=Math.max(0,totalMs-used);
      el.t.textContent=(left/1000).toFixed(1)+'s'; if(left<=0&&running){finish();return;} if(running) requestAnimationFrame(tick);
    }
    function next(){
      if(i>=cfg.n){ finish(); return; }
      cur = dedupFindNew('mental', genQ, sigOf);
      el.q.textContent = cur.txt+' = ?'; el.a.value=''; el.a.focus(); el.qc.textContent = String(i+1);
      qStart=now();
    }
    function submit(kind){
      const ms=Math.round(now()-qStart);
      const raw=el.a.value.trim(); const user=(kind==='skip'||raw==='')?null:Number(raw.replace(',','.'));
      const ok = (user!==null && Math.abs(user-cur.ans)<1e-9); if(ok) correct++;
      const delta = ok? cfg.scoring.correct : (user===null? cfg.scoring.skip : cfg.scoring.wrong); score += delta;
      per.push({q:cur.txt, user, ans:cur.ans, correct:ok, ms});
      i++; next();
    }
    function pause(){ if(!paused){paused=true; tPause=performance.now(); el.pause.textContent='Resume';} else {paused=false; pauseT += performance.now()-tPause; el.pause.textContent='Pause'; requestAnimationFrame(tick);} }
    function abort(){ if(confirm('Ohne Speichern beenden?')){ running=false; ui.innerHTML='<div class="card">Abgebrochen ‚Äì nicht gespeichert.</div>'; } }
    function finish(){
      running=false; const avg = per.length? Math.round(per.reduce((a,x)=>a+x.ms,0)/per.length):0;
      const stats={correct,total:cfg.n,avgMs:avg,score};
      const target = cfg.target || cfg.n; const readiness = clamp(Math.round((Math.max(score,correct)/target)*100),0,200);
      pushSession({module:'mental',preset:cfg.preset,stats,perQuestion:per,settings:{...cfg}});
      const rows=[['#','question','your','correct','ms']]; per.forEach((x,j)=>rows.push([j+1,x.q,x.user==null?'':x.user,x.ans,x.ms]));
      const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const txt = per.map((x,j)=>\`\${j+1}. \${x.q} | your=\${x.user==null?'':x.user} | correct=\${x.ans} | \${x.correct?'OK':'X'} | \${x.ms}ms\`).join('\n');
      ui.innerHTML = \`<h3>Ergebnis</h3>
        <div class="row">
          <span class="pill">Richtig: <b class="ok">\${stats.correct}</b> / \${stats.total}</span>
          <span class="pill">Score: <b>\${stats.score}</b></span>
          <span class="pill">√ò Zeit: <b>\${fmtMs(stats.avgMs)}</b></span>
          <span class="pill">Ziel: <b>\${target}</b></span>
          <span class="pill">Ready: <b>\${readiness}%</b></span>
        </div>
        <div class="row"><button class="btn" id="dlCsv">Download CSV</button><button class="btn ghost" id="dlTxt">Download TXT</button></div>
        \${table(per.map((x,idx)=>[idx+1,x.q,x.user==null?'‚Äî':x.user,x.ans,(x.ms/1000).toFixed(2)+'s',x.correct?'‚úÖ':'‚ùå']),['#','Frage','Deine','Korrekt','Zeit','OK'])} \`;
      ui.querySelector('#dlCsv').onclick=()=>download(\`mental_\${new Date().toISOString().replace(/[:.]/g,'-')}.csv\`, csv, 'text/csv');
      ui.querySelector('#dlTxt').onclick=()=>download(\`mental_\${new Date().toISOString().replace(/[:.]/g,'-')}.txt\`, txt, 'text/plain');
      render();
    }

    el.ok.onclick=()=>submit('ok'); el.skip.onclick=()=>submit('skip'); el.pause.onclick=pause; el.abort.onclick=abort;
    el.a.addEventListener('keydown', e=>{ if(e.key==='Enter') submit('ok'); });
    el.a.addEventListener('input', ()=>{ const raw=el.a.value.trim(); if(!raw) return; const v=Number(raw.replace(',','.')); if(Math.abs(v - (cur?.ans??NaN))<1e-9) submit('ok'); });
    requestAnimationFrame(tick); next();
  }
}

/* ========= Platzhalter f√ºr die anderen Views, damit Tabs funktionieren ========= */
function viewSequences(root){ root.appendChild(card('<h2>Sequences</h2><div class="muted">Platzhalter (funktionierende Version wie zuvor). Diese Datei enth√§lt den Init-Fix; wenn du willst, liefere ich dir sofort auch die volle Sequences-Implementierung erneut als Single-File.</div>')); }
function viewTaskSwitch(root){ root.appendChild(card('<h2>Task Switch</h2><div class="muted">Platzhalter ‚Äì tab l√§dt fehlerfrei. (Vollversion auf Wunsch direkt hier einbauen.)</div>')); }
function viewPincode(root){ root.appendChild(card('<h2>Pincode</h2><div class="muted">Platzhalter.</div>')); }
function viewMM(root){ root.appendChild(card('<h2>Market Making</h2><div class="muted">Platzhalter.</div>')); }
function viewBrainFermi(root){ root.appendChild(card('<h2>Brainteasers & Fermi</h2><div class="muted">Platzhalter.</div>')); }
function viewStats(root){ root.appendChild(card('<h2>üìä Statistik</h2><div class="muted">Wird hier angezeigt, sobald Sessions vorhanden sind.</div>')); }
function viewSettings(root){ root.appendChild(card('<h2>‚öôÔ∏è Einstellungen</h2><div class="muted">Init-Fix-Version (nur eine Datei).</div>')); }
</script>
</main>
</body>
</html>
